<!DOCTYPE html>
<html lang="en-gb" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="When I build infrastructure in Azure, I use terraform. I can&rsquo;t force myself to use ARM templates, and I&rsquo;m not yet convinced to use bicep. Terraform has flaws and problems, and HCL is not that intuitive initially, but after banging my head against the wall, we became friends. Yet, some time ago, when I saw Pulumi on DevOpsLab - I knew I would have to try it. Using C# to create infrastructure was something I wanted to do a while ago with Farmer and F#.">
<title>Build your SQL Server VM using CdkTf</title>

<link rel='canonical' href='https://blog.bartekr.net/2022/10/31/build-your-sql-server-vm-using-cdktf/'>

<link rel="stylesheet" href="/scss/style.min.b9c8156d464c343bdacaf14a871581fb94cbbdb9dd5cbce4ba017361187cc930.css"><meta property='og:title' content="Build your SQL Server VM using CdkTf">
<meta property='og:description' content="When I build infrastructure in Azure, I use terraform. I can&rsquo;t force myself to use ARM templates, and I&rsquo;m not yet convinced to use bicep. Terraform has flaws and problems, and HCL is not that intuitive initially, but after banging my head against the wall, we became friends. Yet, some time ago, when I saw Pulumi on DevOpsLab - I knew I would have to try it. Using C# to create infrastructure was something I wanted to do a while ago with Farmer and F#.">
<meta property='og:url' content='https://blog.bartekr.net/2022/10/31/build-your-sql-server-vm-using-cdktf/'>
<meta property='og:site_name' content='BartekR'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='vm' /><meta property='article:tag' content='terraform' /><meta property='article:tag' content='cdktf' /><meta property='article:published_time' content='2022-10-31T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2022-10-31T00:00:00&#43;00:00'/><meta property='og:image' content='https://blog.bartekr.net/2022/10/31/build-your-sql-server-vm-using-cdktf/images/cdktf.help.png' />
<meta name="twitter:title" content="Build your SQL Server VM using CdkTf">
<meta name="twitter:description" content="When I build infrastructure in Azure, I use terraform. I can&rsquo;t force myself to use ARM templates, and I&rsquo;m not yet convinced to use bicep. Terraform has flaws and problems, and HCL is not that intuitive initially, but after banging my head against the wall, we became friends. Yet, some time ago, when I saw Pulumi on DevOpsLab - I knew I would have to try it. Using C# to create infrastructure was something I wanted to do a while ago with Farmer and F#."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://blog.bartekr.net/2022/10/31/build-your-sql-server-vm-using-cdktf/images/cdktf.help.png' />
    <link rel="shortcut icon" href="/favicon.ico" />

  

<style>
     
    :root {
         
        --base-font-family: "Roboto", "Lato", var(--sys-font-family), var(--zh-font-family), sans-serif;
    }
</style>

<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap";
    
        customFont.type = "text/css";
        customFont.rel = "stylesheet";
    
        document.head.appendChild(customFont);
    }());
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/Bartek_SqlSatOslo2019_100x100_huc95037055e21b687f52ff80813407d9d_14060_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">BartekR</a></h1>
            <p class="site-description">Azure. PowerShell. SQL. DevOps.<br />1 wife. 1 kid. 4 dogs. 5 cats.</p>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/BartekR'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/b_ratajczyk'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about' >
                
                
                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='https://brinf.wordpress.com' >
                
                
                
                <span>Old blog [PL]</span>
            </a>
        </li>
        
        
        <li >
            <a href='/series' >
                
                
                
                <span>Series</span>
            </a>
        </li>
        
        
        <li >
            <a href='/containers-land' >
                
                
                
                <span>Containers Land</span>
            </a>
        </li>
        
        
        <li >
            <a href='/books' >
                
                
                
                <span>Books</span>
            </a>
        </li>
        
        
        <li >
            <a href='/speaking' >
                
                
                
                <span>Speaking</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories' >
                
                
                
                <span>Categories</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags' >
                
                
                
                <span>Tags</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search' >
                
                
                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#of-roses-and-thorns">Of roses and thorns</a></li>
    <li><a href="#preparing-the-environment">Preparing the environment</a></li>
    <li><a href="#preparing-the-code">Preparing the code</a></li>
    <li><a href="#starting-slowly">Starting slowly</a></li>
    <li><a href="#taking-a-bit-more-speed">Taking a bit more speed</a></li>
    <li><a href="#i-have-the-code-what-next">I have the code. What next?</a></li>
    <li><a href="#last-annoyance">Last annoyance</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/2022/10/31/build-your-sql-server-vm-using-cdktf/">
                
                    <img src="/2022/10/31/build-your-sql-server-vm-using-cdktf/images/cdktf.help.png" loading="lazy" alt="Featured image of post Build your SQL Server VM using CdkTf" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/azure/" >
                Azure
            </a>
        
            <a href="/categories/iac/" >
                IaC
            </a>
        
            <a href="/categories/sql-server/" >
                SQL Server
            </a>
        
            <a href="/categories/learning/" >
                Learning
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/2022/10/31/build-your-sql-server-vm-using-cdktf/">Build your SQL Server VM using CdkTf</a>
        </h2>
    
        

        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Oct 31, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    8 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>When I build infrastructure in Azure, I use <code>terraform</code>. I can&rsquo;t force myself to use ARM templates, and I&rsquo;m not yet convinced to use <code>bicep</code>. Terraform has flaws and problems, and HCL is not that intuitive initially, but after banging my head against the wall, we became friends.</p>
<p>Yet, some time ago, when I saw <a class="link" href="https://www.youtube.com/watch?v=TQ71GI6abKg"  target="_blank" rel="noopener"
    >Pulumi on DevOpsLab</a> - I knew I would have to try it. Using C# to create infrastructure was something I wanted to do a while ago with Farmer and F#. And while it still is something I want to try, HashiCorp announced CDKTF - Cloud Development Kit for TerraForm. Now I can still use terraform, but write code in C# instead of HCL!</p>
<p>But - as with love at first sight - the best cure is to look again. And while we are still mates with terraform, CDKTF looks like his annoying younger brother.</p>
<h2 id="of-roses-and-thorns">Of roses and thorns
</h2><p>To try CDKTF, I set myself a goal: <strong>I want a virtual machine in Azure. With SQL Server on Windows, so I can work with SSIS</strong>. Sounds easy enough, but it takes time to prepare the code, as we need to use multiple Azure elements. The conclusions after building such VM:</p>
<ul>
<li>
<p>CDKTF lacks Azure documentation and samples for C# - the main focus is on AWS and TypeScript</p>
</li>
<li>
<p>CDKTF prepares skeleton code that uses .NET 3.1</p>
</li>
<li>
<p>every Azure resource has its own namespace</p>
</li>
<li>
<p>you have to use names for identifiers and names inside the configuration (and variables, if required) - which looks redundant; an example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="n">VirtualNetwork</span> <span class="n">n</span> <span class="p">=</span> <span class="k">new</span> <span class="n">VirtualNetwork</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">&#34;vnet&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">VirtualNetworkConfig</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Location</span> <span class="p">=</span> <span class="n">rg</span><span class="p">.</span><span class="n">Location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="n">rg</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddressSpace</span> <span class="p">=</span> <span class="k">new</span> <span class="p">[]{</span><span class="s">&#34;10.2.0.0/16&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;vm-ssis-vnet&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span></code></pre></div></li>
<li>
<p>terraform&rsquo;s documentation is extensive but lacks additional examples</p>
</li>
<li>
<p>the disks setup for SQL Server VM does not have enough parameters for <em>tempdb</em></p>
</li>
</ul>
<h2 id="preparing-the-environment">Preparing the environment
</h2><p>CDKTF allows writing infrastructure setup using TypeScript, Python, C#, Java, and Go. I will use C# for this example, but no matter which language you choose, you need to install <code>Node.js</code> 16+, <code>npm</code>, and <code>terraform</code> CLI version 1.1+.</p>
<p>If you already have some Node.js and terraform CLI versions installed, you can check them using the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">node</span> <span class="p">-</span><span class="n">-version</span>
</span></span><span class="line"><span class="cl"><span class="n">terraform</span> <span class="p">-</span><span class="n">-version</span>
</span></span></code></pre></div><p>Upgrade software when needed (I use Windows, so I downloaded Node.js installer and terraform binary), and then - install CDKTF typing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">npm</span> <span class="n">install</span> <span class="p">-</span><span class="n">-global</span> <span class="nb">cdktf-cli</span><span class="nv">@latest</span> <span class="c"># install cdktf</span>
</span></span><span class="line"><span class="cl"><span class="n">cdktf</span> <span class="p">-</span><span class="n">-version</span> <span class="c"># check that it&#39;s installed</span>
</span></span></code></pre></div><p>Done. Now to</p>
<h2 id="preparing-the-code">Preparing the code
</h2><p>I want to build VM with SQL Server, so I created a dedicated folder <code>vm-ssis</code>, and initiated the scaffolding for the project with <code>cdktf init</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="n">mkdir</span> <span class="nb">vm-ssis</span>
</span></span><span class="line"><span class="cl"><span class="nb">cd vm-ssis</span>
</span></span><span class="line"><span class="cl"><span class="n">cdktf</span> <span class="n">init</span> <span class="p">-</span><span class="n">-template</span><span class="p">=</span><span class="n">csharp</span> <span class="p">-</span><span class="n">-local</span>
</span></span></code></pre></div><p>After running the above, it forces me to provide the project name, description, and whether to send crash telemetry. <code>--template</code> is for specifying the target language to generate project structure, and <code>--local</code> means that terraform will store state locally.</p>
<p>As a result, there is a dotnet project containing:</p>
<ul>
<li><code>Program.cs</code>, <code>MainStack.cs</code>, <code>MyTerraformStack.csproj</code>, <code>TestProgram.cs</code>, <code>.gitignore</code>, <code>cdktf.json</code> and <code>help</code> files</li>
<li><code>netcoreapp3.1</code> as the target framework version (while versions 6 and 7 are available)</li>
<li>package references
<ul>
<li><code>HashiCorp.Cdktf</code> 0.13.0</li>
<li><code>Microsoft.NET.Test.Sdk</code> 17.2.0</li>
<li><code>xunit</code> 2.4.1</li>
<li><code>xunit.runner.visualstudio</code> 2.4.5</li>
</ul>
</li>
</ul>
<p>Nice to see that by default there is a suggestion for writing tests, and one of the existing test frameworks is used instead of creating a separate one.</p>
<h2 id="starting-slowly">Starting slowly
</h2><p>I&rsquo;m just learning how to use CDKTF and want a simple Virtual Machine. Hence I will touch on neither the modularisation topic nor splitting the code between separate files. I will also not describe the complete source code (available at <a class="link" href="https://github.com/BartekR/blog/tree/master/202210%20Cdktf"  target="_blank" rel="noopener"
    >https://github.com/BartekR/blog/tree/master/202210%20Cdktf</a>) - I will focus on the most important (for me) aspects.</p>
<p>The file <code>MainStack.cs</code> has a placeholder that gives me a hint about where I should place the code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">Constructs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">MyCompany.MyApp</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">class</span> <span class="nc">MainStack</span> <span class="p">:</span> <span class="n">TerraformStack</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">public</span> <span class="n">MainStack</span><span class="p">(</span><span class="n">Construct</span> <span class="n">scope</span><span class="p">,</span> <span class="kt">string</span> <span class="n">id</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// define resources here</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>I don&rsquo;t care about the namespace in this case, so I keep it as it is. Before I define the resources, I need to inform my project that I want to build the infrastructure in Azure. For that, I use the following command, suggested by CDKTF setup: <code>dotnet add package HashiCorp.Cdktf.Providers.Azurerm</code>. As a result, it adds <code>HashiCorp.Cdktf.Providers.Azurerm</code> version 3.0.12 to the package references. Now I can use Azure resources definitions and AzureRm config:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">MainStack</span><span class="p">(</span><span class="n">Construct</span> <span class="n">scope</span><span class="p">,</span> <span class="kt">string</span> <span class="n">id</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// define resources here</span>
</span></span><span class="line"><span class="cl">    <span class="k">new</span> <span class="n">AzurermProvider</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">&#34;azurerm&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">AzurermProviderConfig</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Features</span> <span class="p">=</span> <span class="k">new</span> <span class="n">AzurermProviderFeatures</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Before I create the code for SQL Server VM, I need to familiarize myself with the process in Azure Portal. I prepared a new VM resource and reviewed the existing requirements.</p>
<p>
  
  <p style="text-align: center;">
    <img src="./images/AzurePortal.VM.Create.png"
	
	
	
	loading="lazy"
	
		alt="Azure VM creation steps"
	
	
>
  </p>

</p>
<p>Some things to note for future reference:</p>
<ul>
<li>Basics
<ul>
<li>I create VM without infrastructure redundancy (no VMSS, availability   zones, and availability sets)</li>
<li>Standard security type</li>
<li>Image is <em>Free SQL Server License: SQL 2019 Developer on Windows Server   2019</em> (open <em>See all images</em> to select it)</li>
<li>size is <em>Standard_D2s_v3</em> (~138 EUR/month)</li>
<li>I allow 3389 (RDP) port for inbound traffic</li>
</ul>
</li>
<li>Disks
<ul>
<li>Standard SSD is enough</li>
<li>I want to delete discs when I remove the VM</li>
</ul>
</li>
<li>Networking
<ul>
<li>I use Basic NIC network security group</li>
<li>I want to delete public IP and NIC when I remove VM</li>
</ul>
</li>
<li>Management, Monitoring, and Advanced
<ul>
<li>I keep all the defaults</li>
</ul>
</li>
<li>SQL Server settings
<ul>
<li>I want only traffic within my Virtual Network (default)</li>
<li>enable SQL authentication (because - why not?)</li>
<li>default storage options (with default drives and disk types):</li>
</ul>
<blockquote>
<p>SQL Data: 1024 GiB, 5000 IOPS, 200 MB/s
SQL Log: 1024 GiB, 5000 IOPS, 200 MB/s
SQL TempDb: Use local SSD drive</p>
</blockquote>
<ul>
<li>default configuration for instance setting</li>
<li>automated patching (default)</li>
</ul>
</li>
</ul>
<p>
<img src="./images/AzurePortal.VM.StorageSetup.png"
	
	
	
	loading="lazy"
	
		alt="SQL Server VM disc setup"
	
	
>

</p>
<p>Few words more about the discs setup. By <strong>default</strong>, separate drives for data, logs and <code>tempdb</code> are used on premium SSD storage:</p>
<ul>
<li><code>F:\data</code> - for databases (except system databases)</li>
<li><code>G:\log</code> - for databases logs</li>
<li><code>D:\tempDb</code> - for tempdb</li>
</ul>
<p>All the above means there is additional work to do to have the same setup for my VM.</p>
<h2 id="taking-a-bit-more-speed">Taking a bit more speed
</h2><p>After clicking the parameters in Azure Portal, I saved the ARM template in <code>vm.create.json</code> for reference and help when I&rsquo;m stuck. I read <a class="link" href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/mssql_virtual_machine"  target="_blank" rel="noopener"
    ><code>mssql_virtua_machine</code></a> documentation and <a class="link" href="https://github.com/hashicorp/terraform-provider-azurerm/tree/main/examples/mssql/mssqlvm"  target="_blank" rel="noopener"
    >configuration sample</a>. They helped a lot, as I got more understanding of how the elements interact with each other.</p>
<p>I will not say that writing the initial code was a breeze, but I got stuck only a few times and solved the issues with a trial-and-error approach.</p>
<p>First, I need a resource group:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">MainStack</span><span class="p">(</span><span class="n">Construct</span> <span class="n">scope</span><span class="p">,</span> <span class="kt">string</span> <span class="n">id</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// define resources here</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// (...)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ResourceGroup</span> <span class="n">rg</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ResourceGroup</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">&#34;rg&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">ResourceGroupConfig</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Location</span> <span class="p">=</span> <span class="s">&#34;West Europe&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;VM-SSIS-RG&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The first annoyance: I need to define <code>id</code> for the element - <em>&ldquo;rg&rdquo;</em> (nothing special - it&rsquo;s the default behaviour of terraform), but I also need to define the variable <em>rg</em> if I want to reference it later. I understand it. I just consider it an overhead.</p>
<p>Then I decide to use Virtual Network. Pay attention - I reference the previously defined <em>ResourceGroup</em> <code>rg</code> variable to specify <code>Location</code> and <code>ResourceGroupName</code> parameters:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="kd">public</span> <span class="n">MainStack</span><span class="p">(</span><span class="n">Construct</span> <span class="n">scope</span><span class="p">,</span> <span class="kt">string</span> <span class="n">id</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// define resources here</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// (...)</span>
</span></span><span class="line"><span class="cl">    <span class="n">VirtualNetwork</span> <span class="n">n</span> <span class="p">=</span> <span class="k">new</span> <span class="n">VirtualNetwork</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">&#34;vnet&#34;</span><span class="p">,</span> <span class="k">new</span> <span class="n">VirtualNetworkConfig</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Location</span> <span class="p">=</span> <span class="n">rg</span><span class="p">.</span><span class="n">Location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">ResourceGroupName</span> <span class="p">=</span> <span class="n">rg</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">AddressSpace</span> <span class="p">=</span> <span class="k">new</span> <span class="p">[]{</span><span class="s">&#34;10.2.0.0/16&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="n">Name</span> <span class="p">=</span> <span class="s">&#34;vm-ssis-vnet&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Second annoyance: documentation is sparse, and if not the default samples, it would take me a lot more time to figure I should use an anonymous array.</p>
<p>Above I used references to <code>ResourceGroup</code> and <code>VirtualNetwork</code>, but to do that, I included the namespaces in the code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">Constructs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.MssqlVirtualMachine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.NetworkInterface</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.NetworkSecurityGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.NetworkSecurityRule</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.NetworkInterfaceSecurityGroupAssociation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.Provider</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.PublicIp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.ResourceGroup</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.Subnet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.VirtualMachine</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.VirtualNetwork</span><span class="p">;</span>
</span></span></code></pre></div><p><code>Constructs</code> and <code>HashiCorp.CdkTf</code> are included by default, but if I want my code to be clean - every resource has its own namespace.</p>
<p>Once I created a resource group, virtual network, subnet, IP, etc. I got the general pattern, and I liked it. As with classic terraform - you create a resource definition and then use it in subsequent elements.</p>
<h2 id="i-have-the-code-what-next">I have the code. What next?
</h2><p>When adding the code, I frequently run <code>dotnet build</code> to be sure it works as expected. To run the code - the recommended way is to use <code>cdktf</code> CLI and run <code>cdktf deploy &lt;project-name&gt;</code>, where <code>&lt;project-name&gt;</code> is the one provided during project creation. If you don&rsquo;t remember:</p>
<ul>
<li>either use <code>cdktf list</code> in the project folder</li>
<li>or open <code>Program.cs</code> and check line <code>new MainStack(app, &quot;vm-ssis&quot;);</code> - there is the project name</li>
<li>or open <code>cdktf.out\stacks</code> folder - each project (stack) is a separate directory - pick the directory name</li>
</ul>
<p>During deployment, the code is built with <code>dotnet run</code> command (see <code>cdktf.json</code> for details), synthesized into JSON format in <code>cdk.tf.json</code> file, and deployed using <code>terraform apply</code>.</p>
<p>To remove the VM, run <code>cdktf destroy &lt;project-name&gt;</code>.</p>
<h2 id="last-annoyance">Last annoyance
</h2><p>CDKTF is in the early stage, and there are bugs in the AzureRm provider. One I found particularly annoying for SQL Server virtual machine was the TempDb configuration. With the classic terraform <a class="link" href="https://github.com/hashicorp/terraform-provider-azurerm/blob/main/internal/services/mssql/helper/sql_virtual_machine_storage_settings.go#L32"  target="_blank" rel="noopener"
    >I have all the options from Azure Portal</a>, but CDKTF allows only the same settings as for log and data files (taken from metadata):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp" data-lang="csharp"><span class="line"><span class="cl"><span class="cp">#region</span> <span class="n">zestaw</span> <span class="n">HashiCorp</span><span class="p">.</span><span class="n">Cdktf</span><span class="p">.</span><span class="n">Providers</span><span class="p">.</span><span class="n">Azurerm</span><span class="p">,</span> <span class="n">Version</span><span class="p">=</span><span class="m">1.0</span><span class="p">.</span><span class="m">0.0</span><span class="p">,</span> <span class="n">Culture</span><span class="p">=</span><span class="n">neutral</span><span class="p">,</span> <span class="n">PublicKeyToken</span><span class="p">=</span><span class="kc">null</span>
</span></span><span class="line"><span class="cl"><span class="c1">// HashiCorp.Cdktf.Providers.Azurerm.dll</span>
</span></span><span class="line"><span class="cl"><span class="cp">#endregion</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#nullable</span> <span class="n">enable</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">using</span> <span class="nn">Amazon.JSII.Runtime.Deputy</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="nn">HashiCorp.Cdktf.Providers.Azurerm.MssqlVirtualMachine</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="na">    [JsiiInterface(typeof(IMssqlVirtualMachineStorageConfigurationTempDbSettings), &#34;@cdktf/provider-azurerm.mssqlVirtualMachine.MssqlVirtualMachineStorageConfigurationTempDbSettings&#34;)]</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="k">interface</span> <span class="nc">IMssqlVirtualMachineStorageConfigurationTempDbSettings</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Summary:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//     Docs at Terraform Registry: {@link https://www.terraform.io/docs/providers/azurerm/r/mssql_virtual_machine#default_file_path</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//     MssqlVirtualMachine#default_file_path}.</span>
</span></span><span class="line"><span class="cl"><span class="na">        [JsiiProperty(&#34;defaultFilePath&#34;, &#34;{\&#34;primitive\&#34;:\&#34;string\&#34;}&#34;, false, false)]</span>
</span></span><span class="line"><span class="cl">        <span class="kt">string</span> <span class="n">DefaultFilePath</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Summary:</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//     Docs at Terraform Registry: {@link https://www.terraform.io/docs/providers/azurerm/r/mssql_virtual_machine#luns</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//     MssqlVirtualMachine#luns}.</span>
</span></span><span class="line"><span class="cl"><span class="na">        [JsiiProperty(&#34;luns&#34;, &#34;{\&#34;collection\&#34;:{\&#34;elementtype\&#34;:{\&#34;primitive\&#34;:\&#34;number\&#34;},\&#34;kind\&#34;:\&#34;array\&#34;}}&#34;, false, false)]</span>
</span></span><span class="line"><span class="cl">        <span class="kt">double</span><span class="p">[]</span> <span class="n">Luns</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>I hope it will change soon, but be aware that today the problem exists.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/vm/">Vm</a>
        
            <a href="/tags/terraform/">Terraform</a>
        
            <a href="/tags/cdktf/">Cdktf</a>
        
    </section>


    </footer>


    
</article>

    

    

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="BartekR/bartekr.github.io"
        issue-term="url"
        
        label="blog-comment"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2017 - 
        
        2025 BartekR
    </section>
    
    <section class="powerby">
        
            (c) Bartosz Ratajczyk <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
