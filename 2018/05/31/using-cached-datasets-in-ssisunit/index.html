<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<title>Using cached datasets in ssisUnit - BartekR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="generator" content="Hugo 0.76.5" /><meta property="og:site_name" content="BartekR">
  <meta property="og:title" content="Using cached datasets in ssisUnit">
  <meta property="og:description" content="BartekR blog. Previously known as String or binary data would be truncated">
  <meta property="description" content="BartekR blog. Previously known as String or binary data would be truncated">
  <meta property="og:url" content="http://bartekr.github.io/2018/05/31/using-cached-datasets-in-ssisunit/">
  <meta property="og:type" content="article">
  
    <meta property="og:image" content="http://bartekr.github.io/img/main/Bartek_SqlSatOslo2019_100x100.png">
  
  
            <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/vs2015.min.css">
          <link rel="stylesheet" href="/css/bundle.min.307f33cd8015e5bab28d6ebda9b400f8d3059bc248b4e60adf4d23469fab5a2b.css" integrity="sha256-MH8zzYAV5bqyjW69qbQA&#43;NMFm8JItOYK300jRp&#43;rWis="><link rel="stylesheet" href="/css/add-on.css">
</head>

  <body>
    

<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/" class="nav">
        
          BartekR blog
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu menu">
      
        
          
          <a href="/about" class="nav link"><i class='far fa-id-card'></i> About</a>
        
      
        
          
          <a href="https://brinf.wordpress.com" class="nav link"><i class='fab fa-wordpress'></i> Blog [PL]</a>
        
      
        
          
          <a href="/books" class="nav link"><i class='fas fa-book-reader'></i> Books</a>
        
      
        
          
          <a href="/series" class="nav link"><i class='fas fa-newspaper'></i> Series</a>
        
      
        
          
          <a href="/speaking" class="nav link"><i class='fas fa-microphone-alt'></i> Speaking</a>
        
      
      
      <a href="#search-input" class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a>
    </menu>
    <a href="#search-input" class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
    
    <a href="#lang-menu" class="nav lang-toggle" lang="en">en</a>
    <a href="#site-nav" class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  <menu id="search" class="menu"><input id="search-input" class="search-input menu"></input><div id="search-results" class="search-results menu"></div></menu>
  <menu id="lang-menu" class="flyout-menu menu">
  <a href="#" lang="en" class="nav link active"> (en)</a>
  
    
      
    
  
</menu>

  
</header>

    <div id="wrapper">
      <section id="site-intro" class="hidden-single-column">
  <a href="/"><img src="http://bartekr.github.io/img/main/Bartek_SqlSatOslo2019_100x100.png" class="circle" width="100" alt="BartekR profile pic" /></a>
  <header>
    <h1>BartekR</h1>
  </header>
  <main>
    <p>SQL Server. SSIS. PowerShell. Azure.<br/>1 wife. 1 daughter.3 dogs. 9 cats.</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        

        <li><a href="//github.com/BartekR" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//www.linkedin.com/in/bartoszratajczyk" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/b_ratajczyk" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>













      </ul>
    </footer>
  
</section>

      <main id="site-main">
        
  <article class="post">
    <header>
  <div class="title">
    
      <h2><a href="/2018/05/31/using-cached-datasets-in-ssisunit/">Using cached datasets in ssisUnit</a></h2>
    
    
  </div>
  <div class="meta">
    <time datetime="2018-05-31 00:00:00 &#43;0000 UTC">May 31, 2018</time>
    
    
  </div>
</header>

    <div id="socnet-share">
      





    </div>
    <div class="content">
      
      <p><a href="http://blog.bartekr.net/2018/04/30/using-connections-and-datasets-in-ssisunit/">In the previous post</a>, I wrote about using datasets in the ssisUnit test. By default, the dataset query is executed against the data source each time the test is run. But we also have an option to store the dataset&rsquo;s result in the test file. In this post, I will show you how you can use it.</p>
<p>First - why would you want to store the datasets within the test file? Well, maybe you don&rsquo;t want to hammer your database with hundreds of requests to prepare the expected data outcome. And/or you want to have everything in your unit test file, and you don&rsquo;t want to write all that <code>CAST</code>/<code>CONVERT</code> information for the datatypes when preparing the dataset?</p>
<p>The ssisUnit GUI does not support creating the persisted dataset. If you switch the <em>IsResultsStored</em> flag to true on the dataset&rsquo;s properties, it gives a warning &ldquo;<em>The expected dataset&rsquo;s (<!-- raw HTML omitted -->) stored results does not contain data. Populate the Results data table before executing.</em>&rdquo; during the test run.</p>
<p>To find out more about it, take a look at the source code. Open the <code>Dataset.cs</code> file and go to the line 126. There is a method <code>PersistToXml()</code> that writes the <code>Dataset</code> as XML.</p>
<p><a href="http://blog.bartekr.net/wp-content/uploads/2018/05/PersistToXml.png"><img src="images/PersistToXml-300x229.png" alt=""></a> In the lines 146 - 158 it verifies existance of the <code>Results</code> element. If it exists, the XML node <code>results</code> is prepared, and the content of the <code>Results</code> element is saved as CDATA.</p>
<p>if (Results != null)
{
xmlWriter.WriteStartElement(&ldquo;results&rdquo;);</p>
<pre><code>using (var stringWriter = new StringWriter())
{
    Results.WriteXml(stringWriter, XmlWriteMode.WriteSchema, true);

    xmlWriter.WriteCData(stringWriter.ToString());
}

xmlWriter.WriteEndElement();
</code></pre>
<p>}</p>
<p>The <code>Results</code> object is defined in line 186 - it&rsquo;s stored internally as the <code>DataTable</code> object. So, it must be serialised to store and retrieve it from the saved XML file:</p>
<p>[Browsable(false)]
public DataTable Results { get; internal set; }</p>
<p>The recipe for the cached/stored result is easy: use the <code>&lt;results /&gt;</code> element in your <code>.ssisUnit</code> file and fill it with the serialised <code>DataTable</code>.</p>
<h1 id="preparing-the-datatable">Preparing the datatable</h1>
<p>I will again use the <code>15_Users_Dataset.dtsx</code> package for testing. I will create <code>15_Users_Dataset_Persisted.ssisUnit</code> file as a copy of the <code>15_Users_Dataset.ssisUnit</code> file and replace the <em>Empty table test: expected dataset</em> as the cached result. To prepare the serialised datatable I used parts of <a href="https://docs.microsoft.com/pl-pl/dotnet/api/system.data.dataset.writexml?view=netframework-4.7.2#System_Data_DataSet_WriteXml_System_Xml_XmlWriter_System_Data_XmlWriteMode_">an example from the documentation</a> and <a href="http://www.linqpad.net/">Linqpad</a>. <a href="https://github.com/BartekR/ssisUnitLearning/tree/master/Scripts">Go to the <code>Scripts</code> folder</a> and open the script <code>15_Users_Dataset_Persisted.linq</code>. The file has some comments, so it should be easy to understand. The main part is:</p>
<p>DataColumn name = new DataColumn(&ldquo;Name&rdquo;, typeof(System.String));
name.MaxLength = 50;
table.Columns.Add(name);</p>
<p>DataColumn login = new DataColumn(&ldquo;Login&rdquo;, typeof(System.String));
login.MaxLength = 12;
table.Columns.Add(login);</p>
<p>table.Columns.Add(&ldquo;IsActive&rdquo;, typeof(System.Boolean));
table.Columns.Add(&ldquo;Id&rdquo;, typeof(System.Int32));
table.Columns.Add(&ldquo;SourceSystemId&rdquo;, typeof(System.Byte));
table.Columns.Add(&ldquo;IsDeleted&rdquo;, typeof(System.Boolean));</p>
<p>// Login is char(12), the database has ANSI_PADDING = ON, so pad the string with spaces
table.Rows.Add(new object[] { &ldquo;Name 1&rdquo;, &ldquo;Login 1     &ldquo;, 1, 1, 2, 0 });
table.Rows.Add(new object[] { &ldquo;Name 2&rdquo;, &ldquo;Login 2     &ldquo;, 1, 2, 2, 0 });
table.Rows.Add(new object[] { &ldquo;Name 3&rdquo;, &ldquo;Login 3     &ldquo;, 0, 3, 2, 0 });</p>
<p>If you want to use Linqpad - remember to set the language as <em>C# Statement(s)</em> and hit <em>Execute</em> button. The result of the script is as follows:</p>
<!-- raw HTML omitted -->
<p>In the <code>.ssisUnit</code> test file, the <code>&lt;NewDataSet /&gt;</code> element should be wrapped in the <code>&lt;result /&gt;</code> as <code>CDATA</code>:</p>
<p><a href="http://blog.bartekr.net/wp-content/uploads/2018/05/PersistedDatasetInSsisUnitFile.png"><img src="images/PersistedDatasetInSsisUnitFile-300x69.png" alt=""></a></p>
<p>The part that took me a lot of time to figure out was the <em>Login</em> column. In the database, it has <code>char(12)</code> data type. It is very dependent on the <code>[ANSI_PADDING](https://docs.microsoft.com/en-us/sql/t-sql/statements/set-ansi-padding-transact-sql?view=sql-server-2017)</code> setting. The recommended setting is <code>ANSI_PADDING ON</code>, which means it pads the strings with trailing spaces for the char data type columns. And that&rsquo;s the setting for the <em>ssisUnitLearningDB</em> - the database used for this blog post series.</p>
<p>How does it affect the test? When you persist the char column in the test file, you have to also pad the string with spaces if the column was created with <code>ANSI_PADDING ON</code> setting. If you don&rsquo;t pad the string column, the test will not pass. To illustrate it I prepared some additional datasets and assertions.</p>
<p><a href="http://blog.bartekr.net/wp-content/uploads/2018/05/15_Users_Dataset_Persisted.png"><img src="images/15_Users_Dataset_Persisted-260x300.png" alt=""></a></p>
<p>I&rsquo;m testing different dataset settings and how it affects the assertions results. Even if you set the dataset as persisted, ssisUnit expects the query, so I&rsquo;m mostly using T-SQL&rsquo;s comment <code>--</code>as a placeholder. But I also checked if it has to be the same query as I used to prepare the persisted dataset. Running the test you will see, that without padding the <em>Login</em> column data the assertions don&rsquo;t return <em>True</em>.</p>
<h1 id="the-data-types">The data types</h1>
<p>When you create the <code>DataTable</code> object you add the columns of the specific type, like</p>
<p>table.Columns.Add(&ldquo;Id&rdquo;, typeof(System.Int32))</p>
<p>How do you know what types you should use? You can guess of course (I did!), but you don&rsquo;t have to. Take a look at the <code>RetrieveDataTable()</code> method in the <code>DataTable.cs</code> file (especially the lines 216 - 237). This is how ssisUnit converts the query result to the <code>DataTable</code> object for further comparison:</p>
<p>if (!IsResultsStored)
{
using (var command = Helper.GetCommand(ConnectionRef, Query))
{
command.Connection.Open();
using (IDataReader expectedReader = command.ExecuteReader())
{
var ds = new DataSet();</p>
<pre><code>        ds.Load(expectedReader, LoadOption.OverwriteChanges, new\[\] { &quot;Results&quot; });

        if (ds.Tables.Count &lt; 1)
        {
            throw new ApplicationException(
                string.Format(
                    CultureInfo.CurrentCulture, &quot;The dataset (\\&quot;{0}\\&quot;) did not retrieve any data.&quot;, Name));
        }

        return ds.Tables\[0\];
    }
}
</code></pre>
<p>}</p>
<p>I took this part of the code (along with the <code>Helper.GetCommand()</code>) and expanded it with writing metadata of the <code>DataTable</code> object. I use Linqpad and its <code>Dump()</code> method to quickly see the content. The full script <code>GetDataTableMetadata.linq</code> is located <a href="https://github.com/BartekR/ssisUnitLearning/tree/master/Scripts">in the <code>Scripts</code> directory</a> of the project.</p>
<p><a href="http://blog.bartekr.net/wp-content/uploads/2018/05/GetDataTableMetadata.png"><img src="images/GetDataTableMetadata-300x197.png" alt=""></a></p>
<p>As you can see, the <em>Login</em> column has Length == 12 and MaxLength == 12. It means, that string is padded with blanks. Also notice, that the <em>bit</em> column is mapped to <em>System.Boolean</em> and the <em>tinyint</em> column is mapped to <em>System.Int32</em> - just like <em>Int</em>.</p>
<h1 id="to-sum-up">To sum up</h1>
<p>If you want to store the dataset in the test file - no problem. The ssisUnit GUI does not support it, but the engine does. Use provided scripts to get the metadata of the dataset and serialise the prepared dataset. Then set the <em>IsResultsStored</em> flag to <em>True</em> and paste the serialised code directly to the ssisUnit file using <code>&lt;results /&gt;</code> and <code>CDATA</code>.</p>

    </div>
    <footer>
      <div class="stats">
  
    <ul class="categories">
      <li>None</li>
    </ul>
  
  
    <ul class="tags">
      <li>None</li>
    </ul>
  
</div>

    </footer>
  </article>
  
    

  
  <div class="pagination">
    
      <a href="/2018/06/15/executing-ssisunit-tests-in-mstest-framework/" class="button left"><span>Executing ssisUnit tests in MSTest framework</span></a>
    
    
      <a href="/2018/04/30/using-connections-and-datasets-in-ssisunit/" class="button right"><span>Using Connections and Datasets in ssisUnit</span></a>
    
  </div>

      </main>
      <section id="site-sidebar">
  
    <section id="recent-posts">
      <header>
        <h1>Recent Posts</h1>
      </header>
      
      <article class="mini-post">
          <a href="/2020/09/24/using-the-system-oauth-token-in-azure-devops/" class="image" style="--bg-image: url('http://bartekr.github.io/2020/09/24/using-the-system-oauth-token-in-azure-devops/images/203Error.png');">
    <img src="http://bartekr.github.io/2020/09/24/using-the-system-oauth-token-in-azure-devops/images/203Error.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/09/24/using-the-system-oauth-token-in-azure-devops/">Using the system OAuth token in Azure DevOps</a></h2>
          <time class="published" datetime="2020-09-24 00:00:00 &#43;0000 UTC">September 24, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2020/09/01/have-problems-with-docker-desktop-for-windows-home-yeah-me-too/" class="image" style="--bg-image: url('http://bartekr.github.io/2020/09/01/have-problems-with-docker-desktop-for-windows-home-yeah-me-too/images/DockerDesktop.png');">
    <img src="http://bartekr.github.io/2020/09/01/have-problems-with-docker-desktop-for-windows-home-yeah-me-too/images/DockerDesktop.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/09/01/have-problems-with-docker-desktop-for-windows-home-yeah-me-too/">Have problems with Docker Desktop for Windows Home? Yeah, me too!</a></h2>
          <time class="published" datetime="2020-09-01 00:00:00 &#43;0000 UTC">September 1, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2020/05/19/adding-a-new-task-in-tfs-azure-devops-using-excel/" class="image" style="--bg-image: url('http://bartekr.github.io/2020/05/19/adding-a-new-task-in-tfs-azure-devops-using-excel/images/AzureDevOps_TeamPlugin.png');">
    <img src="http://bartekr.github.io/2020/05/19/adding-a-new-task-in-tfs-azure-devops-using-excel/images/AzureDevOps_TeamPlugin.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/05/19/adding-a-new-task-in-tfs-azure-devops-using-excel/">Adding a new task in TFS (Azure DevOps) using Excel</a></h2>
          <time class="published" datetime="2020-05-19 00:00:00 &#43;0000 UTC">May 19, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2020/05/04/adding-a-new-task-in-tfs-using-c/" class="image" style="--bg-image: url('http://bartekr.github.io/2020/05/04/adding-a-new-task-in-tfs-using-c/images/tbl_Field.png');">
    <img src="http://bartekr.github.io/2020/05/04/adding-a-new-task-in-tfs-using-c/images/tbl_Field.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/05/04/adding-a-new-task-in-tfs-using-c/">Adding a new Task in TFS using C#</a></h2>
          <time class="published" datetime="2020-05-04 00:00:00 &#43;0000 UTC">May 4, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2019/08/07/draw-the-ssis-package-using-svg-part-iii/" class="image" style="--bg-image: url('http://bartekr.github.io/2019/08/07/draw-the-ssis-package-using-svg-part-iii/images/BoundingBoxRectangles.png');">
    <img src="http://bartekr.github.io/2019/08/07/draw-the-ssis-package-using-svg-part-iii/images/BoundingBoxRectangles.png" alt="">
  </a>
        <header>
          <h2><a href="/2019/08/07/draw-the-ssis-package-using-svg-part-iii/">Draw the SSIS Package using SVG - part III</a></h2>
          <time class="published" datetime="2019-08-07 00:00:00 &#43;0000 UTC">August 7, 2019</time>
        </header>
      </article>
      
      
        <footer>
          <a href="/post/" class="button">See More</a>
        </footer>
      
    </section>
  

  
    

      <section id="categories">
        <header>
          <h1><a href="/categories">Categories</a></h1>
        </header>
        <ul>
          
          
          <li>
              <a href="/categories/troubleshooting/">troubleshooting<span class="count">2</span></a>
          
          <li>
              <a href="/categories/learning/">learning<span class="count">1</span></a>
          
          <li>
              <a href="/categories/programming/">programming<span class="count">1</span></a>
          
          <li>
              <a href="/categories/series/">series<span class="count">1</span></a>
          
          </li>
        </ul>
      </section>
    
  

  
    <section id="mini-bio">
      <header>
        <h1>About</h1>
      </header>
      <p>Bartekr 01</p>
      <footer>
        <a href="/about" class="button">Learn More</a>
      </footer>
    </section>
  
</section>

      <footer id="site-footer">
  
  <p class="copyright">
    © 2020 BartekR
      <br>
    Theme: <a href='https://github.com/pacollins/hugo-future-imperfect-slim' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>A <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>HTML5 UP port</a> | Powered by <a href='https://gohugo.io/' title='0.76.5' target='_blank' rel='noopener'>Hugo</a>
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>

      <script src="/js/highlight.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/languages/powershell.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/languages/csharp.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script><script src="/js/bundle.min.b4e669fa428a81defb8af0916c53f39cd1b8e0bbab22199c06f0b182907ba474.js" integrity="sha256-tOZp&#43;kKKgd77ivCRbFPznNG44LurIhmcBvCxgpB7pHQ="></script>
    <script src="/js/add-on.js"></script>
    </div>
  </body>
</html>
