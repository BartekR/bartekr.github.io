<!DOCTYPE html>
<html lang="en-gb" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="One of the elements you can define in ssisUnit is a Dataset. In this post of the ssisUnit series, I will show you how to prepare and use it later in a test. The Dataset\rAs you can see in the image above, the dataset is a named result that contains data. It has five attributes (although you can see just four of them in the GUI): Name (required) - the name of the dataset, used for referencing the dataset in a test IsResultsStored (required) - the boolean flag informing if we have the results cached (true) or we always ask the external source (false) Connection (required) - the connection reference for the dataset retrieval Query (optional) - the query for the dataset definition Results (optional) - the cached dataset (not available in the GUI) You can find all of the attributes in the SsisUnit.">
<title>Using Connections and Datasets in ssisUnit</title>

<link rel='canonical' href='https://blog.bartekr.net/2018/04/30/using-connections-and-datasets-in-ssisunit/'>

<link rel="stylesheet" href="/scss/style.min.b9c8156d464c343bdacaf14a871581fb94cbbdb9dd5cbce4ba017361187cc930.css"><meta property='og:title' content="Using Connections and Datasets in ssisUnit">
<meta property='og:description' content="One of the elements you can define in ssisUnit is a Dataset. In this post of the ssisUnit series, I will show you how to prepare and use it later in a test. The Dataset\rAs you can see in the image above, the dataset is a named result that contains data. It has five attributes (although you can see just four of them in the GUI): Name (required) - the name of the dataset, used for referencing the dataset in a test IsResultsStored (required) - the boolean flag informing if we have the results cached (true) or we always ask the external source (false) Connection (required) - the connection reference for the dataset retrieval Query (optional) - the query for the dataset definition Results (optional) - the cached dataset (not available in the GUI) You can find all of the attributes in the SsisUnit.">
<meta property='og:url' content='https://blog.bartekr.net/2018/04/30/using-connections-and-datasets-in-ssisunit/'>
<meta property='og:site_name' content='BartekR'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='SSIS' /><meta property='article:tag' content='ssisUnit' /><meta property='article:published_time' content='2018-04-30T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2018-04-30T00:00:00&#43;00:00'/><meta property='og:image' content='https://blog.bartekr.net/2018/04/30/using-connections-and-datasets-in-ssisunit/images/Dataset.png' />
<meta name="twitter:title" content="Using Connections and Datasets in ssisUnit">
<meta name="twitter:description" content="One of the elements you can define in ssisUnit is a Dataset. In this post of the ssisUnit series, I will show you how to prepare and use it later in a test. The Dataset\rAs you can see in the image above, the dataset is a named result that contains data. It has five attributes (although you can see just four of them in the GUI): Name (required) - the name of the dataset, used for referencing the dataset in a test IsResultsStored (required) - the boolean flag informing if we have the results cached (true) or we always ask the external source (false) Connection (required) - the connection reference for the dataset retrieval Query (optional) - the query for the dataset definition Results (optional) - the cached dataset (not available in the GUI) You can find all of the attributes in the SsisUnit."><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://blog.bartekr.net/2018/04/30/using-connections-and-datasets-in-ssisunit/images/Dataset.png' />
    <link rel="shortcut icon" href="/favicon.ico" />

  

<style>
     
    :root {
         
        --base-font-family: "Roboto", "Lato", var(--sys-font-family), var(--zh-font-family), sans-serif;
    }
</style>

<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap";
    
        customFont.type = "text/css";
        customFont.rel = "stylesheet";
    
        document.head.appendChild(customFont);
    }());
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/Bartek_SqlSatOslo2019_100x100_huc95037055e21b687f52ff80813407d9d_14060_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">BartekR</a></h1>
            <p class="site-description">Azure. PowerShell. SQL. DevOps.<br />1 wife. 1 kid. 4 dogs. 5 cats.</p>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/BartekR'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/b_ratajczyk'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about' >
                
                
                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='https://brinf.wordpress.com' >
                
                
                
                <span>Old blog [PL]</span>
            </a>
        </li>
        
        
        <li >
            <a href='/series' >
                
                
                
                <span>Series</span>
            </a>
        </li>
        
        
        <li >
            <a href='/books' >
                
                
                
                <span>Books</span>
            </a>
        </li>
        
        
        <li >
            <a href='/speaking' >
                
                
                
                <span>Speaking</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories' >
                
                
                
                <span>Categories</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags' >
                
                
                
                <span>Tags</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search' >
                
                
                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li><a href="#the-dataset">The Dataset</a></li>
    <li><a href="#the-scenario">The scenario</a></li>
    <li><a href="#defining-the-ssisunit-connections">Defining the ssisUnit connections</a></li>
    <li><a href="#the-test-the-setup-the-teardown">The test, the setup, the teardown</a></li>
    <li><a href="#the-test-cases">The test cases</a></li>
    <li><a href="#creating-and-using-the-datasets-finally">Creating and using the datasets (finally!)</a></li>
    <li><a href="#tuning-the-test">Tuning the test</a></li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/2018/04/30/using-connections-and-datasets-in-ssisunit/">
                
                    <img src="/2018/04/30/using-connections-and-datasets-in-ssisunit/images/Dataset.png" loading="lazy" alt="Featured image of post Using Connections and Datasets in ssisUnit" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/series/" >
                Series
            </a>
        
            <a href="/categories/testing/" >
                Testing
            </a>
        
            <a href="/categories/learning/" >
                Learning
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/2018/04/30/using-connections-and-datasets-in-ssisunit/">Using Connections and Datasets in ssisUnit</a>
        </h2>
    
        

        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Apr 30, 2018</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    9 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>One of the elements you can define in ssisUnit is a Dataset. In this post of the <a class="link" href="http://blog.bartekr.net/series/"  target="_blank" rel="noopener"
    >ssisUnit series</a>, I will show you how to prepare and use it later in a test.</p>
<p><a class="link" href="images/Dataset.png" >
  
  <p style="text-align: center;">
    <img src="images/Dataset.png"
	
	
	
	loading="lazy"
	
		alt="Dataset"
	
	
>
  </p>

</a></p>
<h2 id="the-dataset">The Dataset
</h2><p>As you can see in the image above, <strong>the dataset is a named result that contains data</strong>. It has five attributes (although you can see just four of them in the GUI):</p>
<ul>
<li><em>Name</em> (required) - the name of the dataset, used for referencing the dataset in a test</li>
<li><em>IsResultsStored</em> (required) - the boolean flag informing if we have the results cached (true) or we always ask the external source (false)</li>
<li><em>Connection</em> (required) - the connection reference for the dataset retrieval</li>
<li><em>Query</em> (optional) - the query for the dataset definition</li>
<li><em>Results</em> (optional) - the cached dataset (not available in the GUI)</li>
</ul>
<p>You can find all of the attributes in the <code>SsisUnit.xsd</code> file in the source code.</p>
<p>Why would you use the dataset? Verifying the numbers is almost always enough, but I have the cases I have to check the actual data after the processing. Like testing the SCD1 or SCD2 attributes, verifying the <code>MERGE</code> statements, checking <code>UPDATE</code>s on the data. I prepare a small reference data and compare it using <code>DataCompareCommand</code>.</p>
<figure class="noborder"><img src="/2018/04/30/using-connections-and-datasets-in-ssisunit/images/Datasets.png"
    alt="The goal: compare data in the table (actual data) with the reference data (expected data)"><figcaption>
      <p>The goal: compare data in the table (actual data) with the reference data (expected data)</p>
    </figcaption>
</figure>

<h2 id="the-scenario">The scenario
</h2><p>I will test loading users data from the staging table to the destination table. I have the <code>stg.Users</code> table with the information from the source system, and I want to transfer it to the <code>dbo.Users</code> table using the rules:</p>
<ul>
<li>the natural key in <code>dbo.Users</code> is (<code>SourceId, SourceSystemId</code>)</li>
<li>the natural key in <code>stg.Users</code> is (<code>Id, SourceSystemId</code>)</li>
<li>if the record from <code>stg.Users</code> is not in <code>dbo.Users</code>, then add it</li>
<li>if the record exists in <code>dbo.Users</code> and has different data than the record in <code>stg.Users</code>, then update it</li>
<li>if the record exists in <code>dbo.Users</code> and doesn&rsquo;t exist in <code>stg.Users</code> - mark it as deleted (<code>IsDeleted</code> = 1)</li>
<li>when the new record is inserted, the columns <code>InsertedAuditId</code> and <code>UpdatedAuditId</code> have the same value</li>
<li>when the record is updated, the column <code>UpdateAuditId</code> is updated, and <code>UpdateAuditId</code> &gt; <code>InsertedAuditId</code></li>
<li>only the records with the changed attributes get an update</li>
</ul>
<p>I will use the <code>MERGE</code> statement for the data loading process. In the package I will also use two _SQL Task_s for auditing. I have <code>meta.Audit</code> table for tracking the executions of the packages and I use <code>meta.uspPackageStart</code> and <code>meta.uspPackageFinish</code> stored procedures to insert and update the audit data. The package looks like in the picture below.</p>
<p><a class="link" href="images/15_Users_Dataset.png" >
  
  <p style="text-align: center;">
    <img src="images/15_Users_Dataset.png"
	
	
	
	loading="lazy"
	
		alt="Users dataset"
	
	
>
  </p>

</a></p>
<p>I will define the tests to run later in the post.</p>
<h2 id="defining-the-ssisunit-connections">Defining the ssisUnit connections
</h2><p>One of the dataset&rsquo;s attributes is a <em>Connection</em>. It&rsquo;s not any of the connections defined within the SSIS package or the project. It&rsquo;s the connection defined in the ssisUnit test suite.</p>
<p><a class="link" href="images/Connection.png" >
  
  <p style="text-align: center;">
    <img src="images/Connection.png"
	
	
	
	loading="lazy"
	
		alt="ssisUnit connection"
	
	
>
  </p>

</a></p>
<p>The connection has four attributes:</p>
<ul>
<li><em>Connection string</em> - the connection string to the external source</li>
<li><em>Connection type</em> - the type of the connection (supported types: <em>ConnectionString</em> and <em>Ado.Net</em>)</li>
<li><em>Invariant type</em> - the type of the <em>Ado.Net</em> provider (when used)</li>
<li>Reference <em>name</em> - the name of the connection to use in <code>SqlCommand</code> or <code>DatasetCommand</code></li>
</ul>
<p>I use a Connection string for the database communication. When you add a new connection, you have only the text box for entering the connection string, or you can pick the provider to enter all the data.</p>
<p><a class="link" href="images/DefineConnectionString.png" >
  
  <p style="text-align: center;">
    <img src="images/DefineConnectionString.png"
	
	
	
	loading="lazy"
	
		alt="Define connection string"
	
	
>
  </p>

</a></p>
<p>After you fill the connection information, the wizard detects the type and displays them in the proper format.</p>
<p><a class="link" href="images/ConnectionString_OleDbProvider.png" >
  
  <p style="text-align: center;">
    <img src="images/ConnectionString_OleDbProvider.png"
	
	
	
	loading="lazy"
	
		alt="Connection string for OLEDB provider"
	
	
>
  </p>

</a></p>
<p>The connection reference should be ready to use. But when you try to use it in the <code>SqlCommand</code> right after creating it you will see the error:</p>
<p><a class="link" href="images/ConnectionRefError.png" >
  
  <p style="text-align: center;">
    <img src="images/ConnectionRefError.png"
	
	
	
	loading="lazy"
	
		alt="ConnectionRef eror"
	
	
>
  </p>

</a></p>
<p>It&rsquo;s not a ssisUnit problem, but the GUI problem - it has some issues with refreshing the object information. Just save the test, open it again, and everything will work fine.</p>
<h2 id="the-test-the-setup-the-teardown">The test, the setup, the teardown
</h2><p>Now you can use SQL commands to query the database about the data. You can also prepare and destroy data before and after the test during the setup and teardown phases. But first - the test itself. Create a new test <em>SQL MERGE Users: Empty table</em> using the <em>SQL MERGE Users</em> task. Now create the <code>SqlCommand</code> in the <em>TestSetup</em> node using right-click, and add the following code to setup <code>stg.Users</code> data:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="n">stgUsers</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">VALUES</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="s1">&#39;Name 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Login 1&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="s1">&#39;Name 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Login 2&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="s1">&#39;Name 3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Login 3&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Login</span><span class="p">,</span><span class="w"> </span><span class="n">IsActive</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">SourceSystemId</span><span class="p">,</span><span class="w"> </span><span class="n">InsertedAuditId</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">stg</span><span class="p">.</span><span class="n">Users</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Login</span><span class="p">,</span><span class="w"> </span><span class="n">IsActive</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">SourceSystemId</span><span class="p">,</span><span class="w"> </span><span class="n">InsertedAuditId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Login</span><span class="p">,</span><span class="w"> </span><span class="n">IsActive</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">SourceSystemId</span><span class="p">,</span><span class="w"> </span><span class="n">InsertedAuditId</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">stgUsers</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>You should have something like in the picture below:</p>
<p><a class="link" href="images/TestSetupSqlCommand.png" >
  
  <p style="text-align: center;">
    <img src="images/TestSetupSqlCommand.png"
	
	
	
	loading="lazy"
	
		alt="Test setup - SQL command"
	
	
>
  </p>

</a></p>
<p>As you can see - the GUI has a feature of not displaying the name of the command in the test tree on the left.</p>
<p>As there is a code to set up the test I also have the code to tidy up after. I use two <code>TRUNCATE TABLE</code> commands to clean up the <code>stg.Users</code> and <code>dbo.Users</code> tables.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;SqlCommand</span> <span class="na">name=</span><span class="s">&#34;SqlCommand: TRUNCATE stg.Users&#34;</span> <span class="na">connectionRef=</span><span class="s">&#34;ssisUnitLearningDB&#34;</span> <span class="na">returnsValue=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>TRUNCATE TABLE stg.Users;<span class="nt">&lt;/SqlCommand&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;SqlCommand</span> <span class="na">name=</span><span class="s">&#34;SqlCommand: TRUNCATE dbo.Users&#34;</span> <span class="na">connectionRef=</span><span class="s">&#34;ssisUnitLearningDB&#34;</span> <span class="na">returnsValue=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>TRUNCATE TABLE dbo.Users;<span class="nt">&lt;/SqlCommand&gt;</span>
</span></span></code></pre></div><h2 id="the-test-cases">The test cases
</h2><p>There are a few test cases I want to run for the scenario mentioned above. I will cover them in this and following posts:</p>
<ul>
<li>the <code>stg.Users</code> table contains the data, and the <code>dbo.Users</code> table is empty</li>
<li>the <code>stg.Users</code> table has the data, that does not exist in the <code>dbo.Users</code> table and <code>dbo.Users</code> table is not empty</li>
<li>the <code>stg.Users</code> table is not empty but lacks some records from the <code>dbo.Users</code> table</li>
<li>the <code>stg.Users</code> table is empty and the <code>dbo.Users</code> table is not empty</li>
</ul>
<p>Within those test cases I want to check:</p>
<ul>
<li>the number of records loaded to <code>dbo.Users</code></li>
<li>if the attributes are same in <code>stg.Users</code> and <code>dbo.Users</code></li>
<li>if <code>InsertedAuditId</code> is equal to <code>UpdatedAuditId</code> or greater when appropriate</li>
<li>if every required record marked with <code>IsDeleted</code> = 1</li>
</ul>
<p>This time I will not use the variables to hold the results. I will run separate SQL statements to verify the count of the records in the table and write expected and actual datasets code to verify if they match. I will focus on the dataset part.</p>
<p>I will load three records to the <code>stg.Users</code> table (with the T-SQL code above) and process them with the package. Then I will check if these records are loaded to the <code>dbo.Users</code> table and if they have the same values (excluding audits and the <code>Id</code> column). To verify I will use just the <code>SELECT</code> statement from the code above as the reference data and compare it to the <code>SELECT</code> statement on <code>dbo.Users</code> table.</p>
<h2 id="creating-and-using-the-datasets-finally">Creating and using the datasets (finally!)
</h2><p>To create the dataset go to the <em>Datasets</em> node, right-click, and select <em>Add Dataset</em>. Prepare two datasets: <em>Empty table test: expected dataset</em> and <em>Empty table test: actual dataset</em>. At the beginning try to be very descriptive, it helps with getting familiar with the terminology and the process.</p>
<p>For the expected dataset use the T-SQL code above changing <code>InsertAuditId</code> = -1  column to <code>IsDeleted</code> = 0, set the <em>ssisUnitLearningDB</em> connection prepared in the previous steps and leave <em>IsResultsStored</em> flag as <em>false</em>. For the actual dataset use a <code>SELECT</code> query on the <code>dbo.Users</code> table. You should get the code similar to this one:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;DatasetList&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Dataset</span> <span class="na">name=</span><span class="s">&#34;Empty table test: expected dataset&#34;</span> <span class="na">connection=</span><span class="s">&#34;ssisUnitLearningDB&#34;</span> <span class="na">isResultsStored=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;query&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cp">&lt;![CDATA[SELECT *
</span></span></span><span class="line"><span class="cl"><span class="cp">FROM (
</span></span></span><span class="line"><span class="cl"><span class="cp">    VALUES
</span></span></span><span class="line"><span class="cl"><span class="cp">        (&#39;Name 1&#39;, &#39;Login 1&#39;, 1, 1, 2, 0),
</span></span></span><span class="line"><span class="cl"><span class="cp">        (&#39;Name 2&#39;, &#39;Login 2&#39;, 1, 2, 2, 0),
</span></span></span><span class="line"><span class="cl"><span class="cp">        (&#39;Name 3&#39;, &#39;Login 3&#39;, 0, 3, 2, 0)
</span></span></span><span class="line"><span class="cl"><span class="cp">)x (Name, Login, IsActive, Id, SourceSystemId, IsDeleted)
</span></span></span><span class="line"><span class="cl"><span class="cp">;]]&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/query&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Dataset&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;Dataset</span> <span class="na">name=</span><span class="s">&#34;Empty table test: actual dataset&#34;</span> <span class="na">connection=</span><span class="s">&#34;ssisUnitLearningDB&#34;</span> <span class="na">isResultsStored=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;query&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="cp">&lt;![CDATA[SELECT
</span></span></span><span class="line"><span class="cl"><span class="cp">    Name,
</span></span></span><span class="line"><span class="cl"><span class="cp">    Login,
</span></span></span><span class="line"><span class="cl"><span class="cp">    IsActive,
</span></span></span><span class="line"><span class="cl"><span class="cp">    SourceId,
</span></span></span><span class="line"><span class="cl"><span class="cp">    SourceSystemId,
</span></span></span><span class="line"><span class="cl"><span class="cp">    IsDeleted
</span></span></span><span class="line"><span class="cl"><span class="cp">FROM dbo.Users
</span></span></span><span class="line"><span class="cl"><span class="cp">;]]&gt;</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&lt;/query&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;/Dataset&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/DatasetList&gt;</span>
</span></span></code></pre></div><p>To use the dataset in the test use <em>Add Command / DatasetCommand</em> on the right-click menu on the Assert node. Use the created expected and actual datasets and leave <em>TaskResult</em> as Success.</p>
<p><a class="link" href="images/Datasets.png" >
  
  <p style="text-align: center;">
    <img src="images/Datasets.png"
	
	
	
	loading="lazy"
	
		alt="Datasets"
	
	
>
  </p>

</a></p>
<p>The whole test looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;Test</span> <span class="na">name=</span><span class="s">&#34;SQL MERGE Users: Empty table&#34;</span> <span class="na">package=</span><span class="s">&#34;15_Users_Dataset&#34;</span> <span class="na">task=</span><span class="s">&#34;{FB549B65-6F0D-4794-BA8E-3FF975A6AE0B}&#34;</span> <span class="na">taskResult=</span><span class="s">&#34;Success&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;TestSetup&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;SqlCommand</span> <span class="na">name=</span><span class="s">&#34;SqlCommand: setup stg.Users&#34;</span> <span class="na">connectionRef=</span><span class="s">&#34;ssisUnitLearningDB&#34;</span> <span class="na">returnsValue=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>WITH stgUsers AS (
</span></span><span class="line"><span class="cl">SELECT *
</span></span><span class="line"><span class="cl">FROM (
</span></span><span class="line"><span class="cl">    VALUES
</span></span><span class="line"><span class="cl">        (&#39;Name 1&#39;, &#39;Login 1&#39;, 1, 1, 2, -1),
</span></span><span class="line"><span class="cl">        (&#39;Name 2&#39;, &#39;Login 2&#39;, 1, 2, 2, -1),
</span></span><span class="line"><span class="cl">        (&#39;Name 3&#39;, &#39;Login 3&#39;, 0, 3, 2, -1)
</span></span><span class="line"><span class="cl">)x (Name, Login, IsActive, Id, SourceSystemId, InsertedAuditId)
</span></span><span class="line"><span class="cl">)
</span></span><span class="line"><span class="cl">INSERT INTO stg.Users (
</span></span><span class="line"><span class="cl">    Name, Login, IsActive, Id, SourceSystemId, InsertedAuditId
</span></span><span class="line"><span class="cl">)
</span></span><span class="line"><span class="cl">SELECT
</span></span><span class="line"><span class="cl">    Name, Login, IsActive, Id, SourceSystemId, InsertedAuditId
</span></span><span class="line"><span class="cl">FROM stgUsers
</span></span><span class="line"><span class="cl">;<span class="nt">&lt;/SqlCommand&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/TestSetup&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Assert</span> <span class="na">name=</span><span class="s">&#34;Assert: Added 3 records&#34;</span> <span class="na">expectedResult=</span><span class="s">&#34;3&#34;</span> <span class="na">testBefore=</span><span class="s">&#34;false&#34;</span> <span class="na">expression=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;SqlCommand</span> <span class="na">name=</span><span class="s">&#34;&#34;</span> <span class="na">connectionRef=</span><span class="s">&#34;ssisUnitLearningDB&#34;</span> <span class="na">returnsValue=</span><span class="s">&#34;true&#34;</span><span class="nt">&gt;</span>SELECT COUNT(*) FROM dbo.Users;<span class="nt">&lt;/SqlCommand&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Assert&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;Assert</span> <span class="na">name=</span><span class="s">&#34;Assert: dbo.Users has expected records&#34;</span> <span class="na">expectedResult=</span><span class="s">&#34;True&#34;</span> <span class="na">testBefore=</span><span class="s">&#34;false&#34;</span> <span class="na">expression=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;DataCompareCommand</span> <span class="na">name=</span><span class="s">&#34;&#34;</span> <span class="na">expected=</span><span class="s">&#34;Empty table test: expected dataset&#34;</span> <span class="na">actual=</span><span class="s">&#34;Empty table test: actual dataset&#34;</span> <span class="nt">/&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/Assert&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;TestTeardown&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;SqlCommand</span> <span class="na">name=</span><span class="s">&#34;SqlCommand: TRUNCATE stg.Users&#34;</span> <span class="na">connectionRef=</span><span class="s">&#34;ssisUnitLearningDB&#34;</span> <span class="na">returnsValue=</span><span class="s">&#34;false&#34;</span><span class="nt">&gt;</span>TRUNCATE TABLE stg.users;<span class="nt">&lt;/SqlCommand&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/TestTeardown&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/Test&gt;</span>
</span></span></code></pre></div><p>Save the test and hit the <em>Run</em> button.</p>
<p>The test failed</p>
<p><em>The actual result (False) did not match the expected result (True).</em> <em>3 rows differ between the expected &ldquo;Empty table test: expected dataset&rdquo; and actual &ldquo;Empty table test: actual dataset&rdquo; datasets.</em></p>
<h2 id="tuning-the-test">Tuning the test
</h2><p>There are few things to have in mind when preparing the datasets:</p>
<ul>
<li>the dataset compare checks the data AND the data types</li>
<li>if you don&rsquo;t specify ORDER BY, most of the times you don&rsquo;t get the required order</li>
</ul>
<p>When you check the datatypes of the expected and actual datasets you will see the difference:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">EXEC</span><span class="w"> </span><span class="n">sp_describe_first_result_set</span><span class="w"> </span><span class="n">N</span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">SELECT *
</span></span></span><span class="line"><span class="cl"><span class="s1">FROM (
</span></span></span><span class="line"><span class="cl"><span class="s1">    VALUES
</span></span></span><span class="line"><span class="cl"><span class="s1">        (&#39;&#39;Name 1&#39;&#39;, &#39;&#39;Login 1&#39;&#39;, 1, 1, 2, 0),
</span></span></span><span class="line"><span class="cl"><span class="s1">        (&#39;&#39;Name 2&#39;&#39;, &#39;&#39;Login 2&#39;&#39;, 1, 2, 2, 0),
</span></span></span><span class="line"><span class="cl"><span class="s1">        (&#39;&#39;Name 3&#39;&#39;, &#39;&#39;Login 3&#39;&#39;, 0, 3, 2, 0)
</span></span></span><span class="line"><span class="cl"><span class="s1">)x (Name, Login, IsActive, Id, SourceSystemId, IsDeleted)
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXEC</span><span class="w"> </span><span class="n">sp_describe_first_result_set</span><span class="w"> </span><span class="n">N</span><span class="s1">&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">SELECT
</span></span></span><span class="line"><span class="cl"><span class="s1">    Name,
</span></span></span><span class="line"><span class="cl"><span class="s1">    Login,
</span></span></span><span class="line"><span class="cl"><span class="s1">    IsActive,
</span></span></span><span class="line"><span class="cl"><span class="s1">    SourceId,
</span></span></span><span class="line"><span class="cl"><span class="s1">    SourceSystemId,
</span></span></span><span class="line"><span class="cl"><span class="s1">    IsDeleted
</span></span></span><span class="line"><span class="cl"><span class="s1">FROM dbo.Users;
</span></span></span><span class="line"><span class="cl"><span class="s1">&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="table-wrapper"><table>
<thead>
<tr>
<th style="text-align:center">Column</th>
<th style="text-align:center">Type (expected)</th>
<th style="text-align:center">Type (actual)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Name</td>
<td style="text-align:center">VARCHAR(6)</td>
<td style="text-align:center">VARCHAR(50)</td>
</tr>
<tr>
<td style="text-align:center">Login</td>
<td style="text-align:center">VARCHAR(7)</td>
<td style="text-align:center">CHAR(12)</td>
</tr>
<tr>
<td style="text-align:center">IsActive</td>
<td style="text-align:center">INT</td>
<td style="text-align:center">BIT</td>
</tr>
<tr>
<td style="text-align:center">SourceId</td>
<td style="text-align:center">INT</td>
<td style="text-align:center">INT</td>
</tr>
<tr>
<td style="text-align:center">SourceSystemId</td>
<td style="text-align:center">INT</td>
<td style="text-align:center">TINYINT</td>
</tr>
<tr>
<td style="text-align:center">IsDeleted</td>
<td style="text-align:center">INT</td>
<td style="text-align:center">BIT</td>
</tr>
</tbody>
</table></div>
<p>Change the expected dataset to match the data types:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">VALUES</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;Name 1&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;Login 1&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">12</span><span class="p">)),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">BIT</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">TINYINT</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">BIT</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;Name 2&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;Login 2&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">12</span><span class="p">)),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">BIT</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">TINYINT</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">BIT</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;Name 3&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="s1">&#39;Login 3&#39;</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">CHAR</span><span class="p">(</span><span class="mi">12</span><span class="p">)),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">BIT</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">INT</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">TINYINT</span><span class="p">),</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="mi">0</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="nb">BIT</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="n">Name</span><span class="p">,</span><span class="w"> </span><span class="n">Login</span><span class="p">,</span><span class="w"> </span><span class="n">IsActive</span><span class="p">,</span><span class="w"> </span><span class="n">Id</span><span class="p">,</span><span class="w"> </span><span class="n">SourceSystemId</span><span class="p">,</span><span class="w"> </span><span class="n">IsDeleted</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">Id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>And add an <code>ORDER BY</code> clause to the actual dataset:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Name</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Login</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">IsActive</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SourceId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">SourceSystemId</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">IsDeleted</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">dbo</span><span class="p">.</span><span class="n">Users</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">SourceId</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>Now the test should pass.</p>
<p>So, when using datasets:</p>
<ul>
<li>create the connections to the database</li>
<li>prepare expected and actual datasets with some T-SQL code</li>
<li>make sure the data types in expected and actual sets match (use CAST and CONVERT if necessary)</li>
<li>use ORDER BY</li>
<li>make sure that the expected and actual datasets have the same number of rows</li>
</ul>
<p>In the next post, I will show you how to persist the datasets in the test file and use the <code>IsResultStored</code> flag.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/ssis/">SSIS</a>
        
            <a href="/tags/ssisunit/">SsisUnit</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/2018/04/13/testing-database-connections-with-ssisunit/">
        
        
            <div class="article-image">
                
                    <img src="/2018/04/13/testing-database-connections-with-ssisunit/images/PackageOutline.png" loading="lazy" data-key="" data-hash="/2018/04/13/testing-database-connections-with-ssisunit/images/PackageOutline.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Testing database connections with ssisUnit</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/2018/03/26/writing-first-tests-with-ssisunit/">
        
        
            <div class="article-image">
                
                    <img src="/2018/03/19/testing-ssis-projects-with-ssisunit/images/ssisUnit_HeaderImage.png" loading="lazy" data-key="" data-hash="/2018/03/19/testing-ssis-projects-with-ssisunit/images/ssisUnit_HeaderImage.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Writing first tests with ssisUnit</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/2018/03/19/testing-ssis-projects-with-ssisunit/">
        
        
            <div class="article-image">
                
                    <img src="/2018/03/19/testing-ssis-projects-with-ssisunit/images/ssisUnit_HeaderImage.png" loading="lazy" data-key="" data-hash="/2018/03/19/testing-ssis-projects-with-ssisunit/images/ssisUnit_HeaderImage.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Testing SSIS Projects with ssisUnit</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/2018/02/28/upgrading-ssis-projects-part-iii/">
        
        
            <div class="article-image">
                
                    <img src="/2017/12/24/upgrading-ssis-projects-part-i/images/TargetServerVersion2017.png" loading="lazy" data-key="" data-hash="/2017/12/24/upgrading-ssis-projects-part-i/images/TargetServerVersion2017.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Upgrading SSIS projects - part III</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/2018/02/04/upgrading-ssis-projects-part-ii/">
        
        
            <div class="article-image">
                
                    <img src="/2018/02/04/upgrading-ssis-projects-part-ii/images/Debugging.png" loading="lazy" data-key="" data-hash="/2018/02/04/upgrading-ssis-projects-part-ii/images/Debugging.png"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Upgrading SSIS projects, part II</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo="BartekR/bartekr.github.io"
        issue-term="url"
        
        label="blog-comment"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2017 - 
        
        2024 BartekR
    </section>
    
    <section class="powerby">
        
            (c) Bartosz Ratajczyk <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
