<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<title>Using Connections and Datasets in ssisUnit - BartekR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="generator" content="Hugo 0.76.5" /><meta property="og:site_name" content="BartekR">
  <meta property="og:title" content="Using Connections and Datasets in ssisUnit">
  <meta property="og:description" content="BartekR blog. Previously known as String or binary data would be truncated">
  <meta property="description" content="BartekR blog. Previously known as String or binary data would be truncated">
  <meta property="og:url" content="https://blog.bartekr.net/2018/04/30/using-connections-and-datasets-in-ssisunit/">
  <meta property="og:type" content="article">
  
    
      <meta property="og:image" content="https://blog.bartekr.net/2018/04/30/using-connections-and-datasets-in-ssisunit/images/Dataset.png">
      <meta property="og:image:alt" content="">
    
  
  
            <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/vs2015.min.css">
          <link rel="stylesheet" href="/css/bundle.min.307f33cd8015e5bab28d6ebda9b400f8d3059bc248b4e60adf4d23469fab5a2b.css" integrity="sha256-MH8zzYAV5bqyjW69qbQA&#43;NMFm8JItOYK300jRp&#43;rWis="><link rel="stylesheet" href="/css/add-on.css">
</head>

  <body>
    

<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/" class="nav">
        
          BartekR blog
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu menu">
      
        
          
          <a href="/about" class="nav link"><i class='far fa-id-card'></i> About</a>
        
      
        
          
          <a href="https://brinf.wordpress.com" class="nav link"><i class='fab fa-wordpress'></i> Blog [PL]</a>
        
      
        
          
          <a href="/books" class="nav link"><i class='fas fa-book-reader'></i> Books</a>
        
      
        
          
          <a href="/series" class="nav link"><i class='fas fa-newspaper'></i> Series</a>
        
      
        
          
          <a href="/speaking" class="nav link"><i class='fas fa-microphone-alt'></i> Speaking</a>
        
      
      
      <a href="#search-input" class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a>
    </menu>
    <a href="#search-input" class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
    
    <a href="#lang-menu" class="nav lang-toggle" lang="en">en</a>
    <a href="#site-nav" class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  <menu id="search" class="menu"><input id="search-input" class="search-input menu"></input><div id="search-results" class="search-results menu"></div></menu>
  <menu id="lang-menu" class="flyout-menu menu">
  <a href="#" lang="en" class="nav link active"> (en)</a>
  
    
      
    
  
</menu>

  
</header>

    <div id="wrapper">
      <section id="site-intro" class="hidden-single-column">
  <a href="/"><img src="https://blog.bartekr.net/img/main/Bartek_SqlSatOslo2019_100x100.png" class="circle" width="100" alt="BartekR profile pic" /></a>
  <header>
    <h1>BartekR</h1>
  </header>
  <main>
    <p>SQL Server. SSIS. PowerShell. Azure.<br/>1 wife. 1 daughter.3 dogs. 9 cats.</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        

        <li><a href="//github.com/BartekR" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//www.linkedin.com/in/bartoszratajczyk" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/b_ratajczyk" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>













      </ul>
    </footer>
  
</section>

      <main id="site-main">
        
  <article class="post">
    <header>
  <div class="title">
    
      <h2><a href="/2018/04/30/using-connections-and-datasets-in-ssisunit/">Using Connections and Datasets in ssisUnit</a></h2>
    
    
  </div>
  <div class="meta">
    <time datetime="2018-04-30 00:00:00 &#43;0000 UTC">April 30, 2018</time>
    
    
  </div>
</header>

    <div id="socnet-share">
      





    </div>
    <div class="content">
      <a href="/2018/04/30/using-connections-and-datasets-in-ssisunit/" class="image" style="--bg-image: url('https://blog.bartekr.net/2018/04/30/using-connections-and-datasets-in-ssisunit/images/Dataset.png');">
    <img src="https://blog.bartekr.net/2018/04/30/using-connections-and-datasets-in-ssisunit/images/Dataset.png" alt="">
  </a>
      <p>One of the elements you can define in ssisUnit is a Dataset. In this post of the <a href="http://blog.bartekr.net/series/">ssisUnit series</a>, I will show you how to prepare and use it later in a test.</p>
<p><a href="images/Dataset.png"><img src="images/Dataset.png#center" alt="Dataset"></a></p>
<h2 id="the-dataset">The Dataset</h2>
<p>As you can see in the image above, <strong>the dataset is a named result that contains data</strong>. It has five attributes (although you can see just four of them in the GUI):</p>
<ul>
<li><em>Name</em> (required) - the name of the dataset, used for referencing the dataset in a test</li>
<li><em>IsResultsStored</em> (required) - the boolean flag informing if we have the results cached (true) or we always ask the external source (false)</li>
<li><em>Connection</em> (required) - the connection reference for the dataset retrieval</li>
<li><em>Query</em> (optional) - the query for the dataset definition</li>
<li><em>Results</em> (optional) - the cached dataset (not available in the GUI)</li>
</ul>
<p>You can find all of the attributes in the <code>SsisUnit.xsd</code> file in the source code.</p>
<p>Why would you use the dataset? Verifying the numbers is almost always enough, but I have the cases I have to check the actual data after the processing. Like testing the SCD1 or SCD2 attributes, verifying the <code>MERGE</code> statements, checking <code>UPDATE</code>s on the data. I prepare a small reference data and compare it using <code>DataCompareCommand</code>.</p>
<figure class="noborder">
    <img src="images/Datasets.png#center"
         alt="The goal: compare data in the table (actual data) with the reference data (expected data)"/> <figcaption>
            <p>The goal: compare data in the table (actual data) with the reference data (expected data)</p>
        </figcaption>
</figure>

<h2 id="the-scenario">The scenario</h2>
<p>I will test loading users data from the staging table to the destination table. I have the <code>stg.Users</code> table with the information from the source system, and I want to transfer it to the <code>dbo.Users</code> table using the rules:</p>
<ul>
<li>the natural key in <code>dbo.Users</code> is (<code>SourceId, SourceSystemId</code>)</li>
<li>the natural key in <code>stg.Users</code> is (<code>Id, SourceSystemId</code>)</li>
<li>if the record from <code>stg.Users</code> is not in <code>dbo.Users</code>, then add it</li>
<li>if the record exists in <code>dbo.Users</code> and has different data than the record in <code>stg.Users</code>, then update it</li>
<li>if the record exists in <code>dbo.Users</code> and doesn&rsquo;t exist in <code>stg.Users</code> - mark it as deleted (<code>IsDeleted</code> = 1)</li>
<li>when the new record is inserted, the columns <code>InsertedAuditId</code> and <code>UpdatedAuditId</code> have the same value</li>
<li>when the record is updated, the column <code>UpdateAuditId</code> is updated, and <code>UpdateAuditId</code> &gt; <code>InsertedAuditId</code></li>
<li>only the records with the changed attributes get an update</li>
</ul>
<p>I will use the <code>MERGE</code> statement for the data loading process. In the package I will also use two _SQL Task_s for auditing. I have <code>meta.Audit</code> table for tracking the executions of the packages and I use <code>meta.uspPackageStart</code> and <code>meta.uspPackageFinish</code> stored procedures to insert and update the audit data. The package looks like in the picture below.</p>
<p><a href="images/15_Users_Dataset.png"><img src="images/15_Users_Dataset.png#center" alt="Users dataset"></a></p>
<p>I will define the tests to run later in the post.</p>
<h2 id="defining-the-ssisunit-connections">Defining the ssisUnit connections</h2>
<p>One of the dataset&rsquo;s attributes is a <em>Connection</em>. It&rsquo;s not any of the connections defined within the SSIS package or the project. It&rsquo;s the connection defined in the ssisUnit test suite.</p>
<p><a href="images/Connection.png"><img src="images/Connection.png#center" alt="ssisUnit connection"></a></p>
<p>The connection has four attributes:</p>
<ul>
<li><em>Connection string</em> - the connection string to the external source</li>
<li><em>Connection type</em> - the type of the connection (supported types: <em>ConnectionString</em> and <em>Ado.Net</em>)</li>
<li><em>Invariant type</em> - the type of the <em>Ado.Net</em> provider (when used)</li>
<li>Reference <em>name</em> - the name of the connection to use in <code>SqlCommand</code> or <code>DatasetCommand</code></li>
</ul>
<p>I use a Connection string for the database communication. When you add a new connection, you have only the text box for entering the connection string, or you can pick the provider to enter all the data.</p>
<p><a href="images/DefineConnectionString.png"><img src="images/DefineConnectionString.png#center" alt="Define connection string"></a></p>
<p>After you fill the connection information, the wizard detects the type and displays them in the proper format.</p>
<p><a href="images/ConnectionString_OleDbProvider.png"><img src="images/ConnectionString_OleDbProvider.png#center" alt="Connection string for OLEDB provider"></a></p>
<p>The connection reference should be ready to use. But when you try to use it in the <code>SqlCommand</code> right after creating it you will see the error:</p>
<p><a href="images/ConnectionRefError.png"><img src="images/ConnectionRefError.png#center" alt="ConnectionRef eror"></a></p>
<p>It&rsquo;s not a ssisUnit problem, but the GUI problem - it has some issues with refreshing the object information. Just save the test, open it again, and everything will work fine.</p>
<h2 id="the-test-the-setup-the-teardown">The test, the setup, the teardown</h2>
<p>Now you can use SQL commands to query the database about the data. You can also prepare and destroy data before and after the test during the setup and teardown phases. But first - the test itself. Create a new test <em>SQL MERGE Users: Empty table</em> using the <em>SQL MERGE Users</em> task. Now create the <code>SqlCommand</code> in the <em>TestSetup</em> node using right-click, and add the following code to setup <code>stg.Users</code> data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">WITH</span> stgUsers <span style="color:#66d9ef">AS</span> (
<span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>
<span style="color:#66d9ef">FROM</span> (
    <span style="color:#66d9ef">VALUES</span>
        (<span style="color:#e6db74">&#39;Name 1&#39;</span>, <span style="color:#e6db74">&#39;Login 1&#39;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),
        (<span style="color:#e6db74">&#39;Name 2&#39;</span>, <span style="color:#e6db74">&#39;Login 2&#39;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),
        (<span style="color:#e6db74">&#39;Name 3&#39;</span>, <span style="color:#e6db74">&#39;Login 3&#39;</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">2</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
)x (Name, Login, IsActive, Id, SourceSystemId, InsertedAuditId)
)
<span style="color:#66d9ef">INSERT</span> <span style="color:#66d9ef">INTO</span> stg.Users (
    Name, Login, IsActive, Id, SourceSystemId, InsertedAuditId
)
<span style="color:#66d9ef">SELECT</span>
    Name, Login, IsActive, Id, SourceSystemId, InsertedAuditId
<span style="color:#66d9ef">FROM</span> stgUsers
;
</code></pre></div><p>You should have something like in the picture below:</p>
<p><a href="images/TestSetupSqlCommand.png"><img src="images/TestSetupSqlCommand.png#center" alt="Test setup - SQL command"></a></p>
<p>As you can see - the GUI has a feature of not displaying the name of the command in the test tree on the left.</p>
<p>As there is a code to set up the test I also have the code to tidy up after. I use two <code>TRUNCATE TABLE</code> commands to clean up the <code>stg.Users</code> and <code>dbo.Users</code> tables.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;SqlCommand</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;SqlCommand: TRUNCATE stg.Users&#34;</span> <span style="color:#a6e22e">connectionRef=</span><span style="color:#e6db74">&#34;ssisUnitLearningDB&#34;</span> <span style="color:#a6e22e">returnsValue=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">&gt;</span>TRUNCATE TABLE stg.Users;<span style="color:#f92672">&lt;/SqlCommand&gt;</span>
<span style="color:#f92672">&lt;SqlCommand</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;SqlCommand: TRUNCATE dbo.Users&#34;</span> <span style="color:#a6e22e">connectionRef=</span><span style="color:#e6db74">&#34;ssisUnitLearningDB&#34;</span> <span style="color:#a6e22e">returnsValue=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">&gt;</span>TRUNCATE TABLE dbo.Users;<span style="color:#f92672">&lt;/SqlCommand&gt;</span>
</code></pre></div><h2 id="the-test-cases">The test cases</h2>
<p>There are a few test cases I want to run for the scenario mentioned above. I will cover them in this and following posts:</p>
<ul>
<li>the <code>stg.Users</code> table contains the data, and the <code>dbo.Users</code> table is empty</li>
<li>the <code>stg.Users</code> table has the data, that does not exist in the <code>dbo.Users</code> table and <code>dbo.Users</code> table is not empty</li>
<li>the <code>stg.Users</code> table is not empty but lacks some records from the <code>dbo.Users</code> table</li>
<li>the <code>stg.Users</code> table is empty and the <code>dbo.Users</code> table is not empty</li>
</ul>
<p>Within those test cases I want to check:</p>
<ul>
<li>the number of records loaded to <code>dbo.Users</code></li>
<li>if the attributes are same in <code>stg.Users</code> and <code>dbo.Users</code></li>
<li>if <code>InsertedAuditId</code> is equal to <code>UpdatedAuditId</code> or greater when appropriate</li>
<li>if every required record marked with <code>IsDeleted</code> = 1</li>
</ul>
<p>This time I will not use the variables to hold the results. I will run separate SQL statements to verify the count of the records in the table and write expected and actual datasets code to verify if they match. I will focus on the dataset part.</p>
<p>I will load three records to the <code>stg.Users</code> table (with the T-SQL code above) and process them with the package. Then I will check if these records are loaded to the <code>dbo.Users</code> table and if they have the same values (excluding audits and the <code>Id</code> column). To verify I will use just the <code>SELECT</code> statement from the code above as the reference data and compare it to the <code>SELECT</code> statement on <code>dbo.Users</code> table.</p>
<h2 id="creating-and-using-the-datasets-finally">Creating and using the datasets (finally!)</h2>
<p>To create the dataset go to the <em>Datasets</em> node, right-click, and select <em>Add Dataset</em>. Prepare two datasets: <em>Empty table test: expected dataset</em> and <em>Empty table test: actual dataset</em>. At the beginning try to be very descriptive, it helps with getting familiar with the terminology and the process.</p>
<p>For the expected dataset use the T-SQL code above changing <code>InsertAuditId</code> = -1  column to <code>IsDeleted</code> = 0, set the <em>ssisUnitLearningDB</em> connection prepared in the previous steps and leave <em>IsResultsStored</em> flag as <em>false</em>. For the actual dataset use a <code>SELECT</code> query on the <code>dbo.Users</code> table. You should get the code similar to this one:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;DatasetList&gt;</span>
    <span style="color:#f92672">&lt;Dataset</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Empty table test: expected dataset&#34;</span> <span style="color:#a6e22e">connection=</span><span style="color:#e6db74">&#34;ssisUnitLearningDB&#34;</span> <span style="color:#a6e22e">isResultsStored=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;query&gt;</span>
        <span style="color:#75715e">&lt;![CDATA[SELECT *
</span><span style="color:#75715e">FROM (
</span><span style="color:#75715e">    VALUES
</span><span style="color:#75715e">        (&#39;Name 1&#39;, &#39;Login 1&#39;, 1, 1, 2, 0),
</span><span style="color:#75715e">        (&#39;Name 2&#39;, &#39;Login 2&#39;, 1, 2, 2, 0),
</span><span style="color:#75715e">        (&#39;Name 3&#39;, &#39;Login 3&#39;, 0, 3, 2, 0)
</span><span style="color:#75715e">)x (Name, Login, IsActive, Id, SourceSystemId, IsDeleted)
</span><span style="color:#75715e">;]]&gt;</span>
        <span style="color:#f92672">&lt;/query&gt;</span>
    <span style="color:#f92672">&lt;/Dataset&gt;</span>
    <span style="color:#f92672">&lt;Dataset</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Empty table test: actual dataset&#34;</span> <span style="color:#a6e22e">connection=</span><span style="color:#e6db74">&#34;ssisUnitLearningDB&#34;</span> <span style="color:#a6e22e">isResultsStored=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;query&gt;</span>
        <span style="color:#75715e">&lt;![CDATA[SELECT
</span><span style="color:#75715e">    Name,
</span><span style="color:#75715e">    Login,
</span><span style="color:#75715e">    IsActive,
</span><span style="color:#75715e">    SourceId,
</span><span style="color:#75715e">    SourceSystemId,
</span><span style="color:#75715e">    IsDeleted
</span><span style="color:#75715e">FROM dbo.Users
</span><span style="color:#75715e">;]]&gt;</span>
        <span style="color:#f92672">&lt;/query&gt;</span>
    <span style="color:#f92672">&lt;/Dataset&gt;</span>
<span style="color:#f92672">&lt;/DatasetList&gt;</span>
</code></pre></div><p>To use the dataset in the test use <em>Add Command / DatasetCommand</em> on the right-click menu on the Assert node. Use the created expected and actual datasets and leave <em>TaskResult</em> as Success.</p>
<p><a href="images/Datasets.png"><img src="images/Datasets.png#center" alt="Datasets"></a></p>
<p>The whole test looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;Test</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;SQL MERGE Users: Empty table&#34;</span> <span style="color:#a6e22e">package=</span><span style="color:#e6db74">&#34;15_Users_Dataset&#34;</span> <span style="color:#a6e22e">task=</span><span style="color:#e6db74">&#34;{FB549B65-6F0D-4794-BA8E-3FF975A6AE0B}&#34;</span> <span style="color:#a6e22e">taskResult=</span><span style="color:#e6db74">&#34;Success&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;TestSetup&gt;</span>
    <span style="color:#f92672">&lt;SqlCommand</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;SqlCommand: setup stg.Users&#34;</span> <span style="color:#a6e22e">connectionRef=</span><span style="color:#e6db74">&#34;ssisUnitLearningDB&#34;</span> <span style="color:#a6e22e">returnsValue=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">&gt;</span>WITH stgUsers AS (
SELECT *
FROM (
    VALUES
        (&#39;Name 1&#39;, &#39;Login 1&#39;, 1, 1, 2, -1),
        (&#39;Name 2&#39;, &#39;Login 2&#39;, 1, 2, 2, -1),
        (&#39;Name 3&#39;, &#39;Login 3&#39;, 0, 3, 2, -1)
)x (Name, Login, IsActive, Id, SourceSystemId, InsertedAuditId)
)
INSERT INTO stg.Users (
    Name, Login, IsActive, Id, SourceSystemId, InsertedAuditId
)
SELECT
    Name, Login, IsActive, Id, SourceSystemId, InsertedAuditId
FROM stgUsers
;<span style="color:#f92672">&lt;/SqlCommand&gt;</span>
  <span style="color:#f92672">&lt;/TestSetup&gt;</span>
  <span style="color:#f92672">&lt;Assert</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Assert: Added 3 records&#34;</span> <span style="color:#a6e22e">expectedResult=</span><span style="color:#e6db74">&#34;3&#34;</span> <span style="color:#a6e22e">testBefore=</span><span style="color:#e6db74">&#34;false&#34;</span> <span style="color:#a6e22e">expression=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;SqlCommand</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">connectionRef=</span><span style="color:#e6db74">&#34;ssisUnitLearningDB&#34;</span> <span style="color:#a6e22e">returnsValue=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">&gt;</span>SELECT COUNT(*) FROM dbo.Users;<span style="color:#f92672">&lt;/SqlCommand&gt;</span>
  <span style="color:#f92672">&lt;/Assert&gt;</span>
  <span style="color:#f92672">&lt;Assert</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;Assert: dbo.Users has expected records&#34;</span> <span style="color:#a6e22e">expectedResult=</span><span style="color:#e6db74">&#34;True&#34;</span> <span style="color:#a6e22e">testBefore=</span><span style="color:#e6db74">&#34;false&#34;</span> <span style="color:#a6e22e">expression=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;DataCompareCommand</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;&#34;</span> <span style="color:#a6e22e">expected=</span><span style="color:#e6db74">&#34;Empty table test: expected dataset&#34;</span> <span style="color:#a6e22e">actual=</span><span style="color:#e6db74">&#34;Empty table test: actual dataset&#34;</span> <span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/Assert&gt;</span>
  <span style="color:#f92672">&lt;TestTeardown&gt;</span>
    <span style="color:#f92672">&lt;SqlCommand</span> <span style="color:#a6e22e">name=</span><span style="color:#e6db74">&#34;SqlCommand: TRUNCATE stg.Users&#34;</span> <span style="color:#a6e22e">connectionRef=</span><span style="color:#e6db74">&#34;ssisUnitLearningDB&#34;</span> <span style="color:#a6e22e">returnsValue=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">&gt;</span>TRUNCATE TABLE stg.users;<span style="color:#f92672">&lt;/SqlCommand&gt;</span>
  <span style="color:#f92672">&lt;/TestTeardown&gt;</span>
<span style="color:#f92672">&lt;/Test&gt;</span>
</code></pre></div><p>Save the test and hit the <em>Run</em> button.</p>
<p>The test failed</p>
<p><em>The actual result (False) did not match the expected result (True).</em> <em>3 rows differ between the expected &ldquo;Empty table test: expected dataset&rdquo; and actual &ldquo;Empty table test: actual dataset&rdquo; datasets.</em></p>
<h2 id="tuning-the-test">Tuning the test</h2>
<p>There are few things to have in mind when preparing the datasets:</p>
<ul>
<li>the dataset compare checks the data AND the data types</li>
<li>if you don&rsquo;t specify ORDER BY, most of the times you don&rsquo;t get the required order</li>
</ul>
<p>When you check the datatypes of the expected and actual datasets you will see the difference:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">EXEC</span> sp_describe_first_result_set N<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">SELECT *
</span><span style="color:#e6db74">FROM (
</span><span style="color:#e6db74">    VALUES
</span><span style="color:#e6db74">        (&#39;&#39;Name 1&#39;&#39;, &#39;&#39;Login 1&#39;&#39;, 1, 1, 2, 0),
</span><span style="color:#e6db74">        (&#39;&#39;Name 2&#39;&#39;, &#39;&#39;Login 2&#39;&#39;, 1, 2, 2, 0),
</span><span style="color:#e6db74">        (&#39;&#39;Name 3&#39;&#39;, &#39;&#39;Login 3&#39;&#39;, 0, 3, 2, 0)
</span><span style="color:#e6db74">)x (Name, Login, IsActive, Id, SourceSystemId, IsDeleted)
</span><span style="color:#e6db74">&#39;</span>;

<span style="color:#66d9ef">EXEC</span> sp_describe_first_result_set N<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">    Name,
</span><span style="color:#e6db74">    Login,
</span><span style="color:#e6db74">    IsActive,
</span><span style="color:#e6db74">    SourceId,
</span><span style="color:#e6db74">    SourceSystemId,
</span><span style="color:#e6db74">    IsDeleted
</span><span style="color:#e6db74">FROM dbo.Users;
</span><span style="color:#e6db74">&#39;</span>;
</code></pre></div><table>
<thead>
<tr>
<th style="text-align:center">Column</th>
<th style="text-align:center">Type (expected)</th>
<th style="text-align:center">Type (actual)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Name</td>
<td style="text-align:center">VARCHAR(6)</td>
<td style="text-align:center">VARCHAR(50)</td>
</tr>
<tr>
<td style="text-align:center">Login</td>
<td style="text-align:center">VARCHAR(7)</td>
<td style="text-align:center">CHAR(12)</td>
</tr>
<tr>
<td style="text-align:center">IsActive</td>
<td style="text-align:center">INT</td>
<td style="text-align:center">BIT</td>
</tr>
<tr>
<td style="text-align:center">SourceId</td>
<td style="text-align:center">INT</td>
<td style="text-align:center">INT</td>
</tr>
<tr>
<td style="text-align:center">SourceSystemId</td>
<td style="text-align:center">INT</td>
<td style="text-align:center">TINYINT</td>
</tr>
<tr>
<td style="text-align:center">IsDeleted</td>
<td style="text-align:center">INT</td>
<td style="text-align:center">BIT</td>
</tr>
</tbody>
</table>
<p>Change the expected dataset to match the data types:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">*</span>
<span style="color:#66d9ef">FROM</span> (
    <span style="color:#66d9ef">VALUES</span>
        (<span style="color:#66d9ef">CAST</span>(<span style="color:#e6db74">&#39;Name 1&#39;</span> <span style="color:#66d9ef">AS</span> VARCHAR(<span style="color:#ae81ff">50</span>)), <span style="color:#66d9ef">CAST</span>(<span style="color:#e6db74">&#39;Login 1&#39;</span> <span style="color:#66d9ef">AS</span> CHAR(<span style="color:#ae81ff">12</span>)), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">AS</span> BIT), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">AS</span> INT), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">2</span> <span style="color:#66d9ef">AS</span> TINYINT), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">AS</span> BIT)),
        (<span style="color:#66d9ef">CAST</span>(<span style="color:#e6db74">&#39;Name 2&#39;</span> <span style="color:#66d9ef">AS</span> VARCHAR(<span style="color:#ae81ff">50</span>)), <span style="color:#66d9ef">CAST</span>(<span style="color:#e6db74">&#39;Login 2&#39;</span> <span style="color:#66d9ef">AS</span> CHAR(<span style="color:#ae81ff">12</span>)), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">1</span> <span style="color:#66d9ef">AS</span> BIT), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">2</span> <span style="color:#66d9ef">AS</span> INT), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">2</span> <span style="color:#66d9ef">AS</span> TINYINT), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">AS</span> BIT)),
        (<span style="color:#66d9ef">CAST</span>(<span style="color:#e6db74">&#39;Name 3&#39;</span> <span style="color:#66d9ef">AS</span> VARCHAR(<span style="color:#ae81ff">50</span>)), <span style="color:#66d9ef">CAST</span>(<span style="color:#e6db74">&#39;Login 3&#39;</span> <span style="color:#66d9ef">AS</span> CHAR(<span style="color:#ae81ff">12</span>)), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">AS</span> BIT), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">3</span> <span style="color:#66d9ef">AS</span> INT), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">2</span> <span style="color:#66d9ef">AS</span> TINYINT), <span style="color:#66d9ef">CAST</span>(<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">AS</span> BIT))
)x (Name, Login, IsActive, Id, SourceSystemId, IsDeleted)
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> Id;
</code></pre></div><p>And add an <code>ORDER BY</code> clause to the actual dataset:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span>
    Name,
    Login,
    IsActive,
    SourceId,
    SourceSystemId,
    IsDeleted
<span style="color:#66d9ef">FROM</span> dbo.Users
<span style="color:#66d9ef">ORDER</span> <span style="color:#66d9ef">BY</span> SourceId;
</code></pre></div><p>Now the test should pass.</p>
<p>So, when using datasets:</p>
<ul>
<li>create the connections to the database</li>
<li>prepare expected and actual datasets with some T-SQL code</li>
<li>make sure the data types in expected and actual sets match (use CAST and CONVERT if necessary)</li>
<li>use ORDER BY</li>
<li>make sure that the expected and actual datasets have the same number of rows</li>
</ul>
<p>In the next post, I will show you how to persist the datasets in the test file and use the <code>IsResultStored</code> flag.</p>

    </div>
    <footer>
      <div class="stats">
  
    <ul class="categories">
      
        
          <li><a class="article-terms-link" href="/categories/series/">Series</a></li>
        
          <li><a class="article-terms-link" href="/categories/testing/">Testing</a></li>
        
          <li><a class="article-terms-link" href="/categories/learning/">Learning</a></li>
        
      
    </ul>
  
  
    <ul class="tags">
      
        
          <li><a class="article-terms-link" href="/tags/ssis/">SSIS</a></li>
        
          <li><a class="article-terms-link" href="/tags/ssisunit/">ssisUnit</a></li>
        
      
    </ul>
  
</div>

    </footer>
  </article>
  
    <script src="https://utteranc.es/client.js"
        repo="BartekR/bartekr.github.io"
        issue-term="url"
        label="blog-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
  
  <div class="pagination">
    
      <a href="/2018/05/31/using-cached-datasets-in-ssisunit/" class="button left"><span>Using cached datasets in ssisUnit</span></a>
    
    
      <a href="/2018/04/13/testing-database-connections-with-ssisunit/" class="button right"><span>Testing database connections with ssisUnit</span></a>
    
  </div>

      </main>
      <section id="site-sidebar">
  
    <section id="recent-posts">
      <header>
        <h1>Recent Posts</h1>
      </header>
      
      <article class="mini-post">
          <a href="/2021/02/28/build-yourself-a-web-app-in-azure/" class="image" style="--bg-image: url('https://blog.bartekr.net/2021/02/28/build-yourself-a-web-app-in-azure/images/basic-web-app.png');">
    <img src="https://blog.bartekr.net/2021/02/28/build-yourself-a-web-app-in-azure/images/basic-web-app.png" alt="">
  </a>
        <header>
          <h2><a href="/2021/02/28/build-yourself-a-web-app-in-azure/">Build Yourself a Web App in Azure</a></h2>
          <time class="published" datetime="2021-02-28 00:00:00 &#43;0000 UTC">February 28, 2021</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2021/01/17/testing-utterances-comments/" class="image" style="--bg-image: url('https://blog.bartekr.net/2021/01/17/testing-utterances-comments/images/utterances.png');">
    <img src="https://blog.bartekr.net/2021/01/17/testing-utterances-comments/images/utterances.png" alt="">
  </a>
        <header>
          <h2><a href="/2021/01/17/testing-utterances-comments/">Testing Utterances Comments</a></h2>
          <time class="published" datetime="2021-01-17 00:00:00 &#43;0000 UTC">January 17, 2021</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2020/12/31/advent-of-code-2020/" class="image" style="--bg-image: url('https://blog.bartekr.net/2020/12/31/advent-of-code-2020/images/AoC.png');">
    <img src="https://blog.bartekr.net/2020/12/31/advent-of-code-2020/images/AoC.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/12/31/advent-of-code-2020/">Advent of Code 2020</a></h2>
          <time class="published" datetime="2020-12-31 00:00:00 &#43;0000 UTC">December 31, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2020/12/28/migrating-to-github-pages-with-hugo/" class="image" style="--bg-image: url('https://blog.bartekr.net/2020/11/01/migrating-to-github-pages/images/GitHubPages.png');">
    <img src="https://blog.bartekr.net/2020/11/01/migrating-to-github-pages/images/GitHubPages.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/12/28/migrating-to-github-pages-with-hugo/">Migrating to GitHub Pages with Hugo</a></h2>
          <time class="published" datetime="2020-12-28 00:00:00 &#43;0000 UTC">December 28, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2020/11/01/migrating-to-github-pages/" class="image" style="--bg-image: url('https://blog.bartekr.net/2020/11/01/migrating-to-github-pages/images/GitHubPages.png');">
    <img src="https://blog.bartekr.net/2020/11/01/migrating-to-github-pages/images/GitHubPages.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/11/01/migrating-to-github-pages/">Migrating to GitHub Pages</a></h2>
          <time class="published" datetime="2020-11-01 00:00:00 &#43;0000 UTC">November 1, 2020</time>
        </header>
      </article>
      
      
        <footer>
          <a href="/post/" class="button">See More</a>
        </footer>
      
    </section>
  

  
    

      <section id="categories">
        <header>
          <h1><a href="/categories">Categories</a></h1>
        </header>
        <ul>
          
          
          <li>
              <a href="/categories/learning/">learning<span class="count">16</span></a>
          
          <li>
              <a href="/categories/series/">series<span class="count">13</span></a>
          
          <li>
              <a href="/categories/testing/">testing<span class="count">11</span></a>
          
          <li>
              <a href="/categories/ssis-internals/">ssis-internals<span class="count">5</span></a>
          
          <li>
              <a href="/categories/admin/">admin<span class="count">2</span></a>
          
          <li>
              <a href="/categories/internals/">internals<span class="count">2</span></a>
          
          <li>
              <a href="/categories/programming/">programming<span class="count">2</span></a>
          
          <li>
              <a href="/categories/sql-server/">sql-server<span class="count">2</span></a>
          
          <li>
              <a href="/categories/troubleshooting/">troubleshooting<span class="count">2</span></a>
          
          <li>
              <a href="/categories/advent-of-code/">advent-of-code<span class="count">1</span></a>
          
          <li>
              <a href="/categories/azure/">azure<span class="count">1</span></a>
          
          <li>
              <a href="/categories/conferences/">conferences<span class="count">1</span></a>
          
          <li>
              <a href="/categories/not-so-technical/">not-so-technical<span class="count">1</span></a>
          
          <li>
              <a href="/categories/tfs/">tfs<span class="count">1</span></a>
          
          </li>
        </ul>
      </section>
    
  

  
    <section id="mini-bio">
      <header>
        <h1>About</h1>
      </header>
      <p>Posts about SQL Server, SSIS and automation for my future self, but you might find something useful.</p>
      <footer>
        <a href="/about" class="button">Learn More</a>
      </footer>
    </section>
  
</section>

      <footer id="site-footer">
  
      <ul class="socnet-icons">
        

        <li><a href="//github.com/BartekR" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//www.linkedin.com/in/bartoszratajczyk" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/b_ratajczyk" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>













      </ul>
  
  <p class="copyright">
    © 2021 BartekR
      <br>
    Theme: <a href='https://github.com/pacollins/hugo-future-imperfect-slim' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>A <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>HTML5 UP port</a> | Powered by <a href='https://gohugo.io/' title='0.76.5' target='_blank' rel='noopener'>Hugo</a>
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>

      <script src="/js/highlight.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/languages/powershell.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/languages/csharp.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script><script src="/js/bundle.min.b4e669fa428a81defb8af0916c53f39cd1b8e0bbab22199c06f0b182907ba474.js" integrity="sha256-tOZp&#43;kKKgd77ivCRbFPznNG44LurIhmcBvCxgpB7pHQ="></script>
    <script src="/js/add-on.js"></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-109318393-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    </div>
  </body>
</html>
