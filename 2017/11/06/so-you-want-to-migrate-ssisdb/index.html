<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<title>So, you want to migrate SSIS(DB)? - BartekR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="generator" content="Hugo 0.76.5" /><meta property="og:site_name" content="BartekR">
  <meta property="og:title" content="So, you want to migrate SSIS(DB)?">
  <meta property="og:description" content="BartekR blog. Previously known as String or binary data would be truncated">
  <meta property="description" content="BartekR blog. Previously known as String or binary data would be truncated">
  <meta property="og:url" content="http://bartekr.github.io/2017/11/06/so-you-want-to-migrate-ssisdb/">
  <meta property="og:type" content="article">
  
    <meta property="og:image" content="http://bartekr.github.io/img/main/Bartek_SqlSatOslo2019_100x100.png">
  
  
            <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/vs2015.min.css">
          <link rel="stylesheet" href="/css/bundle.min.307f33cd8015e5bab28d6ebda9b400f8d3059bc248b4e60adf4d23469fab5a2b.css" integrity="sha256-MH8zzYAV5bqyjW69qbQA&#43;NMFm8JItOYK300jRp&#43;rWis="><link rel="stylesheet" href="/css/add-on.css">
</head>

  <body>
    

<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/" class="nav">
        
          BartekR blog
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu menu">
      
        
          
          <a href="/about" class="nav link"><i class='far fa-id-card'></i> About</a>
        
      
        
          
          <a href="https://brinf.wordpress.com" class="nav link"><i class='fab fa-wordpress'></i> Blog [PL]</a>
        
      
        
          
          <a href="/books" class="nav link"><i class='fas fa-book-reader'></i> Books</a>
        
      
        
          
          <a href="/series" class="nav link"><i class='fas fa-newspaper'></i> Series</a>
        
      
        
          
          <a href="/speaking" class="nav link"><i class='fas fa-microphone-alt'></i> Speaking</a>
        
      
      
      <a href="#search-input" class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a>
    </menu>
    <a href="#search-input" class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
    
    <a href="#lang-menu" class="nav lang-toggle" lang="en">en</a>
    <a href="#site-nav" class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  <menu id="search" class="menu"><input id="search-input" class="search-input menu"></input><div id="search-results" class="search-results menu"></div></menu>
  <menu id="lang-menu" class="flyout-menu menu">
  <a href="#" lang="en" class="nav link active"> (en)</a>
  
    
      
    
  
</menu>

  
</header>

    <div id="wrapper">
      <section id="site-intro" class="hidden-single-column">
  <a href="/"><img src="http://bartekr.github.io/img/main/Bartek_SqlSatOslo2019_100x100.png" class="circle" width="100" alt="BartekR profile pic" /></a>
  <header>
    <h1>BartekR</h1>
  </header>
  <main>
    <p>SQL Server. SSIS. PowerShell. Azure.<br/>1 wife. 1 daughter.3 dogs. 9 cats.</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        

        <li><a href="//github.com/BartekR" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//www.linkedin.com/in/bartoszratajczyk" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/b_ratajczyk" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>













      </ul>
    </footer>
  
</section>

      <main id="site-main">
        
  <article class="post">
    <header>
  <div class="title">
    
      <h2><a href="/2017/11/06/so-you-want-to-migrate-ssisdb/">So, you want to migrate SSIS(DB)?</a></h2>
    
    
  </div>
  <div class="meta">
    <time datetime="2017-11-06 00:00:00 &#43;0000 UTC">November 6, 2017</time>
    
    
  </div>
</header>

    <div id="socnet-share">
      





    </div>
    <div class="content">
      
      <p>Excellent! I wanted to, and after few trials and errors I finally did! And it&rsquo;s pretty easy (as with all things you know when you learn it). For a start I will warn you a bit - SSISDB isn&rsquo;t the database you just backup on one server and restore on another. There are some more steps to do.</p>
<p>The same procedure will work for migrations from version 2012 to 2017 or 2016 to 2017, I didn&rsquo;t check (yet) 2014 to 2017. I also tested the migration of 2012 to 2016 version but had some problems with this when it came to upgrading database part. Will investigate it later (probably some problems with SSMS or SQL2016 installation).</p>
<p>I won&rsquo;t cover all the scenarios. I found few blog posts explaining migration and official documentation is also good. But it took me some time to distil the things that suit my scenario and to understand better why do I need to do them. At the end of the post, I write why I didn&rsquo;t use <a href="https://dbatools.io/functions/copy-dbassiscatalog/">Copy-DbaSsisCatalog</a> from <a href="http://dbatools.io">dbatools</a>.</p>
<h1 id="the-setup">The setup</h1>
<p>Let&rsquo;s do an example setup. I have Integration Services catalog with one folder (Test) that contains one environment (no projects) with two variables:</p>
<p>String1 (type: String) = 123 String2 (type: String) = 123 (sensitive, encrypted)</p>
<p><a href="http://blog.bartekr.net/wp-content/uploads/2017/10/SSISEnvironment.png"><img src="images/SSISEnvironment.png" alt=""></a></p>
<p>First thing - the backup and restore procedure works fine. You can see the folders and projects in Integration services catalog and SSISDB database. The problem starts when you run the package, start validation or want to check the sensitive variables. I will check the last one using <strong>dbatools</strong> and <a href="https://dbatools.io/Get-DbaSsisEnvironmentVariable">Get-DbaSsisEnvironmentVariable</a> command (replace <!-- raw HTML omitted --> with your instance if you&rsquo;re using named instances):</p>
<p>Get-DbaSsisEnvironmentVariable -SqlInstance &lsquo;<!-- raw HTML omitted -->\SQL2016&rsquo; -Environment PROD | Select-Object Name,Type,IsSensitive,Value |  Format-Table</p>
<p>The result: <a href="http://blog.bartekr.net/wp-content/uploads/2017/10/Get-DbaSsisEnvironmentVariableOK.png"><img src="images/Get-DbaSsisEnvironmentVariableOK-1024x84.png" alt=""></a>I selected only four attributes presented as a table for better readability. Everything is OK. So - back up the database on source instance (.\SQL2016), restore on another instance (.\SQL2017) and run again the <code>Get-DbaSsisEnvironmentVariable</code>.</p>
<p>-- .\SQL2016
USE [master]
BACKUP DATABASE [SSISDB]
TO DISK = N&rsquo;C:\tmp\SSISDB2016.bak'
WITH
    DESCRIPTION = N&rsquo;SSISDB Migration demo - SQL2016',
    NOFORMAT,
    NOINIT,
    NAME = N&rsquo;SSISDB-Full Database Backup',
    SKIP,
    NOREWIND,
    NOUNLOAD,
    COMPRESSION,
    STATS = 20,
    CHECKSUM
;
GO</p>
<p>&ndash; .\SQL2017
USE [master]
RESTORE DATABASE [SSISDB]
FROM DISK = N&rsquo;C:\tmp\SSISDB2016.bak'
WITH
    FILE = 1,
    MOVE N&rsquo;data' TO N&rsquo;C:\Program Files\Microsoft SQL Server\MSSQL14.SQL2017\MSSQL\DATA\SSISDB.mdf',
    MOVE N&rsquo;log'  TO N&rsquo;C:\Program Files\Microsoft SQL Server\MSSQL14.SQL2017\MSSQL\DATA\SSISDB.ldf',
    NOUNLOAD,
    STATS = 25
;
GO</p>
<p>The result: <a href="http://blog.bartekr.net/wp-content/uploads/2017/10/Get-DbaSsisEnvironmentVariableERROR.png"><img src="images/Get-DbaSsisEnvironmentVariableERROR-1024x127.png" alt=""></a></p>
<p>To get the error message in PowerShell I used a trick I found on <a href="https://nocolumnname.wordpress.com/2017/03/02/powershell-getting-more-from-generic-error-messages/">Shane&rsquo;s blog post</a> a while ago and just printed the full exception:</p>
<p>$Error[0].Exception.ToString()</p>
<p><a href="http://blog.bartekr.net/wp-content/uploads/2017/10/Get-DbaSsisEnvironmentVariableERRORDetails.png"><img src="images/Get-DbaSsisEnvironmentVariableERRORDetails-1024x51.png" alt=""></a></p>
<p><em>Please create a master key in the database or open the master key in the session before performing this operation. The key MS_Enckey_Env_2 is not open. Please open the key before using it.</em></p>
<p>Hmm, what should we do?</p>
<h1 id="database-master-key">Database Master Key</h1>
<p>Let&rsquo;s begin with a little reminder - what happens when you create Integration Services Catalog? Besides enabling CLR integration (first checkbox) or enabling running <code>[catalog.startup](https://docs.microsoft.com/en-us/sql/integration-services/system-stored-procedures/catalog-startup)</code> procedure on instance restart to fix running processes status (second checkbox) you create the encryption key. Precisely - <em>Database Master Key</em>. You can take a backup of that key and use it after restoring on another instance, but let&rsquo;s skip this for now.</p>
<p><a href="http://blog.bartekr.net/wp-content/uploads/2017/10/SSISCatalogCreation.png"><img src="images/SSISCatalogCreation.png" alt=""></a></p>
<p>What is a Database Master Key (DMK)? It&rsquo;s the main key used for encryption in the database. It&rsquo;s a symmetric key, which means it uses one password to encrypt and decrypt the objects. By default it is encrypted using <em>Service Master Key</em> (SMK) and a password - that&rsquo;s why we provide the password. In SSISDB the DMK is used to encrypt certificates used in the projects and the environments.</p>
<p>We are encouraged to write down the password somewhere, but sometimes we forget where we put it. Or the person responsible for administration doesn&rsquo;t work in the company any longer? What do we do, when we need to move the database to another server and we have no pasword for the key?</p>
<p>We panic.</p>
<p>Or not. There is a nice thing <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/create-master-key-transact-sql">in the documentation</a> (my <strong>emphasis</strong>):</p>
<blockquote>
<p>For SQL Server and Parallel Data Warehouse, the Master Key is typically protected by the Service Master Key and <strong>at least one password</strong>. In case of the database being physically moved to a different server (log shipping, restoring backup, etc.), the database will contain a copy of the master Key encrypted by the original server Service Master Key (unless this encryption was explicitly removed using ALTER MASTER KEY DDL), and a copy of it <strong>encrypted by each password</strong> specified during either CREATE MASTER KEY or subsequent ALTER MASTER KEY DDL operations.</p>
</blockquote>
<p>We can use more than one password to encrypt DMK. It&rsquo;s a great help for us if we don&rsquo;t remember the password - it makes the migration easier. There are more use cases for multiple passwords for DMK like password rotation related to retention policy.</p>
<p>We may also remove the encryption with Service Master Key and use only the password, but then we always have to use <code>OPEN MASTER KEY</code> before decrypting the data. Using SMK performs this operation for us in the background.</p>
<h1 id="back-to-the-migration">Back to the migration</h1>
<p>The database backup contains also the DMK with all its passwords. And if we didn&rsquo;t change the defaults (I didn&rsquo;t) the DMK is also encrypted with SMK. The SSISDB restore operation is made on another instance with different SMK, so there is a problem with decrypting the DMK - it&rsquo;s encrypted with SMK from original server and we try to decrypt DMK with SMK from new server - it doesn&rsquo;t work. One more time - part of the error:</p>
<p><em>Please create a master key in the database or open the master key in the session before performing this operation.</em></p>
<p>If we can&rsquo;t open the DMK with the SMK, we have to open it manually using <code>OPEN MASTER KEY</code> with the password. Then we can sign the DMK with the SMK from the new server. If you know the password - just use it. If not - alter the DMK on the original server by adding new password (optionally removing the binding from SMK) before taking the backup and use it on new server. The T-SQL code looks like this (let&rsquo;s say I don' t remember/know the password for the DMK in SSISDB):</p>
<p>-- .\SQL2016
USE SSISDB;
GO</p>
<p>&ndash; I forgot the password, add a new one
ALTER MASTER KEY
    ADD ENCRYPTION BY PASSWORD = &lsquo;Migration_Password123!&rsquo;
;</p>
<p>&ndash; backup the database with DMK signed with new password
USE [master]
BACKUP DATABASE [SSISDB]
TO DISK = N&rsquo;C:\tmp\SSISDB2016.bak'
WITH
    DESCRIPTION = N&rsquo;SSISDB Migration demo - SQL2016',
    NOFORMAT,
    NOINIT,
    NAME = N&rsquo;SSISDB-Full Database Backup',
    SKIP,
    NOREWIND,
    NOUNLOAD,
    COMPRESSION,
    STATS = 20,
    CHECKSUM
;
GO</p>
<p>&ndash; .\SQL2017
USE [master]</p>
<p>&ndash; restore from backup, nothing new
RESTORE DATABASE [SSISDB]
FROM DISK = N&rsquo;C:\tmp\SSISDB2016.bak'
WITH
FILE = 1,
MOVE N&rsquo;data' TO N&rsquo;C:\Program Files\Microsoft SQL Server\MSSQL14.SQL2017\MSSQL\DATA\SSISDB.mdf',
MOVE N&rsquo;log'  TO N&rsquo;C:\Program Files\Microsoft SQL Server\MSSQL14.SQL2017\MSSQL\DATA\SSISDB.ldf',
NOUNLOAD,
STATS = 25
;
GO</p>
<p>&ndash; open the DMK using the password I just added on original server
OPEN MASTER KEY DECRYPTION BY PASSWORD = &lsquo;Migration_Password123!&rsquo;</p>
<p>&ndash; encrypt the DMK with SMK of the new server
ALTER MASTER KEY
ADD ENCRYPTION BY SERVICE MASTER KEY
;</p>
<p>&ndash; tidy up
CLOSE MASTER KEY
;</p>
<p>Now I can read SSIS environment variables on the new server. Congratulations, migration successful.</p>
<p>Get-DbaSsisEnvironmentVariable -SqlInstance &lsquo;\SQL2017&rsquo; -Environment PROD | Select-Object Name,Type,IsSensitive,Value |  Format-Table</p>
<p>Last thing - at the end we should drop the password we used for migration. We can do this using command</p>
<p>ALTER MASTER KEY
    DROP ENCRYPTION BY PASSWORD = &lsquo;Migration_Password123!&rsquo;
;</p>
<p>This is just a migration of SSISDB. Running the packages, upgrading them, solving problems - it&rsquo;s something to cover in another post.</p>
<h1 id="dbatools">dbatools</h1>
<p>There is a <a href="https://dbatools.io/functions/copy-dbassiscatalog/">Copy-DbaSsisCatalog</a> command in dbatools. It copies the data from one SSIS catalog to another. The thing is - it reads the objects on source server and recreates them on destination server without some things that are crucial to me:</p>
<ul>
<li>it creates new objects in the target server, meaning they (may) have different identifiers than in source SSISDB</li>
<li>it does not copy environment references - I have to recreate them manually - and I also have to fix my jobs that use the environment reference id in the definition</li>
<li>it does not copy encrypted variables; well it does, but it does not copy the sensitive value (the decrypted value is an empty string)</li>
<li>I have noticed problems with copying projects on few occasions, but haven&rsquo;t looked into it</li>
</ul>
<p>So the backup/restore/alter DMK procedure is OK for me.</p>

    </div>
    <footer>
      <div class="stats">
  
    <ul class="categories">
      <li>None</li>
    </ul>
  
  
    <ul class="tags">
      <li>None</li>
    </ul>
  
</div>

    </footer>
  </article>
  
    

  
  <div class="pagination">
    
      <a href="/2017/11/14/t-sql-tuesday-#96-folks-who-have-made-a-difference/" class="button left"><span>T-SQL Tuesday #96: Folks Who Have Made a Difference</span></a>
    
    
      <a href="/2017/07/26/learning-something-new-getting-information-from-ssis-packages-with-powershell/" class="button right"><span>Learning something new: getting information from SSIS packages with PowerShell</span></a>
    
  </div>

      </main>
      <section id="site-sidebar">
  
    <section id="recent-posts">
      <header>
        <h1>Recent Posts</h1>
      </header>
      
      <article class="mini-post">
          <a href="/2020/09/24/using-the-system-oauth-token-in-azure-devops/" class="image" style="--bg-image: url('http://bartekr.github.io/2020/09/24/using-the-system-oauth-token-in-azure-devops/images/203Error.png');">
    <img src="http://bartekr.github.io/2020/09/24/using-the-system-oauth-token-in-azure-devops/images/203Error.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/09/24/using-the-system-oauth-token-in-azure-devops/">Using the system OAuth token in Azure DevOps</a></h2>
          <time class="published" datetime="2020-09-24 00:00:00 &#43;0000 UTC">September 24, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2020/09/01/have-problems-with-docker-desktop-for-windows-home-yeah-me-too/" class="image" style="--bg-image: url('http://bartekr.github.io/2020/09/01/have-problems-with-docker-desktop-for-windows-home-yeah-me-too/images/DockerDesktop.png');">
    <img src="http://bartekr.github.io/2020/09/01/have-problems-with-docker-desktop-for-windows-home-yeah-me-too/images/DockerDesktop.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/09/01/have-problems-with-docker-desktop-for-windows-home-yeah-me-too/">Have problems with Docker Desktop for Windows Home? Yeah, me too!</a></h2>
          <time class="published" datetime="2020-09-01 00:00:00 &#43;0000 UTC">September 1, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2020/05/19/adding-a-new-task-in-tfs-azure-devops-using-excel/" class="image" style="--bg-image: url('http://bartekr.github.io/2020/05/19/adding-a-new-task-in-tfs-azure-devops-using-excel/images/AzureDevOps_TeamPlugin.png');">
    <img src="http://bartekr.github.io/2020/05/19/adding-a-new-task-in-tfs-azure-devops-using-excel/images/AzureDevOps_TeamPlugin.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/05/19/adding-a-new-task-in-tfs-azure-devops-using-excel/">Adding a new task in TFS (Azure DevOps) using Excel</a></h2>
          <time class="published" datetime="2020-05-19 00:00:00 &#43;0000 UTC">May 19, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2020/05/04/adding-a-new-task-in-tfs-using-c/" class="image" style="--bg-image: url('http://bartekr.github.io/2020/05/04/adding-a-new-task-in-tfs-using-c/images/tbl_Field.png');">
    <img src="http://bartekr.github.io/2020/05/04/adding-a-new-task-in-tfs-using-c/images/tbl_Field.png" alt="">
  </a>
        <header>
          <h2><a href="/2020/05/04/adding-a-new-task-in-tfs-using-c/">Adding a new Task in TFS using C#</a></h2>
          <time class="published" datetime="2020-05-04 00:00:00 &#43;0000 UTC">May 4, 2020</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2019/08/07/draw-the-ssis-package-using-svg-part-iii/" class="image" style="--bg-image: url('http://bartekr.github.io/2019/08/07/draw-the-ssis-package-using-svg-part-iii/images/BoundingBoxRectangles.png');">
    <img src="http://bartekr.github.io/2019/08/07/draw-the-ssis-package-using-svg-part-iii/images/BoundingBoxRectangles.png" alt="">
  </a>
        <header>
          <h2><a href="/2019/08/07/draw-the-ssis-package-using-svg-part-iii/">Draw the SSIS Package using SVG - part III</a></h2>
          <time class="published" datetime="2019-08-07 00:00:00 &#43;0000 UTC">August 7, 2019</time>
        </header>
      </article>
      
      
        <footer>
          <a href="/post/" class="button">See More</a>
        </footer>
      
    </section>
  

  
    

      <section id="categories">
        <header>
          <h1><a href="/categories">Categories</a></h1>
        </header>
        <ul>
          
          
          <li>
              <a href="/categories/learning/">learning<span class="count">6</span></a>
          
          <li>
              <a href="/categories/series/">series<span class="count">3</span></a>
          
          <li>
              <a href="/categories/ssis-internals/">ssis-internals<span class="count">3</span></a>
          
          <li>
              <a href="/categories/troubleshooting/">troubleshooting<span class="count">2</span></a>
          
          <li>
              <a href="/categories/conferences/">conferences<span class="count">1</span></a>
          
          <li>
              <a href="/categories/programming/">programming<span class="count">1</span></a>
          
          <li>
              <a href="/categories/sql-server/">sql-server<span class="count">1</span></a>
          
          </li>
        </ul>
      </section>
    
  

  
    <section id="mini-bio">
      <header>
        <h1>About</h1>
      </header>
      <p>Bartekr 01</p>
      <footer>
        <a href="/about" class="button">Learn More</a>
      </footer>
    </section>
  
</section>

      <footer id="site-footer">
  
  <p class="copyright">
    © 2020 BartekR
      <br>
    Theme: <a href='https://github.com/pacollins/hugo-future-imperfect-slim' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>A <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>HTML5 UP port</a> | Powered by <a href='https://gohugo.io/' title='0.76.5' target='_blank' rel='noopener'>Hugo</a>
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>

      <script src="/js/highlight.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/languages/powershell.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/languages/csharp.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script><script src="/js/bundle.min.b4e669fa428a81defb8af0916c53f39cd1b8e0bbab22199c06f0b182907ba474.js" integrity="sha256-tOZp&#43;kKKgd77ivCRbFPznNG44LurIhmcBvCxgpB7pHQ="></script>
    <script src="/js/add-on.js"></script>
    </div>
  </body>
</html>
