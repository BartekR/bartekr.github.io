<!DOCTYPE html>
<html lang="en-gb" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="SSIS has a neat feature - it encodes all the sensitive data when you set it as - well - sensitive. It&rsquo;s a great thing for environment variables - you write once, use it to configure the project and then you can forget the password. Or write it down for later use. In the future. Some day. Maybe. But what if you need to do the configuration on another server? Or you&rsquo;re just curious how to decode encrypted data?">
<title>Get the passwords from SSIS Environment variables</title>

<link rel='canonical' href='https://blog.bartekr.net/2017/06/11/get-the-passwords-from-ssis-environment-variables/'>

<link rel="stylesheet" href="/scss/style.min.e8c7fca7d1c9294aa7a4f3426c225ee26540f7d94e39be0b5a4a5c8a49ca5a25.css"><meta property='og:title' content="Get the passwords from SSIS Environment variables">
<meta property='og:description' content="SSIS has a neat feature - it encodes all the sensitive data when you set it as - well - sensitive. It&rsquo;s a great thing for environment variables - you write once, use it to configure the project and then you can forget the password. Or write it down for later use. In the future. Some day. Maybe. But what if you need to do the configuration on another server? Or you&rsquo;re just curious how to decode encrypted data?">
<meta property='og:url' content='https://blog.bartekr.net/2017/06/11/get-the-passwords-from-ssis-environment-variables/'>
<meta property='og:site_name' content='BartekR'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='encryption' /><meta property='article:tag' content='internals' /><meta property='article:tag' content='SSIS' /><meta property='article:published_time' content='2017-06-11T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2017-06-11T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="Get the passwords from SSIS Environment variables">
<meta name="twitter:description" content="SSIS has a neat feature - it encodes all the sensitive data when you set it as - well - sensitive. It&rsquo;s a great thing for environment variables - you write once, use it to configure the project and then you can forget the password. Or write it down for later use. In the future. Some day. Maybe. But what if you need to do the configuration on another server? Or you&rsquo;re just curious how to decode encrypted data?">
    <link rel="shortcut icon" href="/favicon.ico" />

  

<style>
     
    :root {
        --article-font-family: "Roboto", var(--base-font-family);
    }
</style>

<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap";
    
        customFont.type = "text/css";
        customFont.rel = "stylesheet";
    
        document.head.appendChild(customFont);
    }());
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/Bartek_SqlSatOslo2019_100x100_huc95037055e21b687f52ff80813407d9d_14060_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">BartekR</a></h1>
            <p class="site-description">SQL Server. SSIS. PowerShell. Azure.<br />1 wife. 1 kid. 5 dogs. 10 cats.</p>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/BartekR'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/b_ratajczyk'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about' >
                
                
                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='https://brinf.wordpress.com' >
                
                
                
                <span>Blog [PL]</span>
            </a>
        </li>
        
        
        <li >
            <a href='/series' >
                
                
                
                <span>Series</span>
            </a>
        </li>
        
        
        <li >
            <a href='/books' >
                
                
                
                <span>Books</span>
            </a>
        </li>
        
        
        <li >
            <a href='/speaking' >
                
                
                
                <span>Speaking</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories' >
                
                
                
                <span>Categories</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags' >
                
                
                
                <span>Tags</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search' >
                
                
                
                <span>Search</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/ssis-internals/" >
                SSIS Internals
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/2017/06/11/get-the-passwords-from-ssis-environment-variables/">Get the passwords from SSIS Environment variables</a>
        </h2>
    
        

        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jun 11, 2017</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    6 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>SSIS has a neat feature - it encodes all the sensitive data when you set it as - well - sensitive. It&rsquo;s a great thing for environment variables - you write once, use it to configure the project and then you can forget the password. Or write it down for later use. In the future. Some day. Maybe.</p>
<p>But what if you need to do the configuration on another server? Or you&rsquo;re just curious how to decode encrypted data? SSIS has to do it somehow, right?</p>
<p>If you&rsquo;re not curious what happens under the hood then scroll down to see that you can get all the information in few lines of T-SQL code (max 3 if you know the environment&rsquo;s ID and compress <code>SELECT</code> statement). If you want to know more - let&rsquo;s start with investigating environment creation with SQL Profiler. I will create environment <em>ENV1</em> in folder <em>DWH_ETL</em>.</p>
<p><a class="link" href="images/CreateEnvironment.png" >
  
  <p style="text-align: center;">
    <img src="images/CreateEnvironment.png"
	
	
	
	loading="lazy"
	
		alt="Create an SSIS environment"
	
	
>
  </p>

</a></p>
<p>SSIS makes few standard calls before each operation (take a look at <a class="link" href="http://blog.bartekr.net/2017/05/03/what-happens-during-ssis-deployments/"  target="_blank" rel="noopener"
    >deployment details</a>), but the most important thing is this part:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">EXEC</span><span class="w"> </span><span class="p">[</span><span class="n">SSISDB</span><span class="p">].[</span><span class="k">catalog</span><span class="p">].[</span><span class="n">create_environment</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">environment_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="s1">&#39;ENV1&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">environment_description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">folder_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="s1">&#39;DWH_ETL&#39;</span><span class="w">
</span></span></span></code></pre></div><p>Nothing surprising. But have you seen the <code>catalog.create_environment</code>&rsquo;s body? Yeah, me too. So - we have to go deeper. Scrolling down 120 lines of code (user validation, environment existence check) we get to the point. It starts slowly:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="p">[</span><span class="n">internal</span><span class="p">].[</span><span class="n">environments</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">environment_name</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">folder_id</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">environment_description</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">caller_sid</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">caller_name</span><span class="p">,</span><span class="w"> </span><span class="n">SYSDATETIMEOFFSET</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">environment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SCOPE_IDENTITY</span><span class="p">()</span><span class="w">
</span></span></span></code></pre></div><p>But then gets interesting:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">encryption_algorithm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">internal</span><span class="p">].[</span><span class="n">get_encryption_algorithm</span><span class="p">]())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- ... skip some code ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">key_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;MS_Enckey_Env_&#39;</span><span class="o">+</span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="o">@</span><span class="n">environment_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">certificate_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;MS_Cert_Env_&#39;</span><span class="o">+</span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="o">@</span><span class="n">environment_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">sqlString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CREATE CERTIFICATE &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">certificate_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; WITH SUBJECT = &#39;&#39;ISServerCertificate&#39;&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">IF</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">sys</span><span class="p">].[</span><span class="n">certificates</span><span class="p">]</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">certificate_name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="n">sqlString</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">sqlString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CREATE SYMMETRIC KEY &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">key_name</span><span class="w"> </span><span class="o">+</span><span class="s1">&#39; WITH ALGORITHM = &#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">encryption_algorithm</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; ENCRYPTION BY CERTIFICATE &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">certificate_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">IF</span><span class="w">  </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">sys</span><span class="p">].[</span><span class="n">symmetric_keys</span><span class="p">]</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="n">key_name</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="n">sqlString</span><span class="w">
</span></span></span></code></pre></div><p>Aha! So, it&rsquo;s creating the certificate and the symmetric key for the environment. Ergo - all encryption within the environment uses dedicated symmetric key encrypted using dedicated certificate.</p>
<p>Great - the second step - add a sensitive variable to this environment (using SSMS, let&rsquo;s skip the screenshot). I&rsquo;ll call it <em><code>VAR1</code></em>, type - <code>string</code>, value: <code>123</code>. Dot excluded. SQL Profiler still running - we get this piece of code (of course there&rsquo;s more, but I cut down to the interesting part):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">DECLARE</span><span class="w"> </span><span class="o">@</span><span class="n">var</span><span class="w"> </span><span class="n">sql_variant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">N</span><span class="s1">&#39;123&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">EXEC</span><span class="w"> </span><span class="p">[</span><span class="n">SSISDB</span><span class="p">].[</span><span class="k">catalog</span><span class="p">].[</span><span class="n">create_environment_variable</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">variable_name</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;VAR1&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="k">sensitive</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">description</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">environment_name</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;ENV1&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">folder_name</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;DWH_ETL&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">value</span><span class="o">=@</span><span class="n">var</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">@</span><span class="n">data_type</span><span class="o">=</span><span class="n">N</span><span class="s1">&#39;String&#39;</span><span class="w">
</span></span></span></code></pre></div><p>First conclusion - the value provided has no strong type. It&rsquo;s <code>sql_variant</code>. The <em>String</em> type is just an attribute to this value. It has its consequences later, but for now, it&rsquo;s not that important. As earlier - we have to go deeper - how does <code>catalog.create_environment_variable</code> work?</p>
<p>Again - when we take a look inside of the procedure we see user validation, data type validation, environment and folder validation, permission checking and so on. And then we get to this piece of code for encrypted values (EncryptByKey, OPEN SYMMETRIC KEY, CLOSE SYMMETRIC KEY):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">IF</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="k">sensitive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">key_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;MS_Enckey_Env_&#39;</span><span class="o">+</span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="o">@</span><span class="n">environment_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">certificate_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;MS_Cert_Env_&#39;</span><span class="o">+</span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">varchar</span><span class="p">,</span><span class="o">@</span><span class="n">environment_id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">sqlString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;OPEN SYMMETRIC KEY &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">key_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; DECRYPTION BY CERTIFICATE &#39;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">certificate_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="n">sqlString</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">data_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;datetime&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">binary_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EncryptByKey</span><span class="p">(</span><span class="n">KEY_GUID</span><span class="p">(</span><span class="o">@</span><span class="n">key_name</span><span class="p">),</span><span class="k">CONVERT</span><span class="p">(</span><span class="n">varbinary</span><span class="p">(</span><span class="mi">4000</span><span class="p">),</span><span class="k">CONVERT</span><span class="p">(</span><span class="n">datetime2</span><span class="p">,</span><span class="o">@</span><span class="n">value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">END</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="o">@</span><span class="n">data_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;single&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="n">data_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;double&#39;</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="o">@</span><span class="n">data_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;decimal&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">binary_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EncryptByKey</span><span class="p">(</span><span class="n">KEY_GUID</span><span class="p">(</span><span class="o">@</span><span class="n">key_name</span><span class="p">),</span><span class="k">CONVERT</span><span class="p">(</span><span class="n">varbinary</span><span class="p">(</span><span class="mi">4000</span><span class="p">),</span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">decimal</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span><span class="mi">18</span><span class="p">),</span><span class="o">@</span><span class="n">value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">END</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">ELSE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">binary_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EncryptByKey</span><span class="p">(</span><span class="n">KEY_GUID</span><span class="p">(</span><span class="o">@</span><span class="n">key_name</span><span class="p">),</span><span class="k">CONVERT</span><span class="p">(</span><span class="n">varbinary</span><span class="p">(</span><span class="mi">4000</span><span class="p">),</span><span class="o">@</span><span class="n">value</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">END</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SET</span><span class="w"> </span><span class="o">@</span><span class="n">sqlString</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;CLOSE SYMMETRIC KEY &#39;</span><span class="o">+</span><span class="w"> </span><span class="o">@</span><span class="n">key_name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">EXECUTE</span><span class="w"> </span><span class="n">sp_executesql</span><span class="w"> </span><span class="o">@</span><span class="n">sqlString</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w">  </span><span class="p">[</span><span class="n">internal</span><span class="p">].[</span><span class="n">environment_variables</span><span class="p">]</span><span class="w"> </span><span class="p">([</span><span class="n">environment_id</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">description</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="k">type</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="k">sensitive</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">value</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">sensitive_value</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">base_data_type</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">environment_id</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">variable_name</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">sensitive</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">binary_value</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">variable_type</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">ELSE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">BEGIN</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w">  </span><span class="p">[</span><span class="n">internal</span><span class="p">].[</span><span class="n">environment_variables</span><span class="p">]</span><span class="w"> </span><span class="p">([</span><span class="n">environment_id</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">description</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="k">type</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="k">sensitive</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">value</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">sensitive_value</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="n">base_data_type</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">@</span><span class="n">environment_id</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">variable_name</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">data_type</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="k">sensitive</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w"> </span><span class="o">@</span><span class="n">variable_type</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="w">
</span></span></span></code></pre></div><p>The sensitive variable is encrypted by symmetric key created during the environment creation. The value is converted to <code>varbinary(4000)</code> and encrypted using the <code>EncryptByKey()</code> function, but with three different paths, according to the type:</p>
<ul>
<li><em>datetime</em> - converts the value to <code>datetime2</code>, and then to <code>varbinary(4000)</code></li>
<li><em>number</em> - converts the value to <code>decimal(38, 18)</code>, and then to <code>varbinary(4000)</code></li>
<li><em>other</em> - converts straight to <code>varbinary(4000)</code></li>
</ul>
<p>At the end, the key is closed and the value is inserted into the <code>internal.environment_variables</code> table to the <code>sensitive_variable</code> column.</p>
<blockquote>
<p>A side note: SMO returns variables for environment from the <code>catalog.environment_variables</code> view, not the <code>internal.environment_variables</code> table. The view does not provide sensitive data.</p>
</blockquote>
<p>Looks easy - to decrypt the variable we need to do almost the same thing as with encryption, but instead of the <code>EncryptByKey()</code> function we have to use <code>DecryptByKey()</code>. Also - as with encryption - we have to consider different paths for data decryption - we&rsquo;ll see why in a moment.</p>
<p>To simplify the code I&rsquo;m assuming that my <code>environment_id = 10</code>. Then my encryption key and certificate have <em>_10</em> suffix. First try: convert all to <code>NVARCHAR(1000)</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">OPEN</span><span class="w"> </span><span class="k">SYMMETRIC</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">MS_Enckey_Env_10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DECRYPTION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">CERTIFICATE</span><span class="w"> </span><span class="n">MS_Cert_Env_10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">SSISDB</span><span class="p">.</span><span class="n">internal</span><span class="p">.</span><span class="n">environment_variables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">environment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CLOSE</span><span class="w"> </span><span class="k">SYMMETRIC</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">MS_Enckey_Env_10</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>Easy. But - it&rsquo;s only one simple string variable. What happens when we have sensitive data of type - let&rsquo;s say - int? Or float? Because - why not? Sensitive is an attribute of all types of data. Then we have to convert to the proper type. Let&rsquo;s say we have an environment with lots of encrypted variables:</p>
<p><a class="link" href="images/EncrypteVariablesInEnvironment.png" >
<img src="images/EncrypteVariablesInEnvironment.png"
	width="812"
	height="336"
	srcset="/2017/06/11/get-the-passwords-from-ssis-environment-variables/images/EncrypteVariablesInEnvironment_hu650a21bdd93d5d3c5e8a33289e857948_15581_480x0_resize_box_3.png 480w, /2017/06/11/get-the-passwords-from-ssis-environment-variables/images/EncrypteVariablesInEnvironment_hu650a21bdd93d5d3c5e8a33289e857948_15581_1024x0_resize_box_3.png 1024w"
	loading="lazy"
	
		alt="Encrypted variables"
	
	
		class="gallery-image" 
		data-flex-grow="241"
		data-flex-basis="580px"
	
>

</a></p>
<p>If we try to do something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">OPEN</span><span class="w"> </span><span class="k">SYMMETRIC</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">MS_Enckey_Env_10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DECRYPTION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">CERTIFICATE</span><span class="w"> </span><span class="n">MS_Cert_Env_10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">value</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="n">base_data_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;nvarchar&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;bit&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">bit</span><span class="p">,</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;datetime&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">datetime2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">-- some data types skipped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">    </span><span class="k">END</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">SSISDB</span><span class="p">.</span><span class="n">internal</span><span class="p">.</span><span class="n">environment_variables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">environment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CLOSE</span><span class="w"> </span><span class="k">SYMMETRIC</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">MS_Enckey_Env_10</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>we get the errors of operand clash:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cmd" data-lang="cmd"><span class="line"><span class="cl">Msg 206, Level 16, State 2, Line 2
</span></span><span class="line"><span class="cl">Operand type clash: bit is incompatible with datetime2
</span></span></code></pre></div><p>It&rsquo;s because we try to put more than one type in one column (value). We have to do one more conversion to common type. Let&rsquo;s use <code>NVARCHAR(MAX)</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">OPEN</span><span class="w"> </span><span class="k">SYMMETRIC</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">MS_Enckey_Env_10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">DECRYPTION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">CERTIFICATE</span><span class="w"> </span><span class="n">MS_Cert_Env_10</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="o">*</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">value</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="k">CASE</span><span class="w"> </span><span class="n">base_data_type</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;nvarchar&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;bit&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">bit</span><span class="p">,</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;datetime&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">datetime2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;single&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">),</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;float&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">),</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;decimal&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">DECIMAL</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">),</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;tinyint&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">tinyint</span><span class="p">,</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;smallint&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">smallint</span><span class="p">,</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;int&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">INT</span><span class="p">,</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHEN</span><span class="w"> </span><span class="s1">&#39;bigint&#39;</span><span class="w"> </span><span class="k">THEN</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">MAX</span><span class="p">),</span><span class="w"> </span><span class="k">CONVERT</span><span class="p">(</span><span class="nb">bigint</span><span class="p">,</span><span class="w"> </span><span class="n">DECRYPTBYKEY</span><span class="p">(</span><span class="n">sensitive_value</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">END</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">SSISDB</span><span class="p">.</span><span class="n">internal</span><span class="p">.</span><span class="n">environment_variables</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">environment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">CLOSE</span><span class="w"> </span><span class="k">SYMMETRIC</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="n">MS_Enckey_Env_10</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>I used only 10 types of variables, but we all know there is more of the types. But - when I checked the base data type for each variable I used (and every type was used there) I got only these 10 types. So I&rsquo;ll stick with them.</p>
<p>Bottomline: to decrypt environment variable you need to:</p>
<ol>
<li>know your environment&rsquo;s Id</li>
<li>open symmetric key decrypted by a certificate - for this environment</li>
<li>use <code>DecryptByKey()</code> function and cast variable to proper type</li>
<li>close symmetric key (tidy up)</li>
</ol>
<p>The last thing: if you are sysadmin you can do it all without thinking about the permissions. But if you&rsquo;re not - these are minimal privileges to decrypt data (tested on SQL Server 2014):</p>
<ul>
<li><code>VIEW DEFINITION</code> on <code>SYMMETRIC KEY</code></li>
<li><code>CONTROL</code> on <code>CERTIFICATE</code></li>
<li><code>SELECT</code> on <code>internal.environment_variables</code></li>
</ul>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/encryption/">Encryption</a>
        
            <a href="/tags/internals/">Internals</a>
        
            <a href="/tags/ssis/">SSIS</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/2017/05/03/what-happens-during-ssis-deployments/">
        
        

        <div class="article-details">
            <h2 class="article-title">What happens during SSIS deployments?</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src="https://utteranc.es/client.js" 
        repo=""
        issue-term="pathname"
        
        crossorigin="anonymous"
        async
        >
</script>

<style>
    .utterances {
        max-width: unset;
    }
</style>

<script>
    let utterancesLoaded = false;

    function setUtterancesTheme(theme) {
        let utterances = document.querySelector('.utterances iframe');
        if (utterances) {
            utterances.contentWindow.postMessage(
                {
                    type: 'set-theme',
                    theme: `github-${theme}`
                },
                'https://utteranc.es'
            );
        }
    }

    addEventListener('message', event => {
        if (event.origin !== 'https://utteranc.es') return;

        
        utterancesLoaded = true;
        setUtterancesTheme(document.documentElement.dataset.scheme)
    });

    window.addEventListener('onColorSchemeChange', (e) => {
        if (!utterancesLoaded) return;
        setUtterancesTheme(e.detail)
    })
</script>


    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2017 - 
        
        2024 BartekR
    </section>
    
    <section class="powerby">
        
            (c) Bartosz Ratajczyk <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
