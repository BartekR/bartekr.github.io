<!doctype html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<title>What happens during SSIS deployments? - BartekR</title>
<meta name="description" content="BartekR blog. Previously known as String or binary data would be truncated">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<meta name="twitter:card" content="summary_large_image">

<meta property="og:site_name" content="BartekR">
<meta property="og:title" content="What happens during SSIS deployments?">
<meta property="og:description" content="BartekR blog. Previously known as String or binary data would be truncated">
<meta property="og:type" content="article">
<meta property="og:url" content="https://blog.bartekr.net/2017/05/03/what-happens-during-ssis-deployments/">
    <meta property="og:image" content="https://blog.bartekr.net/2017/05/03/what-happens-during-ssis-deployments/images/internal.get_project_internal.png">
    <meta property="og:image:alt" content="">


  <link rel="shortcut icon" href="/favicon.ico">


  <meta name="generator" content="Hugo 0.84.0" />
  
            <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/vs2015.min.css">
          <link rel="stylesheet" href="/css/bundle.min.1bfccf86359e3de974865922b006112447a52f942c2a9c2bf93d159980ae641b.css" integrity="sha256-G/zPhjWePel0hlkisAYRJEelL5QsKpwr&#43;T0VmYCuZBs="><link rel="stylesheet" href="/css/add-on.css">
</head>

  <body>
    

<header id="site-header">
  <nav id="site-nav">
    <h1 class="nav-title">
      <a href="/" class="nav">
        
          BartekR blog
        
      </a>
    </h1>
    <menu id="site-nav-menu" class="flyout-menu menu">
      
        
          
          <a href="/about" class="nav link"><i class='far fa-id-card'></i> About</a>
        
      
        
          
          <a href="https://brinf.wordpress.com" class="nav link"><i class='fab fa-wordpress'></i> Blog [PL]</a>
        
      
        
          
          <a href="/books" class="nav link"><i class='fas fa-book-reader'></i> Books</a>
        
      
        
          
          <a href="/series" class="nav link"><i class='fas fa-newspaper'></i> Series</a>
        
      
        
          
          <a href="/speaking" class="nav link"><i class='fas fa-microphone-alt'></i> Speaking</a>
        
      
      
      <a href="#search-input" class="nav link search-toggle"><i class="fas fa-search">&nbsp;</i>Search</a>
    </menu>
    <a href="#search-input" class="nav search-toggle"><i class="fas fa-search fa-2x">&nbsp;</i></a>
    
    <a href="#lang-menu" class="nav lang-toggle" lang="en">en</a>
    <a href="#site-nav" class="nav nav-toggle"><i class="fas fa-bars fa-2x"></i></a>
  </nav>
  <menu id="search" class="menu"><input id="search-input" class="search-input menu"></input><div id="search-results" class="search-results menu"></div></menu>
  <menu id="lang-menu" class="flyout-menu menu">
  <a href="#" lang="en" class="nav link active"> (en)</a>
  
    
      
    
  
</menu>

  
</header>

    <div id="wrapper">
      <section id="site-intro" class="hidden-single-column">
  <a href="/"><img src="/img/main/Bartek_SqlSatOslo2019_100x100.png" class="circle" width="100" alt="BartekR profile pic" /></a>
  <header>
    <h1>BartekR</h1>
  </header>
  <main>
    <p>SQL Server. SSIS. PowerShell. Azure.<br/>1 wife. 1 kid. 4 dogs. 10 cats.</p>
  </main>
  
    <footer>
      <ul class="socnet-icons">
        

        <li><a href="//github.com/BartekR" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//www.linkedin.com/in/bartoszratajczyk" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/b_ratajczyk" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>










<li><a href="//dataplatform.social/@b_ratajczyk" target="_blank" rel="me" title="mastodon" class="fab fa-mastodon"></a></li>


      </ul>
    </footer>
  
</section>

      <main id="site-main">
        
  <article>
    <div class="post">
      <header>
  <div class="title">
    
      <h2><a href="/2017/05/03/what-happens-during-ssis-deployments/">What happens during SSIS deployments?</a></h2>
    
    
  </div>
  <div class="meta">
    <time datetime="2017-05-03 00:00:00 &#43;0000 UTC">May 3, 2017</time>
    
    
  </div>
</header>

      <div id="socnet-share">
        





      </div>
      <div class="content">
        <a href="/2017/05/03/what-happens-during-ssis-deployments/" class="image" style="--bg-image: url('/2017/05/03/what-happens-during-ssis-deployments/images/internal.get_project_internal.png');">
    <img src="/2017/05/03/what-happens-during-ssis-deployments/images/internal.get_project_internal.png" alt="">
  </a>
        
        <p>When you deploy SSIS project basically you have two options - right click on project name and standalone tool (let&rsquo;s skip SMO and stuff). Both mean the same: <code>IsDeploymentWizard.exe</code>. I was curious what happens during deployment and why mode<code>/Silent</code> finishes deployment very quickly, so I started digging.</p>
<p>First I prepared sample SSIS project. Nothing extraordinary - just 5 packages, 6 project parameters and no connection managers (who needs them anyway?). Each package contained empty Data Flow Task - so you see that all just to compile something more than a single package. Later during tests, I added connection managers, but they were treated the same as project parameters, so I skipped them (the same with package parameters). To observe the environment I used good old SQL Profiler and <a href="https://technet.microsoft.com/en-us/sysinternals/processexplorer.aspx">Process Explorer</a>.</p>
<p>First - the SQL Profiler. I prepared only two operations to capture:</p>
<ul>
<li>RPC:Completed</li>
<li>SQL:BatchCompleted</li>
</ul>
<p>Didn&rsquo;t set up the columns, just accepted the defaults and hit <em>Run</em>. On a busy machine I could use a filter on Application Name column (<em>Like: SSIS%</em> - two applications are involved). As the result I got 27 lines of T-SQL commands</p>
<p><a href="images/Profiler01.png"><img src="images/Profiler01-1024x487.png" alt="Profiler output"></a></p>
<p>What do we have here? First ten lines are five commands repeated two times. They check for the server version and settings. At first they are called when deployment wizard starts and connects to the <em>SSISDB</em> to check if everything is OK. The second time it starts the whole deployment procedure. The lines are:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- ========= 1 =========
</span><span style="color:#75715e">-- Check for server environment
</span><span style="color:#75715e">-- =====================
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">DECLARE</span> <span style="color:#f92672">@</span>edition sysname; <span style="color:#66d9ef">SET</span> <span style="color:#f92672">@</span>edition <span style="color:#f92672">=</span> <span style="color:#66d9ef">cast</span>(SERVERPROPERTY(N<span style="color:#e6db74">&#39;EDITION&#39;</span>) <span style="color:#66d9ef">as</span> sysname); <span style="color:#66d9ef">select</span> <span style="color:#66d9ef">case</span> <span style="color:#66d9ef">when</span> <span style="color:#f92672">@</span>edition <span style="color:#f92672">=</span> N<span style="color:#e6db74">&#39;SQL Azure&#39;</span> <span style="color:#66d9ef">then</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">end</span> <span style="color:#66d9ef">as</span> <span style="color:#e6db74">&#39;DatabaseEngineType&#39;</span>;
<span style="color:#66d9ef">SELECT</span> SERVERPROPERTY(<span style="color:#e6db74">&#39;EngineEdition&#39;</span>) <span style="color:#66d9ef">AS</span> DatabaseEngineEdition
<span style="color:#66d9ef">if</span> <span style="color:#66d9ef">exists</span> (<span style="color:#66d9ef">select</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">from</span> sys.all_objects <span style="color:#66d9ef">where</span> name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;dm_os_host_info&#39;</span> <span style="color:#66d9ef">and</span> <span style="color:#66d9ef">type</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;V&#39;</span> <span style="color:#66d9ef">and</span> is_ms_shipped <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
<span style="color:#66d9ef">begin</span>
<span style="color:#66d9ef">select</span> host_platform <span style="color:#66d9ef">from</span> sys.dm_os_host_info
<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">else</span>
<span style="color:#66d9ef">select</span> N<span style="color:#e6db74">&#39;Windows&#39;</span> <span style="color:#66d9ef">as</span> host_platform

<span style="color:#66d9ef">go</span>

<span style="color:#75715e">-- ========= 2 =========
</span><span style="color:#75715e">-- Get server name
</span><span style="color:#75715e">-- =====================
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> SERVERPROPERTY(N<span style="color:#e6db74">&#39;servername&#39;</span>)
<span style="color:#66d9ef">go</span>

<span style="color:#75715e">-- ========= 3 =========
</span><span style="color:#75715e">-- Get SSIS Catalog information
</span><span style="color:#75715e">-- =====================
</span><span style="color:#75715e"></span><span style="color:#66d9ef">exec</span> sp_executesql N<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">        --Preparing to access the Catalog object
</span><span style="color:#e6db74">        DECLARE @t_catalogs TABLE (
</span><span style="color:#e6db74">        Name sysname COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74">        EncryptionAlgorithm nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74">        SchemaVersion int,
</span><span style="color:#e6db74">        SchemaBuild nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74">        OperationLogRetentionTime int,
</span><span style="color:#e6db74">        MaxProjectVersions int,
</span><span style="color:#e6db74">        OperationCleanupEnabled bit,
</span><span style="color:#e6db74">        VersionCleanupEnabled bit,
</span><span style="color:#e6db74">        ServerLoggingLevel int,
</span><span style="color:#e6db74">        ServerCustomizedLoggingLevel nvarchar(128))
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        IF DB_ID(&#39;&#39;SSISDB&#39;&#39;) IS NOT NULL
</span><span style="color:#e6db74">        BEGIN
</span><span style="color:#e6db74">        INSERT INTO @t_catalogs VALUES(
</span><span style="color:#e6db74">        &#39;&#39;SSISDB&#39;&#39;,
</span><span style="color:#e6db74">        (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;ENCRYPTION_ALGORITHM&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;SCHEMA_VERSION&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;SCHEMA_BUILD&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;RETENTION_WINDOW&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;MAX_PROJECT_VERSIONS&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;OPERATION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;VERSION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;SERVER_LOGGING_LEVEL&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_CUSTOMIZED_LOGGING_LEVEL&#39;&#39;)
</span><span style="color:#e6db74">        )
</span><span style="color:#e6db74">        END
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">&#39;&#39;IntegrationServices[@Name=&#39;&#39; + quotename(CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname),&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;]&#39;&#39; + &#39;&#39;/Catalog[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE((SELECT Name from @t_catalogs), &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; AS [Urn],
</span><span style="color:#e6db74">(SELECT Name from @t_catalogs) AS [Name],
</span><span style="color:#e6db74">(SELECT EncryptionAlgorithm from @t_catalogs) AS [EncryptionAlgorithm],
</span><span style="color:#e6db74">(SELECT SchemaVersion from @t_catalogs) AS [SchemaVersion],
</span><span style="color:#e6db74">(SELECT SchemaBuild from @t_catalogs) AS [SchemaBuild],
</span><span style="color:#e6db74">(SELECT OperationLogRetentionTime from @t_catalogs) AS [OperationLogRetentionTime],
</span><span style="color:#e6db74">(SELECT MaxProjectVersions from @t_catalogs) AS [MaxProjectVersions],
</span><span style="color:#e6db74">(SELECT OperationCleanupEnabled from @t_catalogs) AS [OperationCleanupEnabled],
</span><span style="color:#e6db74">(SELECT VersionCleanupEnabled from @t_catalogs) AS [VersionCleanupEnabled],
</span><span style="color:#e6db74">(SELECT ServerLoggingLevel from @t_catalogs) AS [ServerLoggingLevel],
</span><span style="color:#e6db74">(SELECT ServerCustomizedLoggingLevel from @t_catalogs) AS [ServerCustomizedLoggingLevel]
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">(CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname)=@_msparam_0)&#39;</span>,N<span style="color:#e6db74">&#39;@_msparam_0 nvarchar(4000)&#39;</span>,<span style="color:#f92672">@</span>_msparam_0<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;WIN-LFVELR2F095&#39;</span>

<span style="color:#75715e">-- ========== 4 ==========
</span><span style="color:#75715e">-- Get terget folder information
</span><span style="color:#75715e">-- =======================
</span><span style="color:#75715e"></span><span style="color:#66d9ef">exec</span> sp_executesql N<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">        --Preparing to access the Catalog object
</span><span style="color:#e6db74">        DECLARE @t_catalogs TABLE (
</span><span style="color:#e6db74">        Name sysname COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74">        EncryptionAlgorithm nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74">        SchemaVersion int,
</span><span style="color:#e6db74">        SchemaBuild nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74">        OperationLogRetentionTime int,
</span><span style="color:#e6db74">        MaxProjectVersions int,
</span><span style="color:#e6db74">        OperationCleanupEnabled bit,
</span><span style="color:#e6db74">        VersionCleanupEnabled bit,
</span><span style="color:#e6db74">        ServerLoggingLevel int,
</span><span style="color:#e6db74">        ServerCustomizedLoggingLevel nvarchar(128))
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        IF DB_ID(&#39;&#39;SSISDB&#39;&#39;) IS NOT NULL
</span><span style="color:#e6db74">        BEGIN
</span><span style="color:#e6db74">        INSERT INTO @t_catalogs VALUES(
</span><span style="color:#e6db74">        &#39;&#39;SSISDB&#39;&#39;,
</span><span style="color:#e6db74">        (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;ENCRYPTION_ALGORITHM&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;SCHEMA_VERSION&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;SCHEMA_BUILD&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;RETENTION_WINDOW&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;MAX_PROJECT_VERSIONS&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;OPERATION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;VERSION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;SERVER_LOGGING_LEVEL&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_CUSTOMIZED_LOGGING_LEVEL&#39;&#39;)
</span><span style="color:#e6db74">        )
</span><span style="color:#e6db74">        END
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">&#39;&#39;IntegrationServices[@Name=&#39;&#39; + quotename(CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname),&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;]&#39;&#39; + &#39;&#39;/Catalog[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE((SELECT Name from @t_catalogs), &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; + &#39;&#39;/CatalogFolder[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE(folders.[name], &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; AS [Urn],
</span><span style="color:#e6db74">folders.[folder_id] AS [FolderId],
</span><span style="color:#e6db74">folders.[name] AS [Name],
</span><span style="color:#e6db74">folders.[description] AS [Description],
</span><span style="color:#e6db74">folders.[created_by_sid] AS [CreatedBySid],
</span><span style="color:#e6db74">folders.[created_by_name] AS [CreatedByName],
</span><span style="color:#e6db74">CAST (folders.[created_time] AS datetime) AS [CreatedDate]
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">[SSISDB].[catalog].[folders] AS folders
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">((SELECT Name from @t_catalogs)=@_msparam_0)and((CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname)=@_msparam_1))&#39;</span>,N<span style="color:#e6db74">&#39;@_msparam_0 nvarchar(4000),@_msparam_1 nvarchar(4000)&#39;</span>,<span style="color:#f92672">@</span>_msparam_0<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;SSISDB&#39;</span>,<span style="color:#f92672">@</span>_msparam_1<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;WIN-LFVELR2F095&#39;</span>

<span style="color:#75715e">-- ========== 5 ==========
</span><span style="color:#75715e">-- Get target project information
</span><span style="color:#75715e">-- =======================
</span><span style="color:#75715e"></span><span style="color:#66d9ef">exec</span> sp_executesql N<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74">        --Preparing to access the Catalog object
</span><span style="color:#e6db74">        DECLARE @t_catalogs TABLE (
</span><span style="color:#e6db74">        Name sysname COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74">        EncryptionAlgorithm nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74">        SchemaVersion int,
</span><span style="color:#e6db74">        SchemaBuild nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74">        OperationLogRetentionTime int,
</span><span style="color:#e6db74">        MaxProjectVersions int,
</span><span style="color:#e6db74">        OperationCleanupEnabled bit,
</span><span style="color:#e6db74">        VersionCleanupEnabled bit,
</span><span style="color:#e6db74">        ServerLoggingLevel int,
</span><span style="color:#e6db74">        ServerCustomizedLoggingLevel nvarchar(128))
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">        IF DB_ID(&#39;&#39;SSISDB&#39;&#39;) IS NOT NULL
</span><span style="color:#e6db74">        BEGIN
</span><span style="color:#e6db74">        INSERT INTO @t_catalogs VALUES(
</span><span style="color:#e6db74">        &#39;&#39;SSISDB&#39;&#39;,
</span><span style="color:#e6db74">        (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;ENCRYPTION_ALGORITHM&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;SCHEMA_VERSION&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;SCHEMA_BUILD&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;RETENTION_WINDOW&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;MAX_PROJECT_VERSIONS&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;OPERATION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;VERSION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name]  = N&#39;&#39;SERVER_LOGGING_LEVEL&#39;&#39;),
</span><span style="color:#e6db74">        (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_CUSTOMIZED_LOGGING_LEVEL&#39;&#39;)
</span><span style="color:#e6db74">        )
</span><span style="color:#e6db74">        END
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">&#39;&#39;IntegrationServices[@Name=&#39;&#39; + quotename(CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname),&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;]&#39;&#39; + &#39;&#39;/Catalog[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE((SELECT Name from @t_catalogs), &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; + &#39;&#39;/CatalogFolder[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE(folders.[name], &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; + &#39;&#39;/ProjectInfo[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE(projects.[name], &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; AS [Urn],
</span><span style="color:#e6db74">projects.[project_id] AS [ProjectId],
</span><span style="color:#e6db74">projects.[folder_id] AS [FolderId],
</span><span style="color:#e6db74">projects.[name] AS [Name],
</span><span style="color:#e6db74">projects.[description] AS [Description],
</span><span style="color:#e6db74">projects.[project_format_version] AS [ProjectFormatVersion],
</span><span style="color:#e6db74">projects.[deployed_by_sid] AS [DeployedBySid],
</span><span style="color:#e6db74">projects.[deployed_by_name] AS [DeployedByName],
</span><span style="color:#e6db74">CAST (projects.[last_deployed_time] AS datetime) AS [LastDeployedTime],
</span><span style="color:#e6db74">CAST (projects.[created_time] AS datetime) AS [CreatedTime],
</span><span style="color:#e6db74">projects.[object_version_lsn] AS [ObjectVersionLsn],
</span><span style="color:#e6db74">projects.[validation_status] AS [ValidationStatus],
</span><span style="color:#e6db74">CAST (projects.[last_validation_time] AS datetime) AS [LastValidationTime]
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">[SSISDB].[catalog].[folders] AS folders
</span><span style="color:#e6db74">INNER JOIN [SSISDB].[catalog].[projects] AS projects ON projects.[folder_id]=folders.[folder_id]
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">(folders.[name]=@_msparam_0)and(((SELECT Name from @t_catalogs)=@_msparam_1)and((CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname)=@_msparam_2)))&#39;</span>,N<span style="color:#e6db74">&#39;@_msparam_0 nvarchar(4000),@_msparam_1 nvarchar(4000),@_msparam_2 nvarchar(4000)&#39;</span>,<span style="color:#f92672">@</span>_msparam_0<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Test&#39;</span>,<span style="color:#f92672">@</span>_msparam_1<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;SSISDB&#39;</span>,<span style="color:#f92672">@</span>_msparam_2<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;WIN-LFVELR2F095&#39;</span>
</code></pre></div><p>When I run the steps 3, 4, 5 I got those results (pivoted for better readability):</p>
<table>
<thead>
<tr>
<th></th>
<th>Step 3</th>
</tr>
</thead>
<tbody>
<tr>
<td>Urn</td>
<td>IntegrationServices[@Name=&lsquo;WIN-LFVELR2F095&rsquo;]/Catalog[@Name=&lsquo;SSISDB&rsquo;]</td>
</tr>
<tr>
<td>Name</td>
<td>SSISDB</td>
</tr>
<tr>
<td>EncryptionAlgorithm</td>
<td>AES_256</td>
</tr>
<tr>
<td>SchemaVersion</td>
<td>5</td>
</tr>
<tr>
<td>SchemaBuild</td>
<td>14.0.500.272</td>
</tr>
<tr>
<td>OperationLogRetentionTime</td>
<td>365</td>
</tr>
<tr>
<td>MaxProjectVersions</td>
<td>10</td>
</tr>
<tr>
<td>OperationCleanupEnabled</td>
<td>1</td>
</tr>
<tr>
<td>VersionCleanupEnabled</td>
<td>1</td>
</tr>
<tr>
<td>ServerLoggingLevel</td>
<td>1</td>
</tr>
<tr>
<td>ServerCustomizedLoggingLevel</td>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th></th>
<th>Step 4</th>
</tr>
</thead>
<tbody>
<tr>
<td>Urn</td>
<td>IntegrationServices[@Name=&lsquo;WIN-LFVELR2F095&rsquo;]/Catalog[@Name=&lsquo;SSISDB&rsquo;]/CatalogFolder[@Name=&lsquo;Test&rsquo;]</td>
</tr>
<tr>
<td>FolderId</td>
<td>1</td>
</tr>
<tr>
<td>Name</td>
<td>Test</td>
</tr>
<tr>
<td>Description</td>
<td></td>
</tr>
<tr>
<td>CreatedBySid</td>
<td>0x0105000000000005150000003418BD4E479DAA9DB7F7C36DF4010000</td>
</tr>
<tr>
<td>CreatedByName</td>
<td>WIN-LFVELR2F095\Administrator</td>
</tr>
<tr>
<td>CreatedDate</td>
<td>2017-04-23 12:31:23.030</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th></th>
<th>Step 5</th>
</tr>
</thead>
<tbody>
<tr>
<td>Urn</td>
<td>IntegrationServices[@Name=&lsquo;WIN-LFVELR2F095&rsquo;]/Catalog[@Name=&lsquo;SSISDB&rsquo;]/CatalogFolder[@Name=&lsquo;Test&rsquo;]/ProjectInfo[@Name=&lsquo;TestSSIS&rsquo;]</td>
</tr>
<tr>
<td>ProjectId</td>
<td>1</td>
</tr>
<tr>
<td>FolderId</td>
<td>1</td>
</tr>
<tr>
<td>Name</td>
<td>TestSSIS</td>
</tr>
<tr>
<td>Description</td>
<td></td>
</tr>
<tr>
<td>ProjectFormatVersion</td>
<td>1</td>
</tr>
<tr>
<td>DeployedBySid</td>
<td>0x0105000000000005150000003418BD4E479DAA9DB7F7C36DF4010000</td>
</tr>
<tr>
<td>DeployedByName</td>
<td>WIN-LFVELR2F095\Administrator</td>
</tr>
<tr>
<td>LastDeployedTime</td>
<td>30.04.2017 01:30</td>
</tr>
<tr>
<td>CreatedTime</td>
<td>23.04.2017 12:32</td>
</tr>
<tr>
<td>ObjectVersionLsn</td>
<td>14</td>
</tr>
<tr>
<td>ValidationStatus</td>
<td>N</td>
</tr>
<tr>
<td>LastValidationTime</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>Excellent. What next? Until now the commands were issued by <em>SSIS Deployment Wizard</em> application. Next few lines come from <em>SSIS ISServerExec</em>. The first one is pretty simple, yet I have to think more about it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">exec</span> sp_executesql N<span style="color:#e6db74">&#39;SELECT [operation_id] FROM [catalog].[operations] WHERE [operation_id] = @operation_id AND [status] = @status&#39;</span>,N<span style="color:#e6db74">&#39;@operation_id bigint,@status int&#39;</span>,<span style="color:#f92672">@</span>operation_id<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,<span style="color:#f92672">@</span>status<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</code></pre></div><p>The question is: how does the <em>SSIS ISServerExec</em> proces know the value of <code>@operation_id</code>? <code>@status = 2</code> means it checks if <a href="https://docs.microsoft.com/en-us/sql/integration-services/system-views/catalog-operations-ssisdb-database">process is running</a>.</p>
<p>To get the answer we have to take a closer look at the profiler output. The entire deployment finishes in 7 seconds, so it&rsquo;s hard to spot, but when I did I asked myself why I didn&rsquo;t see it before?</p>
<p><a href="images/Profiler03.png"><img src="images/Profiler03-1024x425.png" alt="Profiler output"></a></p>
<p>To tell you the truth I saw the operations times just after analysing <code>catalog.deploy_project</code> procedure (see the line starting with <code>declare @p4</code>). It has a WHILE loop inside waiting for some output. But output coming from what?</p>
<p>The <em>SSIS ISServerExec</em> data in the profiler window (3 - 20:49:30) is shown before the deployment process start (2 - 20:49:28). Suddenly all becomes clear - <code>catalog.deploy_project</code> waits for <em>ISServerExec</em> to finish its job. It checks for deployment status each second and finishes when the status is set as not running (<code>@status &lt;&gt; 2</code>). So, to analyse the process I have to start with the line (2). <code>@project_stream</code> is cut for readability.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">declare</span> <span style="color:#f92672">@</span>p4 bigint
<span style="color:#66d9ef">set</span> <span style="color:#f92672">@</span>p4<span style="color:#f92672">=</span><span style="color:#66d9ef">default</span>
<span style="color:#66d9ef">exec</span> [SSISDB].[<span style="color:#66d9ef">catalog</span>].[deploy_project] <span style="color:#f92672">@</span>folder_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Test&#39;</span>,<span style="color:#f92672">@</span>project_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;TestSSIS&#39;</span>,<span style="color:#f92672">@</span>project_stream<span style="color:#f92672">=`</span><span style="color:#ae81ff">0</span>x504B03041400000008002E<span style="color:#f92672">`&lt;</span>...<span style="color:#f92672">&gt;</span>,<span style="color:#f92672">@</span>operation_id<span style="color:#f92672">=@</span>p4 <span style="color:#66d9ef">output</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">@</span>p4
</code></pre></div><p>Afterwards I noted that if I used RPC:Starting event I would spot it earlier - the starting event is before start of <em>ISServerExec</em>.</p>
<p>The main part of the deployment has started and now we are on <em>SSIS ISServerExec</em> side. The next line gets project binary data provided by <code>catalog.deploy_project</code> .</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">exec</span> [internal].[get_project_internal] <span style="color:#f92672">@</span>project_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>project_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>project_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;TestSSIS&#39;</span>
</code></pre></div><p>As a result, we get our project stream (<code>0x504B03041400000008002E...)</code> What&rsquo;s interesting - this command is run by another user - the NTUserName column in Profiler shows SID <code>S-1-9-3...</code> We can check what user is this using simple conversion, but I was lazy and just <a href="http://wermspowke.blogspot.com/2013/03/converting-sql-server-sids-to-login.html">used the script I found on the internet</a>. The SID points to <code>AllSchemaUser</code> user in <code>SSISDB</code> database. And when we take a look into <code>internal.get_project_internal</code> procedure we see, that it&rsquo;s run in a context of <code>AllSchemaUser</code>.</p>
<p><a href="images/internal.get_project_internal.png"><img src="images/internal.get_project_internal.png" alt="GetProjectInternal stored procedure header"></a></p>
<p>The next commands insert package data into <code>internal.packages</code> table using <code>internal.append_packages</code> procedure and custom table type <code>internal.PackageTableType</code>. The information comes from the project stream. As the <code>.ispac</code> is just a zip file with different extension the <em>SSIS ISServerExec</em> unpacks it and gets the content.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">declare</span> <span style="color:#f92672">@</span>p3 internal.PackageTableType
<span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">@</span>p3 <span style="color:#66d9ef">values</span>(N<span style="color:#e6db74">&#39;Package01.dtsx&#39;</span>,<span style="color:#e6db74">&#39;EB3054D0-31D0-4476-A922-EC9CE30789DB&#39;</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#e6db74">&#39;33FD504B-57AB-4659-A4D5-F1336537A3A6&#39;</span>,<span style="color:#ae81ff">1</span>,N<span style="color:#e6db74">&#39;N&#39;</span>,<span style="color:#66d9ef">NULL</span>,<span style="color:#66d9ef">NULL</span>)
<span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">@</span>p3 <span style="color:#66d9ef">values</span>(N<span style="color:#e6db74">&#39;Package05.dtsx&#39;</span>,<span style="color:#e6db74">&#39;412802DC-3D72-43E3-9D7D-BF731685676A&#39;</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#e6db74">&#39;29869950-CA90-4D54-BA4E-1AFD2DE6794E&#39;</span>,<span style="color:#ae81ff">1</span>,N<span style="color:#e6db74">&#39;N&#39;</span>,<span style="color:#66d9ef">NULL</span>,<span style="color:#66d9ef">NULL</span>)
<span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">@</span>p3 <span style="color:#66d9ef">values</span>(N<span style="color:#e6db74">&#39;Package04.dtsx&#39;</span>,<span style="color:#e6db74">&#39;C57A813A-32CB-485D-9B34-8AFA5797B825&#39;</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#e6db74">&#39;7B4935B4-C59E-4F89-80C1-8D9C17C3E5E3&#39;</span>,<span style="color:#ae81ff">1</span>,N<span style="color:#e6db74">&#39;N&#39;</span>,<span style="color:#66d9ef">NULL</span>,<span style="color:#66d9ef">NULL</span>)
<span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">@</span>p3 <span style="color:#66d9ef">values</span>(N<span style="color:#e6db74">&#39;Package03.dtsx&#39;</span>,<span style="color:#e6db74">&#39;149A4EFF-05A6-4F3E-AB85-F7C07D271B37&#39;</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#e6db74">&#39;2880FA80-E65A-4153-8EE3-BDB71A35FF60&#39;</span>,<span style="color:#ae81ff">1</span>,N<span style="color:#e6db74">&#39;N&#39;</span>,<span style="color:#66d9ef">NULL</span>,<span style="color:#66d9ef">NULL</span>)
<span style="color:#66d9ef">insert</span> <span style="color:#66d9ef">into</span> <span style="color:#f92672">@</span>p3 <span style="color:#66d9ef">values</span>(N<span style="color:#e6db74">&#39;Package02.dtsx&#39;</span>,<span style="color:#e6db74">&#39;A2D88A81-51B7-433B-9B11-696478AC0594&#39;</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#ae81ff">8</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#e6db74">&#39;4B68DACB-EE94-4580-95EF-4FF62BFCF121&#39;</span>,<span style="color:#ae81ff">1</span>,N<span style="color:#e6db74">&#39;N&#39;</span>,<span style="color:#66d9ef">NULL</span>,<span style="color:#66d9ef">NULL</span>)

<span style="color:#66d9ef">exec</span> [internal].[append_packages] <span style="color:#f92672">@</span>project_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>object_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>packages_data<span style="color:#f92672">=@</span>p3
</code></pre></div><p>Then we add all parameters with <code>internal.append_parameter</code> procedure. We have six project parameters (and zero connection managers, zero package parameters) so we call it six times. Each procedure execution is made in another database call, so if we have a lot of parameters then we do a lot of single database queries. If we had connection managers and package parameters they would be also added with <code>internal.append_parameter</code>. With a small remark - each part of the connection string is treated as a different parameter.</p>
<p>All the information go to the <code>internal.object_parameters</code> table.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">exec</span> [internal].[append_parameter] <span style="color:#f92672">@</span>project_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>object_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>object_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;TestSSIS&#39;</span>,<span style="color:#f92672">@</span>object_type<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>,<span style="color:#f92672">@</span>parameter_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Parameter1&#39;</span>,<span style="color:#f92672">@</span>parameter_data_type<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Int32&#39;</span>,<span style="color:#f92672">@</span>required<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span><span style="color:#66d9ef">sensitive</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span>description<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#f92672">@</span>design_default_value<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>value_set<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">go</span>
<span style="color:#66d9ef">exec</span> [internal].[append_parameter] <span style="color:#f92672">@</span>project_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>object_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>object_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;TestSSIS&#39;</span>,<span style="color:#f92672">@</span>object_type<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>,<span style="color:#f92672">@</span>parameter_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Parameter2&#39;</span>,<span style="color:#f92672">@</span>parameter_data_type<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;String&#39;</span>,<span style="color:#f92672">@</span>required<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span><span style="color:#66d9ef">sensitive</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span>description<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#f92672">@</span>design_default_value<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#f92672">@</span>value_set<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">go</span>
<span style="color:#66d9ef">exec</span> [internal].[append_parameter] <span style="color:#f92672">@</span>project_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>object_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>object_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;TestSSIS&#39;</span>,<span style="color:#f92672">@</span>object_type<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>,<span style="color:#f92672">@</span>parameter_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Parameter3&#39;</span>,<span style="color:#f92672">@</span>parameter_data_type<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;UInt32&#39;</span>,<span style="color:#f92672">@</span>required<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span><span style="color:#66d9ef">sensitive</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span>description<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#f92672">@</span>design_default_value<span style="color:#f92672">=</span><span style="color:#ae81ff">333</span>,<span style="color:#f92672">@</span>value_set<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">go</span>
<span style="color:#66d9ef">exec</span> [internal].[append_parameter] <span style="color:#f92672">@</span>project_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>object_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>object_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;TestSSIS&#39;</span>,<span style="color:#f92672">@</span>object_type<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>,<span style="color:#f92672">@</span>parameter_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Parameter4&#39;</span>,<span style="color:#f92672">@</span>parameter_data_type<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Boolean&#39;</span>,<span style="color:#f92672">@</span>required<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span><span style="color:#66d9ef">sensitive</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span>description<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#f92672">@</span>design_default_value<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span>value_set<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">go</span>
<span style="color:#66d9ef">exec</span> [internal].[append_parameter] <span style="color:#f92672">@</span>project_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>object_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>object_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;TestSSIS&#39;</span>,<span style="color:#f92672">@</span>object_type<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>,<span style="color:#f92672">@</span>parameter_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Parameter5&#39;</span>,<span style="color:#f92672">@</span>parameter_data_type<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Single&#39;</span>,<span style="color:#f92672">@</span>required<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span><span style="color:#66d9ef">sensitive</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span>description<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#f92672">@</span>design_default_value<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,<span style="color:#f92672">@</span>value_set<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">go</span>
<span style="color:#66d9ef">exec</span> [internal].[append_parameter] <span style="color:#f92672">@</span>project_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>object_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>object_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;TestSSIS&#39;</span>,<span style="color:#f92672">@</span>object_type<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>,<span style="color:#f92672">@</span>parameter_name<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Parameter6&#39;</span>,<span style="color:#f92672">@</span>parameter_data_type<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Int64&#39;</span>,<span style="color:#f92672">@</span>required<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span><span style="color:#66d9ef">sensitive</span><span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,<span style="color:#f92672">@</span>description<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#f92672">@</span>design_default_value<span style="color:#f92672">=</span><span style="color:#ae81ff">666666</span>,<span style="color:#f92672">@</span>value_set<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">go</span>
</code></pre></div><p>Aside sample of sample ADO.NET connection manager parametrization:</p>
<p><img src="images/Profiler02-1024x392.png" alt="Profiler output"></p>
<p>OK. Parameters set up. Now a piece of code I don&rsquo;t fully understand. It runs a synchronisation of parameters between latest project version and currently deployed version:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">exec</span> [internal].[sync_parameter_versions] <span style="color:#f92672">@</span>project_id<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>,<span style="color:#f92672">@</span>object_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>
</code></pre></div><p>What I don&rsquo;t get is why do we sync current version with the latest version, when the current version is already the latest? I don&rsquo;t think it has something with concurrent deployments as the procedures start transactions in SERIALIZABLE isolation level. Will have to investigate it further.</p>
<p>Almost the end. The last command run as <em>SSIS ISServerExec</em> application is updating the deployment status as a great success (<code>@status = 7</code>). Looks like nothing fancy, just simple update, but there&rsquo;s a bit of logic there, including cleanup in case of failed deployment. This procedure is also run as <code>AllSchemaUser</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">exec</span> [internal].[update_project_deployment_status] <span style="color:#f92672">@</span>status<span style="color:#f92672">=</span><span style="color:#ae81ff">7</span>,<span style="color:#f92672">@</span>end_time<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2017-04-26 20:49:30.8732399 +02:00&#39;</span>,<span style="color:#f92672">@</span>operation_id<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,<span style="color:#f92672">@</span>project_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>description<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;&#39;</span>,<span style="color:#f92672">@</span>project_format_version<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</code></pre></div><p>When project deployment finishes <em>SSIS Deployment Wizard</em> takes control back. It fires four dynamic SQL statements. First two are identical - they check for deployment operation information (I don;t know why the same code run twice), the third checks for projects in a folder and then iterates through each project to get its data. I have one project in my folder, so it is just one SQL statement. If I had more projects I would get a separate statement for each of them (checked with another project).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- =======================
</span><span style="color:#75715e">-- Get operation details
</span><span style="color:#75715e">-- =======================
</span><span style="color:#75715e"></span><span style="color:#66d9ef">exec</span> sp_executesql N<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74"> --Preparing to access the Catalog object
</span><span style="color:#e6db74"> DECLARE @t_catalogs TABLE (
</span><span style="color:#e6db74"> Name sysname COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> EncryptionAlgorithm nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> SchemaVersion int,
</span><span style="color:#e6db74"> SchemaBuild nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> OperationLogRetentionTime int,
</span><span style="color:#e6db74"> MaxProjectVersions int,
</span><span style="color:#e6db74"> OperationCleanupEnabled bit,
</span><span style="color:#e6db74"> VersionCleanupEnabled bit,
</span><span style="color:#e6db74"> ServerLoggingLevel int,
</span><span style="color:#e6db74"> ServerCustomizedLoggingLevel nvarchar(128))
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"> IF DB_ID(&#39;&#39;SSISDB&#39;&#39;) IS NOT NULL
</span><span style="color:#e6db74"> BEGIN
</span><span style="color:#e6db74"> INSERT INTO @t_catalogs VALUES(
</span><span style="color:#e6db74"> &#39;&#39;SSISDB&#39;&#39;,
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;ENCRYPTION_ALGORITHM&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SCHEMA_VERSION&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SCHEMA_BUILD&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;RETENTION_WINDOW&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;MAX_PROJECT_VERSIONS&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;OPERATION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;VERSION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_LOGGING_LEVEL&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_CUSTOMIZED_LOGGING_LEVEL&#39;&#39;)
</span><span style="color:#e6db74"> )
</span><span style="color:#e6db74"> END
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">&#39;&#39;IntegrationServices[@Name=&#39;&#39; + quotename(CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname),&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;]&#39;&#39; + &#39;&#39;/Catalog[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE((SELECT Name from @t_catalogs), &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; + &#39;&#39;/Operation[@Id=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE(ops.[operation_id], &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; AS [Urn],
</span><span style="color:#e6db74">ops.[operation_id] AS [Id],
</span><span style="color:#e6db74">ops.[operation_type] AS [OperationType],
</span><span style="color:#e6db74">CAST (ops.[created_time] AS datetime) AS [CreatedTime],
</span><span style="color:#e6db74">ops.[object_type] AS [ObjectType],
</span><span style="color:#e6db74">ops.[object_id] AS [ObjectId],
</span><span style="color:#e6db74">ops.[object_name] AS [ObjectName],
</span><span style="color:#e6db74">ops.[status] AS [Status],
</span><span style="color:#e6db74">CAST (ops.[start_time] AS datetime) AS [StartTime],
</span><span style="color:#e6db74">CAST (ops.[end_time] AS datetime) AS [EndTime],
</span><span style="color:#e6db74">ops.[caller_sid] AS [CallerSid],
</span><span style="color:#e6db74">ops.[caller_name] AS [CallerName],
</span><span style="color:#e6db74">ops.[process_id] AS [ProcessId],
</span><span style="color:#e6db74">ops.[stopped_by_sid] AS [StoppedBySid],
</span><span style="color:#e6db74">ops.[stopped_by_name] AS [StoppedByName]
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">[SSISDB].[catalog].[operations] AS ops
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">(ops.[operation_id]=@_msparam_0)and(((SELECT Name from @t_catalogs)=@_msparam_1)and((CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname)=@_msparam_2)))&#39;</span>,N<span style="color:#e6db74">&#39;@_msparam_0 nvarchar(4000),@_msparam_1 nvarchar(4000),@_msparam_2 nvarchar(4000)&#39;</span>,<span style="color:#f92672">@</span>_msparam_0<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;5&#39;</span>,<span style="color:#f92672">@</span>_msparam_1<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;SSISDB&#39;</span>,<span style="color:#f92672">@</span>_msparam_2<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;WIN-LFVELR2F095&#39;</span>

<span style="color:#75715e">-- =======================
</span><span style="color:#75715e">-- Get operation details (again)
</span><span style="color:#75715e">-- =======================
</span><span style="color:#75715e"></span><span style="color:#66d9ef">exec</span> sp_executesql N<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74"> --Preparing to access the Catalog object
</span><span style="color:#e6db74"> DECLARE @t_catalogs TABLE (
</span><span style="color:#e6db74"> Name sysname COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> EncryptionAlgorithm nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> SchemaVersion int,
</span><span style="color:#e6db74"> SchemaBuild nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> OperationLogRetentionTime int,
</span><span style="color:#e6db74"> MaxProjectVersions int,
</span><span style="color:#e6db74"> OperationCleanupEnabled bit,
</span><span style="color:#e6db74"> VersionCleanupEnabled bit,
</span><span style="color:#e6db74"> ServerLoggingLevel int,
</span><span style="color:#e6db74"> ServerCustomizedLoggingLevel nvarchar(128))
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"> IF DB_ID(&#39;&#39;SSISDB&#39;&#39;) IS NOT NULL
</span><span style="color:#e6db74"> BEGIN
</span><span style="color:#e6db74"> INSERT INTO @t_catalogs VALUES(
</span><span style="color:#e6db74"> &#39;&#39;SSISDB&#39;&#39;,
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;ENCRYPTION_ALGORITHM&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SCHEMA_VERSION&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SCHEMA_BUILD&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;RETENTION_WINDOW&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;MAX_PROJECT_VERSIONS&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;OPERATION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;VERSION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_LOGGING_LEVEL&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_CUSTOMIZED_LOGGING_LEVEL&#39;&#39;)
</span><span style="color:#e6db74"> )
</span><span style="color:#e6db74"> END
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">&#39;&#39;IntegrationServices[@Name=&#39;&#39; + quotename(CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname),&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;]&#39;&#39; + &#39;&#39;/Catalog[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE((SELECT Name from @t_catalogs), &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; + &#39;&#39;/Operation[@Id=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE(ops.[operation_id], &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; AS [Urn],
</span><span style="color:#e6db74">ops.[operation_id] AS [Id],
</span><span style="color:#e6db74">ops.[operation_type] AS [OperationType],
</span><span style="color:#e6db74">CAST (ops.[created_time] AS datetime) AS [CreatedTime],
</span><span style="color:#e6db74">ops.[object_type] AS [ObjectType],
</span><span style="color:#e6db74">ops.[object_id] AS [ObjectId],
</span><span style="color:#e6db74">ops.[object_name] AS [ObjectName],
</span><span style="color:#e6db74">ops.[status] AS [Status],
</span><span style="color:#e6db74">CAST (ops.[start_time] AS datetime) AS [StartTime],
</span><span style="color:#e6db74">CAST (ops.[end_time] AS datetime) AS [EndTime],
</span><span style="color:#e6db74">ops.[caller_sid] AS [CallerSid],
</span><span style="color:#e6db74">ops.[caller_name] AS [CallerName],
</span><span style="color:#e6db74">ops.[process_id] AS [ProcessId],
</span><span style="color:#e6db74">ops.[stopped_by_sid] AS [StoppedBySid],
</span><span style="color:#e6db74">ops.[stopped_by_name] AS [StoppedByName]
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">[SSISDB].[catalog].[operations] AS ops
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">(ops.[operation_id]=@_msparam_0)and(((SELECT Name from @t_catalogs)=@_msparam_1)and((CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname)=@_msparam_2)))&#39;</span>,N<span style="color:#e6db74">&#39;@_msparam_0 nvarchar(4000),@_msparam_1 nvarchar(4000),@_msparam_2 nvarchar(4000)&#39;</span>,<span style="color:#f92672">@</span>_msparam_0<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;5&#39;</span>,<span style="color:#f92672">@</span>_msparam_1<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;SSISDB&#39;</span>,<span style="color:#f92672">@</span>_msparam_2<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;WIN-LFVELR2F095&#39;</span>

<span style="color:#75715e">-- =======================
</span><span style="color:#75715e">-- Get all projects from the folder
</span><span style="color:#75715e">-- =======================
</span><span style="color:#75715e"></span><span style="color:#66d9ef">exec</span> sp_executesql N<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74"> --Preparing to access the Catalog object
</span><span style="color:#e6db74"> DECLARE @t_catalogs TABLE (
</span><span style="color:#e6db74"> Name sysname COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> EncryptionAlgorithm nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> SchemaVersion int,
</span><span style="color:#e6db74"> SchemaBuild nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> OperationLogRetentionTime int,
</span><span style="color:#e6db74"> MaxProjectVersions int,
</span><span style="color:#e6db74"> OperationCleanupEnabled bit,
</span><span style="color:#e6db74"> VersionCleanupEnabled bit,
</span><span style="color:#e6db74"> ServerLoggingLevel int,
</span><span style="color:#e6db74"> ServerCustomizedLoggingLevel nvarchar(128))
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"> IF DB_ID(&#39;&#39;SSISDB&#39;&#39;) IS NOT NULL
</span><span style="color:#e6db74"> BEGIN
</span><span style="color:#e6db74"> INSERT INTO @t_catalogs VALUES(
</span><span style="color:#e6db74"> &#39;&#39;SSISDB&#39;&#39;,
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;ENCRYPTION_ALGORITHM&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SCHEMA_VERSION&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SCHEMA_BUILD&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;RETENTION_WINDOW&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;MAX_PROJECT_VERSIONS&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;OPERATION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;VERSION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_LOGGING_LEVEL&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_CUSTOMIZED_LOGGING_LEVEL&#39;&#39;)
</span><span style="color:#e6db74"> )
</span><span style="color:#e6db74"> END
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">&#39;&#39;IntegrationServices[@Name=&#39;&#39; + quotename(CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname),&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;]&#39;&#39; + &#39;&#39;/Catalog[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE((SELECT Name from @t_catalogs), &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; + &#39;&#39;/CatalogFolder[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE(folders.[name], &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; + &#39;&#39;/ProjectInfo[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE(projects.[name], &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; AS [Urn],
</span><span style="color:#e6db74">projects.[project_id] AS [ProjectId],
</span><span style="color:#e6db74">projects.[folder_id] AS [FolderId],
</span><span style="color:#e6db74">projects.[name] AS [Name],
</span><span style="color:#e6db74">projects.[description] AS [Description],
</span><span style="color:#e6db74">projects.[project_format_version] AS [ProjectFormatVersion],
</span><span style="color:#e6db74">projects.[deployed_by_sid] AS [DeployedBySid],
</span><span style="color:#e6db74">projects.[deployed_by_name] AS [DeployedByName],
</span><span style="color:#e6db74">CAST (projects.[last_deployed_time] AS datetime) AS [LastDeployedTime],
</span><span style="color:#e6db74">CAST (projects.[created_time] AS datetime) AS [CreatedTime],
</span><span style="color:#e6db74">projects.[object_version_lsn] AS [ObjectVersionLsn],
</span><span style="color:#e6db74">projects.[validation_status] AS [ValidationStatus],
</span><span style="color:#e6db74">CAST (projects.[last_validation_time] AS datetime) AS [LastValidationTime]
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">[SSISDB].[catalog].[folders] AS folders
</span><span style="color:#e6db74">INNER JOIN [SSISDB].[catalog].[projects] AS projects ON projects.[folder_id]=folders.[folder_id]
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">(folders.[name]=@_msparam_0)and(((SELECT Name from @t_catalogs)=@_msparam_1)and((CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname)=@_msparam_2)))&#39;</span>,N<span style="color:#e6db74">&#39;@_msparam_0 nvarchar(4000),@_msparam_1 nvarchar(4000),@_msparam_2 nvarchar(4000)&#39;</span>,<span style="color:#f92672">@</span>_msparam_0<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Test&#39;</span>,<span style="color:#f92672">@</span>_msparam_1<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;SSISDB&#39;</span>,<span style="color:#f92672">@</span>_msparam_2<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;WIN-LFVELR2F095&#39;</span>

<span style="color:#75715e">-- =======================
</span><span style="color:#75715e">-- Get project details
</span><span style="color:#75715e">-- =======================
</span><span style="color:#75715e"></span><span style="color:#66d9ef">exec</span> sp_executesql N<span style="color:#e6db74">&#39;
</span><span style="color:#e6db74"> --Preparing to access the Catalog object
</span><span style="color:#e6db74"> DECLARE @t_catalogs TABLE (
</span><span style="color:#e6db74"> Name sysname COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> EncryptionAlgorithm nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> SchemaVersion int,
</span><span style="color:#e6db74"> SchemaBuild nvarchar(256) COLLATE SQL_Latin1_General_CP1_CI_AS,
</span><span style="color:#e6db74"> OperationLogRetentionTime int,
</span><span style="color:#e6db74"> MaxProjectVersions int,
</span><span style="color:#e6db74"> OperationCleanupEnabled bit,
</span><span style="color:#e6db74"> VersionCleanupEnabled bit,
</span><span style="color:#e6db74"> ServerLoggingLevel int,
</span><span style="color:#e6db74"> ServerCustomizedLoggingLevel nvarchar(128))
</span><span style="color:#e6db74">
</span><span style="color:#e6db74"> IF DB_ID(&#39;&#39;SSISDB&#39;&#39;) IS NOT NULL
</span><span style="color:#e6db74"> BEGIN
</span><span style="color:#e6db74"> INSERT INTO @t_catalogs VALUES(
</span><span style="color:#e6db74"> &#39;&#39;SSISDB&#39;&#39;,
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;ENCRYPTION_ALGORITHM&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SCHEMA_VERSION&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SCHEMA_BUILD&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;RETENTION_WINDOW&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;MAX_PROJECT_VERSIONS&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;OPERATION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS BIT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;VERSION_CLEANUP_ENABLED&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT CAST([property_value] AS INT) FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_LOGGING_LEVEL&#39;&#39;),
</span><span style="color:#e6db74"> (SELECT [property_value] FROM [SSISDB].[catalog].[catalog_properties] WHERE [property_name] = N&#39;&#39;SERVER_CUSTOMIZED_LOGGING_LEVEL&#39;&#39;)
</span><span style="color:#e6db74"> )
</span><span style="color:#e6db74"> END
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">SELECT
</span><span style="color:#e6db74">&#39;&#39;IntegrationServices[@Name=&#39;&#39; + quotename(CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname),&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;]&#39;&#39; + &#39;&#39;/Catalog[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE((SELECT Name from @t_catalogs), &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; + &#39;&#39;/CatalogFolder[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE(folders.[name], &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; + &#39;&#39;/ProjectInfo[@Name=&#39;&#39; + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + REPLACE(projects.[name], &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;, &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39;) + &#39;&#39;&#39;&#39;&#39;&#39;&#39;&#39; + &#39;&#39;]&#39;&#39; AS [Urn],
</span><span style="color:#e6db74">projects.[project_id] AS [ProjectId],
</span><span style="color:#e6db74">projects.[folder_id] AS [FolderId],
</span><span style="color:#e6db74">projects.[name] AS [Name],
</span><span style="color:#e6db74">projects.[description] AS [Description],
</span><span style="color:#e6db74">projects.[project_format_version] AS [ProjectFormatVersion],
</span><span style="color:#e6db74">projects.[deployed_by_sid] AS [DeployedBySid],
</span><span style="color:#e6db74">projects.[deployed_by_name] AS [DeployedByName],
</span><span style="color:#e6db74">CAST (projects.[last_deployed_time] AS datetime) AS [LastDeployedTime],
</span><span style="color:#e6db74">CAST (projects.[created_time] AS datetime) AS [CreatedTime],
</span><span style="color:#e6db74">projects.[object_version_lsn] AS [ObjectVersionLsn],
</span><span style="color:#e6db74">projects.[validation_status] AS [ValidationStatus],
</span><span style="color:#e6db74">CAST (projects.[last_validation_time] AS datetime) AS [LastValidationTime]
</span><span style="color:#e6db74">FROM
</span><span style="color:#e6db74">[SSISDB].[catalog].[folders] AS folders
</span><span style="color:#e6db74">INNER JOIN [SSISDB].[catalog].[projects] AS projects ON projects.[folder_id]=folders.[folder_id]
</span><span style="color:#e6db74">WHERE
</span><span style="color:#e6db74">(projects.[name]=@_msparam_0)and((folders.[name]=@_msparam_1)and(((SELECT Name from @t_catalogs)=@_msparam_2)and((CAST(SERVERPROPERTY(N&#39;&#39;Servername&#39;&#39;) AS sysname)=@_msparam_3))))&#39;</span>,N<span style="color:#e6db74">&#39;@_msparam_0 nvarchar(4000),@_msparam_1 nvarchar(4000),@_msparam_2 nvarchar(4000),@_msparam_3 nvarchar(4000)&#39;</span>,<span style="color:#f92672">@</span>_msparam_0<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;TestSSIS&#39;</span>,<span style="color:#f92672">@</span>_msparam_1<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;Test&#39;</span>,<span style="color:#f92672">@</span>_msparam_2<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;SSISDB&#39;</span>,<span style="color:#f92672">@</span>_msparam_3<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;WIN-LFVELR2F095&#39;</span>
</code></pre></div><p>And the results are:</p>
<table>
<thead>
<tr>
<th></th>
<th>Get operation details</th>
</tr>
</thead>
<tbody>
<tr>
<td>Urn</td>
<td>IntegrationServices[@Name=&lsquo;WIN-LFVELR2F095&rsquo;]/Catalog[@Name=&lsquo;SSISDB&rsquo;]/Operation[@Id=&lsquo;5&rsquo;]</td>
</tr>
<tr>
<td>Id</td>
<td>5</td>
</tr>
<tr>
<td>OperationType</td>
<td>101</td>
</tr>
<tr>
<td>CreatedTime</td>
<td>26.04.2017 20:49</td>
</tr>
<tr>
<td>ObjectType</td>
<td>20</td>
</tr>
<tr>
<td>ObjectId</td>
<td>1</td>
</tr>
<tr>
<td>ObjectName</td>
<td>TestSSIS</td>
</tr>
<tr>
<td>Status</td>
<td>7</td>
</tr>
<tr>
<td>StartTime</td>
<td>26.04.2017 20:49</td>
</tr>
<tr>
<td>EndTime</td>
<td>26.04.2017 20:49</td>
</tr>
<tr>
<td>CallerSid</td>
<td>0x0105000000000005150000003418BD4E479DAA9DB7F7C36DF4010000</td>
</tr>
<tr>
<td>CallerName</td>
<td>WIN-LFVELR2F095\Administrator</td>
</tr>
<tr>
<td>ProcessId</td>
<td>7144</td>
</tr>
<tr>
<td>StoppedBySid</td>
<td>NULL</td>
</tr>
<tr>
<td>StoppedByName</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th></th>
<th>Get operation details (again)</th>
</tr>
</thead>
<tbody>
<tr>
<td>Urn</td>
<td>IntegrationServices[@Name=&lsquo;WIN-LFVELR2F095&rsquo;]/Catalog[@Name=&lsquo;SSISDB&rsquo;]/Operation[@Id=&lsquo;5&rsquo;]</td>
</tr>
<tr>
<td>Id</td>
<td>5</td>
</tr>
<tr>
<td>OperationType</td>
<td>101</td>
</tr>
<tr>
<td>CreatedTime</td>
<td>26.04.2017 20:49</td>
</tr>
<tr>
<td>ObjectType</td>
<td>20</td>
</tr>
<tr>
<td>ObjectId</td>
<td>1</td>
</tr>
<tr>
<td>ObjectName</td>
<td>TestSSIS</td>
</tr>
<tr>
<td>Status</td>
<td>7</td>
</tr>
<tr>
<td>StartTime</td>
<td>26.04.2017 20:49</td>
</tr>
<tr>
<td>EndTime</td>
<td>26.04.2017 20:49</td>
</tr>
<tr>
<td>CallerSid</td>
<td>0x0105000000000005150000003418BD4E479DAA9DB7F7C36DF4010000</td>
</tr>
<tr>
<td>CallerName</td>
<td>WIN-LFVELR2F095\Administrator</td>
</tr>
<tr>
<td>ProcessId</td>
<td>7144</td>
</tr>
<tr>
<td>StoppedBySid</td>
<td>NULL</td>
</tr>
<tr>
<td>StoppedByName</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th></th>
<th>Get all projects from the folder</th>
</tr>
</thead>
<tbody>
<tr>
<td>Urn</td>
<td>IntegrationServices[@Name=&lsquo;WIN-LFVELR2F095&rsquo;]/Catalog[@Name=&lsquo;SSISDB&rsquo;]/CatalogFolder[@Name=&lsquo;Test&rsquo;]/ProjectInfo[@Name=&lsquo;TestSSIS&rsquo;]</td>
</tr>
<tr>
<td>ProjectId</td>
<td>1</td>
</tr>
<tr>
<td>FolderId</td>
<td>1</td>
</tr>
<tr>
<td>Name</td>
<td>TestSSIS</td>
</tr>
<tr>
<td>Description</td>
<td></td>
</tr>
<tr>
<td>ProjectFormatVersion</td>
<td>1</td>
</tr>
<tr>
<td>DeployedBySid</td>
<td>0x0105000000000005150000003418BD4E479DAA9DB7F7C36DF4010000</td>
</tr>
<tr>
<td>DeployedByName</td>
<td>WIN-LFVELR2F095\Administrator</td>
</tr>
<tr>
<td>LastDeployedTime</td>
<td>03.05.2017 09:32</td>
</tr>
<tr>
<td>CreatedTime</td>
<td>23.04.2017 12:32</td>
</tr>
<tr>
<td>ObjectVersionLsn</td>
<td>25</td>
</tr>
<tr>
<td>ValidationStatus</td>
<td>N</td>
</tr>
<tr>
<td>LastValidationTime</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th></th>
<th>Get project details</th>
</tr>
</thead>
<tbody>
<tr>
<td>Urn</td>
<td>IntegrationServices[@Name=&lsquo;WIN-LFVELR2F095&rsquo;]/Catalog[@Name=&lsquo;SSISDB&rsquo;]/CatalogFolder[@Name=&lsquo;Test&rsquo;]/ProjectInfo[@Name=&lsquo;TestSSIS&rsquo;]</td>
</tr>
<tr>
<td>ProjectId</td>
<td>1</td>
</tr>
<tr>
<td>FolderId</td>
<td>1</td>
</tr>
<tr>
<td>Name</td>
<td>TestSSIS</td>
</tr>
<tr>
<td>Description</td>
<td></td>
</tr>
<tr>
<td>ProjectFormatVersion</td>
<td>1</td>
</tr>
<tr>
<td>DeployedBySid</td>
<td>0x0105000000000005150000003418BD4E479DAA9DB7F7C36DF4010000</td>
</tr>
<tr>
<td>DeployedByName</td>
<td>WIN-LFVELR2F095\Administrator</td>
</tr>
<tr>
<td>LastDeployedTime</td>
<td>03.05.2017 09:32</td>
</tr>
<tr>
<td>CreatedTime</td>
<td>23.04.2017 12:32</td>
</tr>
<tr>
<td>ObjectVersionLsn</td>
<td>25</td>
</tr>
<tr>
<td>ValidationStatus</td>
<td>N</td>
</tr>
<tr>
<td>LastValidationTime</td>
<td>NULL</td>
</tr>
</tbody>
</table>
<p>The last operation in deployment process is run by <em>SSIS ISServerExec Crash Handler</em>. It&rsquo;s almost the same command as the previous by <em>SSIS ISServerExec</em>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">exec</span> [internal].[update_project_deployment_status] <span style="color:#f92672">@</span>status<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span>,<span style="color:#f92672">@</span>end_time<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2017-04-26 20:49:32.7510757 +02:00&#39;</span>,<span style="color:#f92672">@</span>operation_id<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>,<span style="color:#f92672">@</span>project_version_lsn<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>,<span style="color:#f92672">@</span>description<span style="color:#f92672">=</span>N<span style="color:#e6db74">&#39;&#39;</span>
</code></pre></div><p>The difference is it doesn&rsquo;t contain <code>@project_format_version parameter</code>, sets different <code>@status</code> (4 = failed) and - of course - <code>@end_time</code>. And - it does nothing.</p>
<p>Well, it would set deployment status as failed if there was something wrong with the process, but the <code>internal.update_project_deployment_status</code> has a condition - it runs only:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span> (<span style="color:#66d9ef">SELECT</span> [operation_id] <span style="color:#66d9ef">FROM</span> [internal].[operations]
<span style="color:#66d9ef">WHERE</span> ([status] <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#66d9ef">OR</span> [status] <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
<span style="color:#66d9ef">OR</span> [status] <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>)
<span style="color:#66d9ef">AND</span> [operation_id] <span style="color:#f92672">=</span> <span style="color:#f92672">@</span>operation_id <span style="color:#66d9ef">AND</span> [operation_type] <span style="color:#f92672">=</span> <span style="color:#ae81ff">101</span>)
</code></pre></div><p>So if the process finished properly (<code>@status = 7</code>) nothing happens. I made the tests few times and sometimes te last step of <em>ISServerExec</em> process finished before the end of the <code>catalog.deploy_project</code> procedure.</p>
<p>The last thing to check is why <em>IsDeploymentWizard</em> finishes deployment so quickly and what happens behind the scenes.</p>
<p>To answer for the latter - it does the same steps as manual deployment. And how it does it so quickly? It just doesn&rsquo;t wait for the outcome before returning to console. But it still runs it the background. Look at the <code>cmd.exe</code> process on the top and <code>sqlservr.exe</code> process at the bottom. Click the picture to see the details.</p>
<p><a href="images/IsDeploymentWizard.gif"><img src="images/IsDeploymentWizard-1024x440.gif" alt="IsDeploymentWizard demo"></a></p>
<p>And that&rsquo;s all. So:</p>
<ul>
<li><code>/Silent</code> mode just returns to the console right after the process start</li>
<li>deployment involves two processes: <em>IsDeploymentWizard</em> and <em>ISServerExec</em></li>
<li>the <em>IsDeploymentWizard</em> waits until <em>ISServerExec</em> finishes its work checking the status within the <code>WHILE</code> loop on 1 second intervals</li>
<li>if the proces finished with success the last operation by <em>ISServerExec Crash handler</em> does nothing.</li>
</ul>
<p>The communication between <em>SSISDB</em> and <em>ISServerExec</em> (and <em>ISServerExec</em> itself) is a great candidate for another post in near future.</p>

      </div>
      <footer>
        <div class="stats">
  
    <ul class="categories">
      
        
          <li><a class="article-terms-link" href="/categories/ssis-internals/">SSIS internals</a></li>
        
      
    </ul>
  
  
    <ul class="tags">
      
        
          <li><a class="article-terms-link" href="/tags/internals/">internals</a></li>
        
          <li><a class="article-terms-link" href="/tags/isdeploymentwizard/">IsDeploymentWizard</a></li>
        
          <li><a class="article-terms-link" href="/tags/isserverexec/">ISServerExec</a></li>
        
          <li><a class="article-terms-link" href="/tags/ssis/">SSIS</a></li>
        
      
    </ul>
  
</div>

      </footer>
    </div>
    
      <script src="https://utteranc.es/client.js"
        repo="BartekR/bartekr.github.io"
        issue-term="url"
        label="blog-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
    
  </article>
  <div class="pagination">
    
      <a href="/2017/06/11/get-the-passwords-from-ssis-environment-variables/" class="button left"><span>Get the passwords from SSIS Environment variables</span></a>
    
    
      <a href="/2017/04/16/sqlbits-2017/" class="button right"><span>SQLBits 2017</span></a>
    
  </div>

      </main>
      <section id="site-sidebar">
  
    <section id="recent-posts">
      <header>
        <h1>Recent Posts</h1>
      </header>
      
      <article class="mini-post">
          <a href="/2022/10/31/build-your-sql-server-vm-using-cdktf/" class="image" style="--bg-image: url('/2022/10/31/build-your-sql-server-vm-using-cdktf/images/cdktf.help.png');">
    <img src="/2022/10/31/build-your-sql-server-vm-using-cdktf/images/cdktf.help.png" alt="">
  </a>
        <header>
          <h2><a href="/2022/10/31/build-your-sql-server-vm-using-cdktf/">Build your SQL Server VM using CdkTf</a></h2>
          <time class="published" datetime="2022-10-31 00:00:00 &#43;0000 UTC">October 31, 2022</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2021/11/28/end-to-end-testing-with-playwright-part-ii/" class="image" style="--bg-image: url('/2021/11/28/end-to-end-testing-with-playwright-part-ii/images/Header.png');">
    <img src="/2021/11/28/end-to-end-testing-with-playwright-part-ii/images/Header.png" alt="">
  </a>
        <header>
          <h2><a href="/2021/11/28/end-to-end-testing-with-playwright-part-ii/">End-to-End testing with Playwright, part II</a></h2>
          <time class="published" datetime="2021-11-28 00:00:00 &#43;0000 UTC">November 28, 2021</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2021/11/13/end-to-end-testing-with-playwright-part-i/" class="image" style="--bg-image: url('/2021/11/13/end-to-end-testing-with-playwright-part-i/images/Header.png');">
    <img src="/2021/11/13/end-to-end-testing-with-playwright-part-i/images/Header.png" alt="">
  </a>
        <header>
          <h2><a href="/2021/11/13/end-to-end-testing-with-playwright-part-i/">End-to-End testing with Playwright, part I</a></h2>
          <time class="published" datetime="2021-11-13 00:00:00 &#43;0000 UTC">November 13, 2021</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2021/06/13/read-data-from-azure-blob-storage-to-azure-sql-database/" class="image" style="--bg-image: url('/2021/06/13/read-data-from-azure-blob-storage-to-azure-sql-database/images/StorageAccountContent.png');">
    <img src="/2021/06/13/read-data-from-azure-blob-storage-to-azure-sql-database/images/StorageAccountContent.png" alt="">
  </a>
        <header>
          <h2><a href="/2021/06/13/read-data-from-azure-blob-storage-to-azure-sql-database/">Read Data From Azure Blob Storage to Azure SQL Database</a></h2>
          <time class="published" datetime="2021-06-13 00:00:00 &#43;0000 UTC">June 13, 2021</time>
        </header>
      </article>
      
      <article class="mini-post">
          <a href="/2021/02/28/build-yourself-a-web-app-in-azure/" class="image" style="--bg-image: url('/2021/02/28/build-yourself-a-web-app-in-azure/images/basic-web-app.png');">
    <img src="/2021/02/28/build-yourself-a-web-app-in-azure/images/basic-web-app.png" alt="">
  </a>
        <header>
          <h2><a href="/2021/02/28/build-yourself-a-web-app-in-azure/">Build Yourself a Web App in Azure</a></h2>
          <time class="published" datetime="2021-02-28 00:00:00 &#43;0000 UTC">February 28, 2021</time>
        </header>
      </article>
      
      
        <footer>
          <a href="/post/" class="button">See More</a>
        </footer>
      
    </section>
  

  
    

      <section id="categories">
        <header>
          <h1><a href="/categories">Categories</a></h1>
        </header>
        <ul>
          
          
          <li>
              <a href="/categories/learning/">learning<span class="count">17</span></a>
          
          <li>
              <a href="/categories/series/">series<span class="count">13</span></a>
          
          <li>
              <a href="/categories/testing/">testing<span class="count">13</span></a>
          
          <li>
              <a href="/categories/ssis-internals/">ssis-internals<span class="count">5</span></a>
          
          <li>
              <a href="/categories/azure/">azure<span class="count">3</span></a>
          
          <li>
              <a href="/categories/sql-server/">sql-server<span class="count">3</span></a>
          
          <li>
              <a href="/categories/admin/">admin<span class="count">2</span></a>
          
          <li>
              <a href="/categories/internals/">internals<span class="count">2</span></a>
          
          <li>
              <a href="/categories/programming/">programming<span class="count">2</span></a>
          
          <li>
              <a href="/categories/troubleshooting/">troubleshooting<span class="count">2</span></a>
          
          <li>
              <a href="/categories/advent-of-code/">advent-of-code<span class="count">1</span></a>
          
          <li>
              <a href="/categories/conferences/">conferences<span class="count">1</span></a>
          
          <li>
              <a href="/categories/iac/">iac<span class="count">1</span></a>
          
          <li>
              <a href="/categories/not-so-technical/">not-so-technical<span class="count">1</span></a>
          
          <li>
              <a href="/categories/tfs/">tfs<span class="count">1</span></a>
          
          </li>
        </ul>
      </section>
    
  

  
    <section id="mini-bio">
      <header>
        <h1>About</h1>
      </header>
      <p>Posts about SQL Server, SSIS and automation for my future self, but you might find something useful.</p>
      <footer>
        <a href="/about" class="button">Learn More</a>
      </footer>
    </section>
  
</section>

      <footer id="site-footer">
  
      <ul class="socnet-icons">
        

        <li><a href="//github.com/BartekR" target="_blank" rel="noopener" title="GitHub" class="fab fa-github"></a></li>











<li><a href="//www.linkedin.com/in/bartoszratajczyk" target="_blank" rel="noopener" title="LinkedIn" class="fab fa-linkedin"></a></li>















<li><a href="//twitter.com/b_ratajczyk" target="_blank" rel="noopener" title="Twitter" class="fab fa-twitter"></a></li>










<li><a href="//dataplatform.social/@b_ratajczyk" target="_blank" rel="me" title="mastodon" class="fab fa-mastodon"></a></li>


      </ul>
  
  <p class="copyright">
     2022 BartekR
      <br>
    Theme: <a href='https://github.com/pacollins/hugo-future-imperfect-slim' target='_blank' rel='noopener'>Hugo Future Imperfect Slim</a><br>A <a href='https://html5up.net/future-imperfect' target='_blank' rel='noopener'>HTML5 UP port</a> | Powered by <a href='https://gohugo.io/' title='0.84.0' target='_blank' rel='noopener'>Hugo</a>
  </p>
</footer>
<a id="back-to-top" href="#" class="fas fa-arrow-up fa-2x"></a>

      <script src="/js/highlight.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/powershell.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/languages/csharp.min.js"></script>
    <script>hljs.highlightAll();</script><script src="/js/bundle.min.02d767a6e81a96e407433383e9cefe38183bfd6185e7ca9dae8c460dd062e2d7.js" integrity="sha256-AtdnpugaluQHQzOD6c7&#43;OBg7/WGF58qdroxGDdBi4tc="></script>
    <script src="/js/add-on.js"></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-109318393-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

    </div>
  </body>
</html>
